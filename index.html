<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"localhost","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="李宁的博客">
<meta property="og:url" content="http://localhost:4000/index.html">
<meta property="og:site_name" content="李宁的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="李宁">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://localhost:4000/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false
  };
</script>

  <title>李宁的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">李宁的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/07/08/Activiti%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/08/Activiti%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">Activiti入门</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-08 00:00:00" itemprop="dateCreated datePublished" datetime="2021-07-08T00:00:00+08:00">2021-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-15 15:18:00" itemprop="dateModified" datetime="2021-07-15T15:18:00+08:00">2021-07-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Activiti/" itemprop="url" rel="index"><span itemprop="name">Activiti</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->

<ul>
<li><a href="#activiti">Activiti</a><ul>
<li><a href="#bpmn">BPMN</a><ul>
<li><a href="#bpmn20-元素">BPMN2.0 元素</a></li>
</ul>
</li>
<li><a href="#下载配置安装">下载&amp;配置&amp;安装</a></li>
<li><a href="#流程示例">流程示例</a><ul>
<li><a href="#创建用户">创建用户</a></li>
<li><a href="#定义流程">定义流程</a></li>
<li><a href="#创建app">创建APP</a></li>
<li><a href="#发布app">发布APP</a></li>
<li><a href="#使用流程">使用流程</a></li>
<li><a href="#activiti-admin">Activiti-Admin</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#activiti-6-get-start">Activiti 6 Get start</a></li>
<li><a href="#开发">开发</a><ul>
<li><a href="#关键配置">关键配置</a></li>
<li><a href="#流程描述文件">流程描述文件</a></li>
<li><a href="#关键的类和接口">关键的类和接口</a><ul>
<li><a href="#processengineconfiguration">ProcessEngineConfiguration</a></li>
<li><a href="#processengines">ProcessEngines</a></li>
<li><a href="#processengine">ProcessEngine</a></li>
</ul>
</li>
<li><a href="#邮件通知">邮件通知</a></li>
<li><a href="#activiti-的命令拦截器">Activiti 的命令拦截器</a><ul>
<li><a href="#activiti-数据查询">Activiti 数据查询</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#spring-boot-集成">Spring Boot 集成</a><ul>
<li><a href="#取消activiti-api-security-验证">取消Activiti api security 验证</a></li>
<li><a href="#取消activiti7-集成swagger">取消Activiti7 集成swagger</a></li>
<li><a href="#activiti-数据表解释">Activiti 数据表解释</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

<hr>
<h2><span id="activiti">Activiti</span></h2><p>Activiti是一个开源的BPMN引擎。</p>
<p><a href="https://www.activiti.org/" target="_blank" rel="noopener">https://www.activiti.org/</a></p>
<h3><span id="bpmn">BPMN</span></h3><hr>
<p>Business Process Model and Notation - 业务流程建模与标注，BPMN规范是由标准组织BPMI发布，主要目标就是要提供被所有业务用户理解的一套标记语言，定义业务流程设计与流程实现。</p>
<p><a href="https://www.bpmn.org/" target="_blank" rel="noopener">https://www.bpmn.org/</a></p>
<h4><span id="bpmn20-元素">BPMN2.0 元素</span></h4><p>流对象（Flow Objects）：在一个业务流程中，流对象是用于定义行为的图形元素，主要有事件（Events）、活动（Activities）和网关（Gateways）三种流对象。</p>
<p>事件（Events）</p>
<p>用于描述流程中发生的事件， 事件会对流程产生影响，事件 会被触发或者会产生结果。 圆圈</p>
<p>活动（Activities）</p>
<p>活动是工作流中一个通用的术 语，活动包括任务（Task）和 子流程（Sub-Process）。正方形</p>
<p>网关（Gateways）</p>
<p>网关主要用于控制流程中的顺 序流的走向，使用网关可以控 制流程进行分支与合并。 菱形</p>
<p>连接对象（Connecting Objects）：用于连接流对象，主要有 4 种连接流对象的方 式，包括顺序流（Sequence Flows）、消息流（Message Flows）、关联（Associations） 和数据关联（Data Associations）。</p>
<p>顺序流（Sequence Flow）</p>
<p>顺序流显示流程将会执行哪个 活动。实线实心箭头</p>
<p>消息流（Message Flows）</p>
<p>消息流主要用于显示消息在流 程参与者之间的传递情况。虚线空心箭头</p>
<p>关联（Association）</p>
<p>主要用于连接流程元素及其制 品（流程信息）。</p>
<h3><span id="下载amp配置amp安装">下载&amp;配置&amp;安装</span></h3><hr>
<p>Activiti目前又7.x，6.x，5.x三个大版本，这里以6.x为例。</p>
<p><a href="http://activiti.org/download.html" target="_blank" rel="noopener">http://activiti.org/download.html</a></p>
<p><a href="https://github.com/Activiti/Activiti/releases/download/activiti-6.0.0/activiti-6.0.0.zip" target="_blank" rel="noopener">https://github.com/Activiti/Activiti/releases/download/activiti-6.0.0/activiti-6.0.0.zip</a></p>
<p>前置条件</p>
<p>JDK安装（至少JDK7）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf jdk-8u221-linux-x64.tar.gz</span><br><span class="line"></span><br><span class="line">unzip jce_policy-8.zip</span><br><span class="line"></span><br><span class="line">cp UnlimitedJCEPolicyJDK8&#x2F;*.jar &#x2F;home&#x2F;lining&#x2F;jdk1.8.0_221&#x2F;jre&#x2F;lib&#x2F;security&#x2F;policy&#x2F;limited&#x2F;</span><br><span class="line"></span><br><span class="line">vi &#x2F;etc&#x2F;profile</span><br><span class="line">export JAVA_HOME&#x3D;&#x2F;home&#x2F;lining&#x2F;jdk1.8.0_221</span><br><span class="line">export PATH&#x3D;$PATH:$JAVA_HOME&#x2F;bin</span><br><span class="line"></span><br><span class="line">source &#x2F;etc&#x2F;profile</span><br></pre></td></tr></table></figure>

<p>MySQL安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sudo yum localinstall mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line"></span><br><span class="line">sudo yum-config-manager --disable mysql80-community</span><br><span class="line">sudo yum-config-manager --enable mysql57-community</span><br><span class="line"></span><br><span class="line">yum repolist all | grep mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo yum install mysql-community-server</span><br><span class="line"> </span><br><span class="line">sudo systemctl start mysqld</span><br><span class="line">sudo systemctl status mysqld</span><br><span class="line">sudo systemctl enable mysqld</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo grep &#39;temporary password&#39; &#x2F;var&#x2F;log&#x2F;mysqld.log</span><br><span class="line"></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;DataFusion@2021&#39;;</span><br><span class="line"></span><br><span class="line">use mysql;</span><br><span class="line"></span><br><span class="line">update user set host &#x3D; &#39;%&#39; where user &#x3D; &#39;root&#39;;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql -uroot -pDataFusion@2021 -h192.168.67.3 -P3306</span><br></pre></td></tr></table></figure>

<p>Tomcat安装</p>
<p><a href="https://tomcat.apache.org/download-80.cgi" target="_blank" rel="noopener">https://tomcat.apache.org/download-80.cgi</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf apache-tomcat-8.5.69.tar.gz</span><br><span class="line">&#x2F;home&#x2F;lining&#x2F;apache-tomcat-8.5.69</span><br></pre></td></tr></table></figure>

<p>解压复制Activiti WAR包到Tomcat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unzip activiti-6.0.0.zip</span><br><span class="line">ll &#x2F;home&#x2F;lining&#x2F;activiti-6.0.0&#x2F;wars</span><br><span class="line">cp *.war &#x2F;home&#x2F;lining&#x2F;apache-tomcat-8.5.69&#x2F;webapps&#x2F;</span><br></pre></td></tr></table></figure>











<p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;lining&#x2F;apache-tomcat-8.5.69</span><br><span class="line">bin&#x2F;startup.sh</span><br></pre></td></tr></table></figure>

<p>访问</p>
<p><a href="http://192.168.67.3:8080/activiti-app/" target="_blank" rel="noopener">http://192.168.67.3:8080/activiti-app/</a></p>
<p>默认用户名密码admin/test</p>
<h3><span id="流程示例">流程示例</span></h3><hr>
<p>主界面的三个菜单主要承担以下功能： </p>
<p> Kickstart App：主要用于流程模型管理、表单管理及应用（App）管理，一个应用 </p>
<p>可以包含多个流程模型，应用可发布给其他用户使用。 </p>
<p> Task App：用于管理整个 activiti-app 的任务，在该功能里面也可以启动流程。 </p>
<p> Idenity management：身份信息管理，可以管理用户、用户组等数据。</p>
<h4><span id="创建用户">创建用户</span></h4><p>Idenity management - Users - Create User</p>
<p>lining</p>
<p>manager</p>
<h4><span id="定义流程">定义流程</span></h4><p>Kickstart App - Create Process</p>
<p>编辑定义流程的ID  和Name  注意不能又特殊字符（数字  特殊符号开头那种）</p>
<p>指定流程的Assignment(使用Last Name搜索)</p>
<p>导出流程文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span> <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span> <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span> <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/processdef"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"AskForLeave"</span> <span class="attr">name</span>=<span class="string">"AskForLeave"</span> <span class="attr">isExecutable</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">documentation</span>&gt;</span>AskForLeave<span class="tag">&lt;/<span class="name">documentation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"AskForLeave_0"</span> <span class="attr">name</span>=<span class="string">"开始"</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"AskForLeave_1"</span> <span class="attr">name</span>=<span class="string">"请假"</span> <span class="attr">activiti:candidateUsers</span>=<span class="string">"admin"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:user-info-email-admin</span> <span class="attr">xmlns:modeler</span>=<span class="string">"http://activiti.com/modeler"</span>&gt;</span>&lt;![CDATA[admin]]&gt;<span class="tag">&lt;/<span class="name">modeler:user-info-email-admin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:user-info-lastname-admin</span> <span class="attr">xmlns:modeler</span>=<span class="string">"http://activiti.com/modeler"</span>&gt;</span>&lt;![CDATA[Administrator]]&gt;<span class="tag">&lt;/<span class="name">modeler:user-info-lastname-admin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:activiti-idm-candidate-user</span> <span class="attr">xmlns:modeler</span>=<span class="string">"http://activiti.com/modeler"</span>&gt;</span>&lt;![CDATA[true]]&gt;<span class="tag">&lt;/<span class="name">modeler:activiti-idm-candidate-user</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">"http://activiti.com/modeler"</span>&gt;</span>&lt;![CDATA[false]]&gt;<span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"sid-E4B54E48-FB14-4049-A8FE-B33261253272"</span> <span class="attr">sourceRef</span>=<span class="string">"AskForLeave_0"</span> <span class="attr">targetRef</span>=<span class="string">"AskForLeave_1"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"AskForLeave_2"</span> <span class="attr">name</span>=<span class="string">"审批"</span> <span class="attr">activiti:candidateUsers</span>=<span class="string">"admin"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:user-info-email-admin</span> <span class="attr">xmlns:modeler</span>=<span class="string">"http://activiti.com/modeler"</span>&gt;</span>&lt;![CDATA[admin]]&gt;<span class="tag">&lt;/<span class="name">modeler:user-info-email-admin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:user-info-lastname-admin</span> <span class="attr">xmlns:modeler</span>=<span class="string">"http://activiti.com/modeler"</span>&gt;</span>&lt;![CDATA[Administrator]]&gt;<span class="tag">&lt;/<span class="name">modeler:user-info-lastname-admin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:activiti-idm-candidate-user</span> <span class="attr">xmlns:modeler</span>=<span class="string">"http://activiti.com/modeler"</span>&gt;</span>&lt;![CDATA[true]]&gt;<span class="tag">&lt;/<span class="name">modeler:activiti-idm-candidate-user</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">"http://activiti.com/modeler"</span>&gt;</span>&lt;![CDATA[false]]&gt;<span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"sid-310013B3-DEA7-4402-B0BA-B0BFBE5ABB4A"</span> <span class="attr">sourceRef</span>=<span class="string">"AskForLeave_1"</span> <span class="attr">targetRef</span>=<span class="string">"AskForLeave_2"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"AskForLeave_3"</span> <span class="attr">name</span>=<span class="string">"结束"</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"sid-ECFB27CD-BA9E-4B51-9864-BB6B068B1523"</span> <span class="attr">sourceRef</span>=<span class="string">"AskForLeave_2"</span> <span class="attr">targetRef</span>=<span class="string">"AskForLeave_3"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bpmndi:BPMNDiagram</span> <span class="attr">id</span>=<span class="string">"BPMNDiagram_AskForLeave"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bpmndi:BPMNPlane</span> <span class="attr">bpmnElement</span>=<span class="string">"AskForLeave"</span> <span class="attr">id</span>=<span class="string">"BPMNPlane_AskForLeave"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"AskForLeave_0"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_AskForLeave_0"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"30.0"</span> <span class="attr">width</span>=<span class="string">"30.0"</span> <span class="attr">x</span>=<span class="string">"90.0"</span> <span class="attr">y</span>=<span class="string">"150.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"AskForLeave_1"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_AskForLeave_1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"80.0"</span> <span class="attr">width</span>=<span class="string">"100.0"</span> <span class="attr">x</span>=<span class="string">"165.0"</span> <span class="attr">y</span>=<span class="string">"125.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"AskForLeave_2"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_AskForLeave_2"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"80.0"</span> <span class="attr">width</span>=<span class="string">"100.0"</span> <span class="attr">x</span>=<span class="string">"310.0"</span> <span class="attr">y</span>=<span class="string">"125.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"AskForLeave_3"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_AskForLeave_3"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"28.0"</span> <span class="attr">width</span>=<span class="string">"28.0"</span> <span class="attr">x</span>=<span class="string">"455.0"</span> <span class="attr">y</span>=<span class="string">"151.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"sid-E4B54E48-FB14-4049-A8FE-B33261253272"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_sid-E4B54E48-FB14-4049-A8FE-B33261253272"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"120.0"</span> <span class="attr">y</span>=<span class="string">"165.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"165.0"</span> <span class="attr">y</span>=<span class="string">"165.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"sid-310013B3-DEA7-4402-B0BA-B0BFBE5ABB4A"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_sid-310013B3-DEA7-4402-B0BA-B0BFBE5ABB4A"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"265.0"</span> <span class="attr">y</span>=<span class="string">"165.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"310.0"</span> <span class="attr">y</span>=<span class="string">"165.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"sid-ECFB27CD-BA9E-4B51-9864-BB6B068B1523"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_sid-ECFB27CD-BA9E-4B51-9864-BB6B068B1523"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"410.0"</span> <span class="attr">y</span>=<span class="string">"165.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"455.0"</span> <span class="attr">y</span>=<span class="string">"165.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bpmndi:BPMNPlane</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bpmndi:BPMNDiagram</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure>







<h4><span id="创建app">创建APP</span></h4><p>Kickstart App - Apps - Create App</p>
<p>回到APP主页-为APP设置流程-修改-Edit included models添加流程保存-发布</p>
<h4><span id="发布app">发布APP</span></h4><p>点击APP - Publish</p>
<p>流程错误回导致发布失败</p>
<h4><span id="使用流程">使用流程</span></h4><p>使用lining/lining登录系统（可以使用管理员修改密码）</p>
<p>点击APP - Process - start process</p>
<p>使用manager/manager登录系统（可以使用管理员修改密码）</p>
<h4><span id="activiti-admin">Activiti-Admin</span></h4><p><a href="http://192.168.67.3:8080/activiti-admin" target="_blank" rel="noopener">http://192.168.67.3:8080/activiti-admin</a></p>
<p>admin/admin</p>
<p>Configuration 配置服务器地址  <a href="http://192.168.67.3" target="_blank" rel="noopener">http://192.168.67.3</a>    8080</p>
<h2><span id="activiti-6-get-start">Activiti 6 Get start</span></h2><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$quickStartJavaProjectName<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>$quickStartJavaProjectName<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- ... other configurations may exist, such as a build stanza, depending your environment ... --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$actVer<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.193<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- get all project dependencies --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- MainClass in mainfest make a executable jar --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.example.OnboardingRequest<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- bind to the packaging phase --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>log4j.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log4j.rootLogger&#x3D;DEBUG, ACT</span><br><span class="line"></span><br><span class="line">log4j.appender.ACT&#x3D;org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.ACT.layout&#x3D;org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.ACT.layout.ConversionPattern&#x3D; %d&#123;hh:mm:ss,SSS&#125; [%t] %-5p %c %x - %m%n</span><br></pre></td></tr></table></figure>

<p><strong>src/main/java/com/example/OnboardingRequest.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.DateFormat;</span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.FormService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.HistoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngine;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngineConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RepositoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RuntimeService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.TaskService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.form.FormData;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.form.FormProperty;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.history.HistoricActivityInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.impl.form.DateFormType;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.impl.form.LongFormType;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.impl.form.StringFormType;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.Deployment;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.ProcessDefinition;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.runtime.ProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.task.Task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnboardingRequest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">    ProcessEngineConfiguration cfg = <span class="keyword">new</span> StandaloneProcessEngineConfiguration()</span><br><span class="line">        .setJdbcUrl(<span class="string">"jdbc:h2:mem:activiti;DB_CLOSE_DELAY=1000"</span>)</span><br><span class="line">        .setJdbcUsername(<span class="string">"sa"</span>)</span><br><span class="line">        .setJdbcPassword(<span class="string">""</span>)</span><br><span class="line">        .setJdbcDriver(<span class="string">"org.h2.Driver"</span>)</span><br><span class="line">        .setDatabaseSchemaUpdate(ProcessEngineConfiguration.DB_SCHEMA_UPDATE_TRUE);</span><br><span class="line">    ProcessEngine processEngine = cfg.buildProcessEngine();</span><br><span class="line">    String pName = processEngine.getName();</span><br><span class="line">    String ver = ProcessEngine.VERSION;</span><br><span class="line">    System.out.println(<span class="string">"ProcessEngine ["</span> + pName + <span class="string">"] Version: ["</span> + ver + <span class="string">"]"</span>);</span><br><span class="line"></span><br><span class="line">    RepositoryService repositoryService = processEngine.getRepositoryService();</span><br><span class="line">    Deployment deployment = repositoryService.createDeployment()</span><br><span class="line">        .addClasspathResource(<span class="string">"onboarding.bpmn20.xml"</span>).deploy();</span><br><span class="line">    ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery()</span><br><span class="line">        .deploymentId(deployment.getId()).singleResult();</span><br><span class="line">    System.out.println(</span><br><span class="line">        <span class="string">"Found process definition ["</span> </span><br><span class="line">            + processDefinition.getName() + <span class="string">"] with id ["</span> </span><br><span class="line">            + processDefinition.getId() + <span class="string">"]"</span>);</span><br><span class="line">  </span><br><span class="line">    RuntimeService runtimeService = processEngine.getRuntimeService();</span><br><span class="line">    ProcessInstance processInstance = runtimeService</span><br><span class="line">        .startProcessInstanceByKey(<span class="string">"onboarding"</span>);</span><br><span class="line">    System.out.println(<span class="string">"Onboarding process started with process instance id ["</span> </span><br><span class="line">        + processInstance.getProcessInstanceId()</span><br><span class="line">        + <span class="string">"] key ["</span> + processInstance.getProcessDefinitionKey() + <span class="string">"]"</span>);</span><br><span class="line">    </span><br><span class="line">    TaskService taskService = processEngine.getTaskService();</span><br><span class="line">    FormService formService = processEngine.getFormService();</span><br><span class="line">    HistoryService historyService = processEngine.getHistoryService();</span><br><span class="line"></span><br><span class="line">    Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">    <span class="keyword">while</span> (processInstance != <span class="keyword">null</span> &amp;&amp; !processInstance.isEnded()) &#123;</span><br><span class="line">      List&lt;Task&gt; tasks = taskService.createTaskQuery()</span><br><span class="line">          .taskCandidateGroup(<span class="string">"managers"</span>).list();</span><br><span class="line">      System.out.println(<span class="string">"Active outstanding tasks: ["</span> + tasks.size() + <span class="string">"]"</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tasks.size(); i++) &#123;</span><br><span class="line">        Task task = tasks.get(i);</span><br><span class="line">        System.out.println(<span class="string">"Processing Task ["</span> + task.getName() + <span class="string">"]"</span>);</span><br><span class="line">        Map&lt;String, Object&gt; variables = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        FormData formData = formService.getTaskFormData(task.getId());</span><br><span class="line">        <span class="keyword">for</span> (FormProperty formProperty : formData.getFormProperties()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (StringFormType<span class="class">.<span class="keyword">class</span>.<span class="title">isInstance</span>(<span class="title">formProperty</span>.<span class="title">getType</span>())) </span>&#123;</span><br><span class="line">            System.out.println(formProperty.getName() + <span class="string">"?"</span>);</span><br><span class="line">            String value = scanner.nextLine();</span><br><span class="line">            variables.put(formProperty.getId(), value);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LongFormType<span class="class">.<span class="keyword">class</span>.<span class="title">isInstance</span>(<span class="title">formProperty</span>.<span class="title">getType</span>())) </span>&#123;</span><br><span class="line">            System.out.println(formProperty.getName() + <span class="string">"? (Must be a whole number)"</span>);</span><br><span class="line">            Long value = Long.valueOf(scanner.nextLine());</span><br><span class="line">            variables.put(formProperty.getId(), value);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DateFormType<span class="class">.<span class="keyword">class</span>.<span class="title">isInstance</span>(<span class="title">formProperty</span>.<span class="title">getType</span>())) </span>&#123;</span><br><span class="line">            System.out.println(formProperty.getName() + <span class="string">"? (Must be a date m/d/yy)"</span>);</span><br><span class="line">            DateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"m/d/yy"</span>);</span><br><span class="line">            Date value = dateFormat.parse(scanner.nextLine());</span><br><span class="line">            variables.put(formProperty.getId(), value);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"&lt;form type not supported&gt;"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        taskService.complete(task.getId(), variables);</span><br><span class="line"></span><br><span class="line">        HistoricActivityInstance endActivity = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;HistoricActivityInstance&gt; activities = </span><br><span class="line">            historyService.createHistoricActivityInstanceQuery()</span><br><span class="line">            .processInstanceId(processInstance.getId()).finished()</span><br><span class="line">            .orderByHistoricActivityInstanceEndTime().asc()</span><br><span class="line">            .list();</span><br><span class="line">        <span class="keyword">for</span> (HistoricActivityInstance activity : activities) &#123;</span><br><span class="line">          <span class="keyword">if</span> (activity.getActivityType() == <span class="string">"startEvent"</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"BEGIN "</span> + processDefinition.getName() </span><br><span class="line">                + <span class="string">" ["</span> + processInstance.getProcessDefinitionKey()</span><br><span class="line">                + <span class="string">"] "</span> + activity.getStartTime());</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (activity.getActivityType() == <span class="string">"endEvent"</span>) &#123;</span><br><span class="line">            <span class="comment">// Handle edge case where end step happens so fast that the end step</span></span><br><span class="line">            <span class="comment">// and previous step(s) are sorted the same. So, cache the end step </span></span><br><span class="line">            <span class="comment">//and display it last to represent the logical sequence.</span></span><br><span class="line">            endActivity = activity;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"-- "</span> + activity.getActivityName() </span><br><span class="line">                + <span class="string">" ["</span> + activity.getActivityId() + <span class="string">"] "</span></span><br><span class="line">                + activity.getDurationInMillis() + <span class="string">" ms"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (endActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">          System.out.println(<span class="string">"-- "</span> + endActivity.getActivityName() </span><br><span class="line">                + <span class="string">" ["</span> + endActivity.getActivityId() + <span class="string">"] "</span></span><br><span class="line">                + endActivity.getDurationInMillis() + <span class="string">" ms"</span>);</span><br><span class="line">          System.out.println(<span class="string">"COMPLETE "</span> + processDefinition.getName() + <span class="string">" ["</span></span><br><span class="line">                + processInstance.getProcessDefinitionKey() + <span class="string">"] "</span> </span><br><span class="line">                + endActivity.getEndTime());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Re-query the process instance, making sure the latest state is available</span></span><br><span class="line">      processInstance = runtimeService.createProcessInstanceQuery()</span><br><span class="line">          .processInstanceId(processInstance.getId()).singleResult();</span><br><span class="line">    &#125;</span><br><span class="line">    scanner.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src/main/java/com/example/AutomatedDataDelegate.java</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package com.example;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">import org.activiti.engine.delegate.DelegateExecution;</span><br><span class="line">import org.activiti.engine.delegate.JavaDelegate;</span><br><span class="line"></span><br><span class="line">public class AutomatedDataDelegate implements JavaDelegate &#123;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void execute(DelegateExecution execution) throws Exception &#123;</span><br><span class="line">    Date now &#x3D; new Date();</span><br><span class="line">    execution.setVariable(&quot;autoWelcomeTime&quot;, now);</span><br><span class="line">    System.out.println(&quot;Faux call to backend for [&quot; </span><br><span class="line">    + execution.getVariable(&quot;fullName&quot;) + &quot;]&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src/main/resources/onboarding.bpmn20.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span> <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span> <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span> <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/processdef"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"onboarding"</span> <span class="attr">name</span>=<span class="string">"Onboarding"</span> <span class="attr">isExecutable</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"startOnboarding"</span> <span class="attr">name</span>=<span class="string">"Start"</span> <span class="attr">activiti:initiator</span>=<span class="string">"initiator"</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"enterOnboardingData"</span> <span class="attr">name</span>=<span class="string">"Enter Data"</span> <span class="attr">activiti:assignee</span>=<span class="string">"$&#123;initiator&#125;"</span> <span class="attr">activiti:candidateGroups</span>=<span class="string">"managers"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activiti:formProperty</span> <span class="attr">id</span>=<span class="string">"fullName"</span> <span class="attr">name</span>=<span class="string">"Full Name"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span><span class="tag">&lt;/<span class="name">activiti:formProperty</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activiti:formProperty</span> <span class="attr">id</span>=<span class="string">"yearsOfExperience"</span> <span class="attr">name</span>=<span class="string">"Years of Experience"</span> <span class="attr">type</span>=<span class="string">"long"</span> <span class="attr">required</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">activiti:formProperty</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scriptTask</span> <span class="attr">id</span>=<span class="string">"automatedIntro"</span> <span class="attr">name</span>=<span class="string">"Generic and Automated Data Entry"</span> <span class="attr">scriptFormat</span>=<span class="string">"javascript"</span> <span class="attr">activiti:autoStoreVariables</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">&lt;![CDATA[<span class="keyword">var</span> dateAsString = <span class="keyword">new</span> <span class="built_in">Date</span>().toString();</span></span><br><span class="line"><span class="actionscript">execution.setVariable(<span class="string">"autoWelcomeTime"</span>, dateAsString);]]&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scriptTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"sid-1337EA98-7364-4198-B5D9-30F5341D6918"</span> <span class="attr">sourceRef</span>=<span class="string">"startOnboarding"</span> <span class="attr">targetRef</span>=<span class="string">"enterOnboardingData"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusiveGateway</span> <span class="attr">id</span>=<span class="string">"decision"</span> <span class="attr">name</span>=<span class="string">"Years of Experience"</span> <span class="attr">default</span>=<span class="string">"automatedIntroPath"</span>&gt;</span><span class="tag">&lt;/<span class="name">exclusiveGateway</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"sid-42BE5661-C3D5-4DE6-96F5-73D34822727A"</span> <span class="attr">sourceRef</span>=<span class="string">"enterOnboardingData"</span> <span class="attr">targetRef</span>=<span class="string">"decision"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"personalizedIntro"</span> <span class="attr">name</span>=<span class="string">"Personalized Introduction and Data Entry"</span> <span class="attr">activiti:assignee</span>=<span class="string">"$&#123;initiator&#125;"</span> <span class="attr">activiti:candidateGroups</span>=<span class="string">"managers"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activiti:formProperty</span> <span class="attr">id</span>=<span class="string">"personalWelcomeTime"</span> <span class="attr">name</span>=<span class="string">"Personal Welcome Time"</span> <span class="attr">type</span>=<span class="string">"date"</span> <span class="attr">datePattern</span>=<span class="string">"MM-dd-yyyy hh:mm"</span>&gt;</span><span class="tag">&lt;/<span class="name">activiti:formProperty</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"endOnboarding"</span> <span class="attr">name</span>=<span class="string">"End"</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"sid-37A73ACA-2E23-400B-96F3-71F77738DAFA"</span> <span class="attr">sourceRef</span>=<span class="string">"automatedIntro"</span> <span class="attr">targetRef</span>=<span class="string">"endOnboarding"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scriptTask</span> <span class="attr">id</span>=<span class="string">"automatedIntro"</span> <span class="attr">name</span>=<span class="string">"Generic and Automated Data Entry"</span> <span class="attr">scriptFormat</span>=<span class="string">"javascript"</span> <span class="attr">activiti:autoStoreVariables</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">&lt;![CDATA[<span class="keyword">var</span> dateAsString = <span class="keyword">new</span> <span class="built_in">Date</span>().toString();</span></span><br><span class="line"><span class="actionscript">execution.setVariable(<span class="string">"autoWelcomeTime"</span>, dateAsString);]]&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scriptTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"automatedIntroPath"</span> <span class="attr">sourceRef</span>=<span class="string">"decision"</span> <span class="attr">targetRef</span>=<span class="string">"automatedIntro"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"personalizedIntroPath"</span> <span class="attr">name</span>=<span class="string">"<span class="symbol">&amp;gt;</span>3"</span> <span class="attr">sourceRef</span>=<span class="string">"decision"</span> <span class="attr">targetRef</span>=<span class="string">"personalizedIntro"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">conditionExpression</span> <span class="attr">xsi:type</span>=<span class="string">"tFormalExpression"</span>&gt;</span>&lt;![CDATA[$&#123;yearsOfExperience &gt; 3&#125;]]&gt;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"sid-BA6F061B-47B6-428B-8CE6-739244B14BD6"</span> <span class="attr">sourceRef</span>=<span class="string">"personalizedIntro"</span> <span class="attr">targetRef</span>=<span class="string">"endOnboarding"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bpmndi:BPMNDiagram</span> <span class="attr">id</span>=<span class="string">"BPMNDiagram_onboarding"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bpmndi:BPMNPlane</span> <span class="attr">bpmnElement</span>=<span class="string">"onboarding"</span> <span class="attr">id</span>=<span class="string">"BPMNPlane_onboarding"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"startOnboarding"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_startOnboarding"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"30.0"</span> <span class="attr">width</span>=<span class="string">"30.0"</span> <span class="attr">x</span>=<span class="string">"155.0"</span> <span class="attr">y</span>=<span class="string">"145.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"enterOnboardingData"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_enterOnboardingData"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"80.0"</span> <span class="attr">width</span>=<span class="string">"100.0"</span> <span class="attr">x</span>=<span class="string">"240.0"</span> <span class="attr">y</span>=<span class="string">"120.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"decision"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_decision"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"40.0"</span> <span class="attr">width</span>=<span class="string">"40.0"</span> <span class="attr">x</span>=<span class="string">"385.0"</span> <span class="attr">y</span>=<span class="string">"140.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"personalizedIntro"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_personalizedIntro"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"80.0"</span> <span class="attr">width</span>=<span class="string">"100.0"</span> <span class="attr">x</span>=<span class="string">"519.0"</span> <span class="attr">y</span>=<span class="string">"15.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"endOnboarding"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_endOnboarding"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"28.0"</span> <span class="attr">width</span>=<span class="string">"28.0"</span> <span class="attr">x</span>=<span class="string">"725.0"</span> <span class="attr">y</span>=<span class="string">"165.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"automatedIntro"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_automatedIntro"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"80.0"</span> <span class="attr">width</span>=<span class="string">"100.0"</span> <span class="attr">x</span>=<span class="string">"520.0"</span> <span class="attr">y</span>=<span class="string">"255.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"sid-37A73ACA-2E23-400B-96F3-71F77738DAFA"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_sid-37A73ACA-2E23-400B-96F3-71F77738DAFA"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"570.0"</span> <span class="attr">y</span>=<span class="string">"255.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"570.0"</span> <span class="attr">y</span>=<span class="string">"179.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"725.0"</span> <span class="attr">y</span>=<span class="string">"179.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"sid-1337EA98-7364-4198-B5D9-30F5341D6918"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_sid-1337EA98-7364-4198-B5D9-30F5341D6918"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"185.0"</span> <span class="attr">y</span>=<span class="string">"160.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"240.0"</span> <span class="attr">y</span>=<span class="string">"160.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"automatedIntroPath"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_automatedIntroPath"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"405.0"</span> <span class="attr">y</span>=<span class="string">"180.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"405.0"</span> <span class="attr">y</span>=<span class="string">"295.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"520.0"</span> <span class="attr">y</span>=<span class="string">"295.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"personalizedIntroPath"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_personalizedIntroPath"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"405.0"</span> <span class="attr">y</span>=<span class="string">"140.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"405.0"</span> <span class="attr">y</span>=<span class="string">"55.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"519.0"</span> <span class="attr">y</span>=<span class="string">"55.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"sid-42BE5661-C3D5-4DE6-96F5-73D34822727A"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_sid-42BE5661-C3D5-4DE6-96F5-73D34822727A"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"340.0"</span> <span class="attr">y</span>=<span class="string">"160.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"385.0"</span> <span class="attr">y</span>=<span class="string">"160.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"sid-BA6F061B-47B6-428B-8CE6-739244B14BD6"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_sid-BA6F061B-47B6-428B-8CE6-739244B14BD6"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"619.0"</span> <span class="attr">y</span>=<span class="string">"55.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"739.0"</span> <span class="attr">y</span>=<span class="string">"55.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"739.0"</span> <span class="attr">y</span>=<span class="string">"165.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bpmndi:BPMNPlane</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bpmndi:BPMNDiagram</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure>







<h2><span id="开发">开发</span></h2><h3><span id="关键配置">关键配置</span></h3><hr>
<p>Activiti 在启动时，会读取数据源配置，用于对数据库进行相应的操作。</p>
<p>activiti.cfg.xml</p>
<p>如果没有指定 Activiti 的配置文件，那么默认情况下将会到 CLASSPATH 下读取 activiti.cfg.xml 文件作为 Activit 的配置文件，该文件主要用于配置 Activiti 的数据库连接等属性</p>
<p>示例</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span> <span class="comment">&lt;!-- 流程引擎配置的 bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"</span>&gt;</span> <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/act"</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcDriver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUsername"</span> <span class="attr">value</span>=<span class="string">"root"</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcPassword"</span> <span class="attr">value</span>=<span class="string">"123456"</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"databaseSchemaUpdate"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用 DBCP 数据源 --&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/act"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"123456"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取 dbcp-config.xml 配置 </span></span><br><span class="line">ProcessEngineConfiguration config = ProcessEngineConfiguration .createProcessEngineConfigurationFromResource(<span class="string">"dbcp-config.xml"</span>); </span><br><span class="line"><span class="comment">// 能正常输出，即完成配置 </span></span><br><span class="line">DataSource ds = config.getDataSource(); </span><br><span class="line"><span class="comment">// 查询数据库元信息，如果能查询则表示连接成功 </span></span><br><span class="line">ds.getConnection().getMetaData(); </span><br><span class="line"><span class="comment">// 结果为 org.apache.commons.dbcp.BasicDataSource </span></span><br><span class="line">System.out.println(ds.getClass().getName());</span><br></pre></td></tr></table></figure>





<p>databaseSchemaUpdate配置项可以设置流程引擎启动和关闭时数据库执行的策略。 databaseSchemaUpdate有以下四个值：</p>
<ul>
<li>false：false为默认值，设置为该值后，Activiti在启动时，会对比数据库表中保存的版本，如果没有表或者版本不匹配时，将在启动时抛出异常。</li>
<li>true：设置为该值后，Activiti会对数据库中所有的表进行更新，如果表不存在，则Activiti会自动创建。</li>
<li>create-drop：Activiti启动时，会执行数据库表的创建操作，在Activiti关闭时，执行数据库表的删除操作。</li>
<li>drop-create：Activiti启动时，执行数据库表的删除操作在Activiti关闭时，会执行数据库表的创建操作。</li>
</ul>
<p>history-level对于历史数据，保存到何种粒度，Activiti提供了history-level属性对其进行配置。history-level属性有点像log4j的日志输出级别，该属性有以下四个值：</p>
<ul>
<li>none：不保存任何的历史数据，因此，在流程执行过程中，这是最高效的。</li>
<li>activity：级别高于none，保存流程实例与流程行为，其他数据不保存。</li>
<li>audit：除activity级别会保存的数据外，还会保存全部的流程任务及其属性。audit为history的默认值。</li>
<li>full：保存历史数据的最高级别，除了会保存audit级别的数据外，还会保存其他全部流程相关的细节数据，包括一些流程参数等。</li>
</ul>
<p>db-history-used为true表示使用历史表，如果不配置，则工程启动后可以检查数据库，只建立了17张表，历史表没有建立，则流程图及运行节点无法展示</p>
<h3><span id="流程描述文件">流程描述文件</span></h3><hr>
<p>resource\bpmn\First.bpmn</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> <span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span> <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span> <span class="attr">xmlns:omgdc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span> <span class="attr">xmlns:omgdi</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.activiti.org/test"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"process1"</span> <span class="attr">name</span>=<span class="string">"process1"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"startevent1"</span> <span class="attr">name</span>=<span class="string">"Start"</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"usertask1"</span> <span class="attr">name</span>=<span class="string">"Expense Request"</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"usertask3"</span> <span class="attr">name</span>=<span class="string">"Handle Request"</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"endevent1"</span> <span class="attr">name</span>=<span class="string">"End"</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow1"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">sourceRef</span>=<span class="string">"startevent1"</span> <span class="attr">targetRef</span>=<span class="string">"usertask1"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow2"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">sourceRef</span>=<span class="string">"usertask1"</span> <span class="attr">targetRef</span>=<span class="string">"usertask3"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"flow3"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">sourceRef</span>=<span class="string">"usertask3"</span> <span class="attr">targetRef</span>=<span class="string">"endevent1"</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">process</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">bpmndi:BPMNDiagram</span> <span class="attr">id</span>=<span class="string">"BPMNDiagram_process1"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">bpmndi:BPMNPlane</span> <span class="attr">bpmnElement</span>=<span class="string">"process1"</span> <span class="attr">id</span>=<span class="string">"BPMNPlane_process1"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"startevent1"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_startevent1"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"35"</span> <span class="attr">width</span>=<span class="string">"35"</span> <span class="attr">x</span>=<span class="string">"150"</span> <span class="attr">y</span>=<span class="string">"190"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span> <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"usertask1"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_usertask1"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"55"</span> <span class="attr">width</span>=<span class="string">"105"</span> <span class="attr">x</span>=<span class="string">"230"</span> <span class="attr">y</span>=<span class="string">"180"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span> <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"usertask3"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_usertask3"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"55"</span> <span class="attr">width</span>=<span class="string">"105"</span> <span class="attr">x</span>=<span class="string">"380"</span> <span class="attr">y</span>=<span class="string">"180"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span> 本 <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span> <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"endevent1"</span> <span class="attr">id</span>=<span class="string">"BPMNShape_endevent1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">"35"</span> <span class="attr">width</span>=<span class="string">"35"</span> <span class="attr">x</span>=<span class="string">"530"</span> <span class="attr">y</span>=<span class="string">"190"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span> <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"flow1"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_flow1"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"185"</span> <span class="attr">y</span>=<span class="string">"207"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span> <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"230"</span> <span class="attr">y</span>=<span class="string">"207"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span> <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span> <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"flow2"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_flow2"</span>&gt;</span> <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"335"</span> <span class="attr">y</span>=<span class="string">"207"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span> <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"380"</span> <span class="attr">y</span>=<span class="string">"207"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span> <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span> <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"flow3"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge_flow3"</span>&gt;</span> <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"485"</span> <span class="attr">y</span>=<span class="string">"207"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span> <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">"530"</span> <span class="attr">y</span>=<span class="string">"207"</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span> <span class="tag">&lt;/<span class="name">bpmndi:BPMNPlane</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bpmndi:BPMNDiagram</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3><span id="关键的类和接口">关键的类和接口</span></h3><hr>
<p>加载流程文件并启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">First</span> </span>&#123; </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; </span><br><span class="line"><span class="comment">// 创建流程引擎  加 载 默 认 的 流 程 引 擎 配 置 文 件activiti.cfg.xml</span></span><br><span class="line">ProcessEngine engine = ProcessEngines.getDefaultProcessEngine(); </span><br><span class="line"><span class="comment">// 得到流程存储服务组件 </span></span><br><span class="line">RepositoryService repositoryService = engine.getRepositoryService(); </span><br><span class="line"><span class="comment">// 得到运行时服务组件 </span></span><br><span class="line">RuntimeService runtimeService = engine.getRuntimeService(); </span><br><span class="line"><span class="comment">// 获取流程任务组件 </span></span><br><span class="line">TaskService taskService = engine.getTaskService(); </span><br><span class="line"><span class="comment">// 部署流程文件 </span></span><br><span class="line">repositoryService.createDeployment() .addClasspathResource(<span class="string">"bpmn/First.bpmn"</span>).deploy(); </span><br><span class="line"><span class="comment">// 启动流程</span></span><br><span class="line">runtimeService.startProcessInstanceByKey(<span class="string">"process1"</span>);</span><br><span class="line"><span class="comment">// 查询第一个任务 </span></span><br><span class="line">Task task = taskService.createTaskQuery().singleResult(); </span><br><span class="line">System.out.println(<span class="string">"第一个任务完成前，当前任务名称："</span> + task.getName()); </span><br><span class="line"><span class="comment">// 完成第一个任务 </span></span><br><span class="line">taskService.complete(task.getId());</span><br><span class="line"><span class="comment">// 查询第二个任务 </span></span><br><span class="line">task = taskService.createTaskQuery().singleResult(); </span><br><span class="line">System.out.println(<span class="string">"第二个任务完成前，当前任务名称："</span> + task.getName()); </span><br><span class="line"><span class="comment">// 完成第二个任务（流程结束） </span></span><br><span class="line">taskService.complete(task.getId());</span><br><span class="line">task = taskService.createTaskQuery().singleResult();</span><br><span class="line">System.out.println(<span class="string">"流程结束后，查找任务："</span> + task); </span><br><span class="line"><span class="comment">// 退出 </span></span><br><span class="line">System.exit(<span class="number">0</span>);</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RepositoryService 部署流程文件，使用 RuntimeService 启动流程，然后使用 TaskService 进行流程任务查找，并对结束查找到的任务。</p>
<p>RepositoryService 主要用于管理流程的资源</p>
<p>RuntimeService 主要用于进行流程运行时的流程管理</p>
<p>TaskService 主要用于管理流程任务</p>
<h4><span id="processengineconfiguration">ProcessEngineConfiguration</span></h4><p>对象代表一个 Activiti 流程引擎的全部配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ProcessEngineConfiguration config = ProcessEngineConfiguration.createProcessEngineConfigurationFromResourceDefault();</span><br><span class="line"></span><br><span class="line">ProcessEngineConfiguration config = ProcessEngineConfiguration .createProcessEngineConfigurationFromResource(<span class="string">"my-activiti1.xml"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//test为创建的bean名字</span></span><br><span class="line">ProcessEngineConfiguration config = ProcessEngineConfiguration .createProcessEngineConfigurationFromResource( <span class="string">"my-activiti2.xml"</span>, <span class="string">"test"</span>);</span><br><span class="line">System.out.println(config.getProcessEngineName());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ProcessEngineConfiguration config = ProcessEngineConfiguration .createStandaloneProcessEngineConfiguration(); <span class="comment">// 默认值为 false System.out.println(config.getDatabaseSchemaUpdate()); // 默认值为 jdbc:h2:tcp://localhost/~/activiti System.out.println(config.getJdbcUrl());</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取配置 </span></span><br><span class="line">ProcessEngineConfiguration config = ProcessEngineConfiguration .createProcessEngineConfigurationFromResource(<span class="string">"build_engine.xml"</span>); </span><br><span class="line"><span class="comment">// 创建 ProcessEngine </span></span><br><span class="line">ProcessEngine engine = config.buildProcessEngine();</span><br></pre></td></tr></table></figure>



<p>得到流程引擎的相关配置后，buildProcessEngine 方法会根据这些配置，初始化流程 引擎的相关服务和对象，包括数据源、事务、拦截器、服务组件等等。这个流程引擎的初始 化过程，实际上也可以看作是一个配置检查的过程。</p>
<h4><span id="processengines">ProcessEngines</span></h4><p>类中维护一个 Map 对象，该对象的 key 为 ProcessEngine 实例的名称，value 为 ProcessEngine 的实例， 当向 ProcessEngines 注册 ProcessEngine 实例时，实际上是调用 Map 的 put 方法。ProcessEngines 实例在销毁时，会调用全部 ProcessEngine 的 close 方法，会对流程引擎进行关闭操作，这些操作包括关闭异步执行器（AsyncExecutor） 和执行数据库表删除（drop），需要让其删除数据表，前提是要将流程引擎配置的 。每 个 ProcessEngine 实 例 均 有 自 己 的 名 称 ， 在 ProcessEngines 的 Map 中，会使用该名称作为 Map 的 key 值，如果不为 ProcessEngine 设置名称的话，Activiti 会默认的将其设置为“default”。ProcessEngine 本身没有提供设置 名称的方法，该方法由 ProcessEngineConfiguration 提供。</p>
<p>databaseSchemaUpdate 属性设置为 create-drop</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 初始化 ProcessEngines 的 Map, </span><br><span class="line">&#x2F;&#x2F; 再加载 Activiti 默认的配置文件（classpath 下的 activiti.cfg.xml 文件） </span><br><span class="line">&#x2F;&#x2F; 如果与 Spring 整合，则读取 classpath 下的 activiti-context.xml 文件 </span><br><span class="line">ProcessEngines.init(); </span><br><span class="line">&#x2F;&#x2F; 得到 ProcessEngines 的 Map </span><br><span class="line">Map&lt;String, ProcessEngine&gt; engines &#x3D; ProcessEngines.getProcessEngines(); System.out.println(engines.size()); System.out.println(engines.get(&quot;default&quot;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;读取自定义配置</span><br><span class="line">ProcessEngineConfiguration config &#x3D; ProcessEngineConfiguration. createProcessEngineConfigurationFromResource(&quot;register.xml&quot;);</span><br><span class="line">&#x2F;&#x2F;创建 ProcessEngine 实例 </span><br><span class="line">ProcessEngine engine &#x3D; config.buildProcessEngine(); </span><br><span class="line">&#x2F;&#x2F;获取 ProcessEngine 的 Map</span><br><span class="line">Map&lt;String, ProcessEngine&gt; engines &#x3D; ProcessEngines.getProcessEngines();</span><br><span class="line">System.out.println(&quot;注册后引擎数：&quot; + engines.size()); </span><br><span class="line">&#x2F;&#x2F;注销 ProcessEngine 实例 </span><br><span class="line">ProcessEngines.unregister( engine); </span><br><span class="line">System.out.println(&quot;调用 unregister 后引擎数：&quot; + engines.size());</span><br></pre></td></tr></table></figure>



<h4><span id="processengine">ProcessEngine</span></h4><p>在 Activiti 中，一个 ProcessEngine 实例代表一个流程引擎，ProcessEngine 保存着各 个服务组件的实例，根据这些服务组件，可以操作流程实例、任务、系统角色等数据。</p>
<p>当创建了流程引擎实例后，在 ProcessEngine 中会初始化一系列服务组件，这些组件 提供了很多控制流程引擎的业务方法，可以使用 </p>
<p>ProcessEngine 中的 getXXXService 方法得到这些组件的实例。</p>
<p>RepositoryService：提供一系列管理流程定义和流程部署的 API。</p>
<p>RuntimeService：在流程运行时对流程实例进行管理与控制。</p>
<p>TaskService：对流程任务进行管理，例如任务提醒、任务完成和创建任务等。</p>
<p>IdentityService：提供对流程角色数据进行管理的 API，这些角色数据包括用户组、用户及它们之间的关系。</p>
<p>ManagementService：提供对流程引擎进行管理和维护的服务。</p>
<p>HistoryService：对流程的历史数据进行操作，包括查询、删除这些历史数据。</p>
<p>DynamicBpmnService：使用该服务，可以不需要重新部署流程模型，就可以实现对流程模型的部分修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//读取流程引擎配置 </span></span><br><span class="line">ProcessEngineConfiguration config = ProcessEngineConfiguration. createProcessEngineConfigurationFromResource(<span class="string">"service.xml"</span>); </span><br><span class="line"><span class="comment">//创建流程引擎</span></span><br><span class="line">ProcessEngine engine = config.buildProcessEngine(); </span><br><span class="line"><span class="comment">//得到各个业务组件实例 </span></span><br><span class="line">RepositoryService repositoryService = engine.getRepositoryService();</span><br><span class="line">RuntimeService runtimeService = engine.getRuntimeService(); </span><br><span class="line">TaskService taskService = engine.getTaskService(); </span><br><span class="line">IdentityService identityService = engine.getIdentityService();</span><br><span class="line">ManagementService managementService = engine.getManagementService(); </span><br><span class="line">HistoryService historyService = engine.getHistoryService(); </span><br><span class="line">DynamicBpmnService dynamicBpmnService = engine.getDynamicBpmnService();</span><br><span class="line"><span class="comment">// 输入类名 </span></span><br><span class="line">System.out.println(repositoryService.getClass().getName()); System.out.println(runtimeService.getClass().getName()); System.out.println(taskService.getClass().getName()); System.out.println(identityService.getClass().getName()); System.out.println(managementService.getClass().getName()); System.out.println(historyService.getClass().getName()); System.out.println(dynamicBpmnService.getClass().getName());</span><br></pre></td></tr></table></figure>





<p>在流程执行的过程中，会产生一些流程相应的数据，例如流程实例、流程任务和流程参 数等数据，随着流程的进行与结束，这些数据将会从流程数据表中删除，为了能保存这些数 据，Activiti 提供了历史数据表，可以让这些数据保存到历史数据表中。</p>
<p>history </p>
<p>属性有点像 log4j 的日志输出级别，该属性有以下四个值： </p>
<p>none：不保存任何的历史数据，因此，在流程执行过程中，这是最高效的。 </p>
<p>activity：级别高于 none，保存流程实例与流程行为，其他数据不保存。 </p>
<p>audit：除 activity 级别会保存的数据外，还会保存全部的流程任务及其属性。audit </p>
<p>为 history 的默认值。 </p>
<p>full：保存历史数据的最高级别，除了会保存 audit 级别的数据外，还会保存其他全 </p>
<p>部流程相关的细节数据，包括一些流程参数等</p>
<h3><span id="邮件通知">邮件通知</span></h3><hr>
<p>Activiti 支持邮件服务，当流程执行到某一个节点时，Activiti 会根据流程文件配置（Email </p>
<p>Task），发送邮件到相应的邮箱。以下为 ProcessEngineConfiguration 中提供的邮件服务器 </p>
<p>配置项：</p>
<p> </p>
<p>mailServerHost：邮件服务器地址，非必填，默认值为 localhost。 </p>
<p> </p>
<p>mailServerPort：SMTP 发送邮件服务器端口，默认值为 25。 </p>
<p> </p>
<p>mailServerDefaultFrom：非必填，发送人的邮箱地址，默认值为 <a href="mailto:activiti@activiti.org">activiti@activiti.org</a>。 </p>
<p> </p>
<p>mailServerUsername：邮箱登录用户名。 </p>
<p> </p>
<p>mailServerPassword：邮箱登录密码。 </p>
<p> </p>
<p>mailServerUseSSL：是否使用 SSL 协议通信，默认为 false。 </p>
<p> </p>
<p>mailServerUseTLS：是否使用 TLS 协议通信，默认为 false。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/act"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcDriver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUsername"</span> <span class="attr">value</span>=<span class="string">"root"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcPassword"</span> <span class="attr">value</span>=<span class="string">"123456"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mailServerHost"</span> <span class="attr">value</span>=<span class="string">"smtp.163.com"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mailServerPort"</span> <span class="attr">value</span>=<span class="string">"25"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mailServerDefaultFrom"</span> <span class="attr">value</span>=<span class="string">"yangenxiong@163.com"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mailServerUsername"</span> <span class="attr">value</span>=<span class="string">"yangenxiong@163.com"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mailServerPassword"</span> <span class="attr">value</span>=<span class="string">"123456"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3><span id="activiti-的命令拦截器">Activiti 的命令拦截器</span></h3><hr>
<h4><span id="activiti-数据查询">Activiti 数据查询</span></h4><hr>
<p>Activiti 的各个服务组件（XXXService）均提供了 createXXXQuery 方法，例如本章的 IdentityService 中的 createGroupQuery 方法和 createUserQuery 方法，TaskService 中的 craeteTaskQuery 方法等，这些方法返回的是一个 Query 实例，例如 createGroupQuery 返 回的是 GroupQuery，GroupQuery 是 Query 的子接口。 Query 是全部查询对象的父接口，该接口定义了若干个基础方法，各个查询对象均可以 使用这些公共方法，包括设置排序方式、数据量统计（count）、列表、分页和唯一记录查询。</p>
<p>asc：设置查询结果的排序方式为升序。 </p>
<p> </p>
<p>count：计算查询结果的数据量。 </p>
<p> </p>
<p>desc：设置查询结果的排序方式为降序。 </p>
<p> </p>
<p>list：封装查询结果，返回相应类型的集合。 </p>
<p> </p>
<p>listPage：分页返回查询结果。 </p>
<p> </p>
<p>singleResult：查询单条符合条件的数据，如果查询不到，则返回 null，如果查询到 </p>
<p>多条记录，则抛异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123; </span><br><span class="line">&#x2F;&#x2F; 创建流程引擎 </span><br><span class="line">ProcessEngine engine &#x3D; ProcessEngines.getDefaultProcessEngine(); </span><br><span class="line">&#x2F;&#x2F; 得到身份服务组件实例 </span><br><span class="line">IdentityService identityService &#x3D; engine.getIdentityService();</span><br><span class="line">&#x2F;&#x2F; 写入 5 条用户组数据 </span><br><span class="line">createGroup(identityService, &quot;1&quot;, &quot;GroupA&quot;, &quot;typeA&quot;); </span><br><span class="line">createGroup(identityService, &quot;2&quot;, &quot;GroupB&quot;, &quot;typeB&quot;); </span><br><span class="line">createGroup(identityService, &quot;3&quot;, &quot;GroupC&quot;, &quot;typeC&quot;); </span><br><span class="line">createGroup(identityService, &quot;4&quot;, &quot;GroupD&quot;, &quot;typeD&quot;);</span><br><span class="line">createGroup(identityService, &quot;5&quot;, &quot;GroupE&quot;, &quot;typeE&quot;); </span><br><span class="line">&#x2F;&#x2F; 使用 list 方法查询全部的部署数据 </span><br><span class="line">List&lt;Group&gt; datas &#x3D; identityService.createGroupQuery().list(); </span><br><span class="line">for (Group data : datas) &#123; System.out.println(data.getId() + &quot;---&quot; + data.getName() + &quot; &quot;); &#125; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">List&lt;Group&gt; datas &#x3D; identityService.createGroupQuery().orderByGroupName().desc().list();</span><br><span class="line">List&lt;Group&gt; datas &#x3D; identityService.createGroupQuery().orderByGroupId().asc().list();</span><br><span class="line">List&lt;Group&gt; datas &#x3D; identityService.createGroupQuery().listPage(2, 3);</span><br><span class="line">long size &#x3D; identityService.createGroupQuery().count();</span><br><span class="line">Group groupB &#x3D; identityService.createGroupQuery() .groupName(&quot;GroupB&quot;).singleResult();</span><br><span class="line">Group groupC &#x3D; identityService.createGroupQuery().groupType(&quot;typeC&quot;).singleResult();</span><br><span class="line">List&lt;Group&gt; groups &#x3D; identityService.createNativeGroupQuery() .sql(&quot;select * from ACT_ID_GROUP where NAME_ &#x3D; &#39;GroupC&#39;&quot;) .list();</span><br><span class="line">List&lt;Group&gt; groups &#x3D; identityService.createNativeGroupQuery() .sql(&quot;select * from ACT_ID_GROUP&quot;).list();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 将用户组数据保存到数据库中 </span><br><span class="line">static void createGroup(IdentityService identityService, String id, String name, String type) &#123; </span><br><span class="line">&#x2F;&#x2F; 调用 newGroup 方法创建 Group 实例 </span><br><span class="line">Group group &#x3D; identityService.newGroup(id); </span><br><span class="line">group.setName(name); group.setType(type); </span><br><span class="line">identityService.saveGroup(group);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2><span id="spring-boot-集成">Spring Boot 集成</span></h2><p>pom.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;io.lemon.activiti&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;activiti-project&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.0&lt;&#x2F;version&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.5.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;relativePath&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;&#x2F;java.version&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;&#x2F;project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;&#x2F;project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;activiti-dependencies.version&gt;7.1.0.M6&lt;&#x2F;activiti-dependencies.version&gt;</span><br><span class="line">    &lt;&#x2F;properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.activiti.dependencies&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;activiti-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;activiti-dependencies.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;&#x2F;scope&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">            &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;&#x2F;dependencies&gt;</span><br><span class="line">    &lt;&#x2F;dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.activiti&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;activiti-spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.activiti&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;activiti-image-generator&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-configuration-processor&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;&#x2F;optional&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis.spring.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.1.4&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">            &lt;exclusions&gt;</span><br><span class="line">                &lt;exclusion&gt;</span><br><span class="line">                    &lt;groupId&gt;org.junit.vintage&lt;&#x2F;groupId&gt;</span><br><span class="line">                    &lt;artifactId&gt;junit-vintage-engine&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;&#x2F;exclusion&gt;</span><br><span class="line">            &lt;&#x2F;exclusions&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>



<p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    url: jdbc:mysql:&#x2F;&#x2F;192.168.67.11:3306&#x2F;activiti?useSSL&#x3D;false</span><br><span class="line">    username: ap_bizas</span><br><span class="line">    password: Data@2020</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">  activiti:</span><br><span class="line">    database-schema-update: true</span><br><span class="line">    history-level: full</span><br><span class="line">    db-history-used: true</span><br><span class="line"></span><br><span class="line">mybatis:</span><br><span class="line">  mapperLocations: classpath:mapper&#x2F;*.xml</span><br><span class="line">server:</span><br><span class="line">  port: 9008</span><br></pre></td></tr></table></figure>



<p>resource/processes/MyProcess.bpmn.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;definitions xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.omg.org&#x2F;spec&#x2F;BPMN&#x2F;20100524&#x2F;MODEL&quot; xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot; xmlns:xsd&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema&quot; xmlns:activiti&#x3D;&quot;http:&#x2F;&#x2F;activiti.org&#x2F;bpmn&quot; xmlns:bpmndi&#x3D;&quot;http:&#x2F;&#x2F;www.omg.org&#x2F;spec&#x2F;BPMN&#x2F;20100524&#x2F;DI&quot; xmlns:omgdc&#x3D;&quot;http:&#x2F;&#x2F;www.omg.org&#x2F;spec&#x2F;DD&#x2F;20100524&#x2F;DC&quot; xmlns:omgdi&#x3D;&quot;http:&#x2F;&#x2F;www.omg.org&#x2F;spec&#x2F;DD&#x2F;20100524&#x2F;DI&quot; typeLanguage&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema&quot; expressionLanguage&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1999&#x2F;XPath&quot; targetNamespace&#x3D;&quot;http:&#x2F;&#x2F;www.activiti.org&#x2F;test&quot;&gt;</span><br><span class="line">    &lt;process id&#x3D;&quot;myProcess_1&quot; name&#x3D;&quot;My process&quot; isExecutable&#x3D;&quot;true&quot;&gt;</span><br><span class="line">        &lt;startEvent id&#x3D;&quot;startevent1&quot; name&#x3D;&quot;Start&quot;&gt;&lt;&#x2F;startEvent&gt;</span><br><span class="line">        &lt;userTask id&#x3D;&quot;usertask1&quot; name&#x3D;&quot;one&quot; activiti:candidateGroups&#x3D;&quot;activitiTeam&quot;&gt;&lt;&#x2F;userTask&gt;</span><br><span class="line">        &lt;sequenceFlow id&#x3D;&quot;flow1&quot; sourceRef&#x3D;&quot;startevent1&quot; targetRef&#x3D;&quot;usertask1&quot;&gt;&lt;&#x2F;sequenceFlow&gt;</span><br><span class="line">        &lt;userTask id&#x3D;&quot;usertask2&quot; name&#x3D;&quot;two&quot; activiti:candidateGroups&#x3D;&quot;activitiTeam&quot;&gt;&lt;&#x2F;userTask&gt;</span><br><span class="line">        &lt;sequenceFlow id&#x3D;&quot;flow2&quot; sourceRef&#x3D;&quot;usertask1&quot; targetRef&#x3D;&quot;usertask2&quot;&gt;&lt;&#x2F;sequenceFlow&gt;</span><br><span class="line">        &lt;endEvent id&#x3D;&quot;endevent1&quot; name&#x3D;&quot;End&quot;&gt;&lt;&#x2F;endEvent&gt;</span><br><span class="line">        &lt;sequenceFlow id&#x3D;&quot;flow3&quot; sourceRef&#x3D;&quot;usertask2&quot; targetRef&#x3D;&quot;endevent1&quot;&gt;&lt;&#x2F;sequenceFlow&gt;</span><br><span class="line">    &lt;&#x2F;process&gt;</span><br><span class="line">    &lt;bpmndi:BPMNDiagram id&#x3D;&quot;BPMNDiagram_myProcess_1&quot;&gt;</span><br><span class="line">        &lt;bpmndi:BPMNPlane bpmnElement&#x3D;&quot;myProcess_1&quot; id&#x3D;&quot;BPMNPlane_myProcess_1&quot;&gt;</span><br><span class="line">            &lt;bpmndi:BPMNShape bpmnElement&#x3D;&quot;startevent1&quot; id&#x3D;&quot;BPMNShape_startevent1&quot;&gt;</span><br><span class="line">                &lt;omgdc:Bounds height&#x3D;&quot;35.0&quot; width&#x3D;&quot;35.0&quot; x&#x3D;&quot;50.0&quot; y&#x3D;&quot;160.0&quot;&gt;&lt;&#x2F;omgdc:Bounds&gt;</span><br><span class="line">            &lt;&#x2F;bpmndi:BPMNShape&gt;</span><br><span class="line">            &lt;bpmndi:BPMNShape bpmnElement&#x3D;&quot;usertask1&quot; id&#x3D;&quot;BPMNShape_usertask1&quot;&gt;</span><br><span class="line">                &lt;omgdc:Bounds height&#x3D;&quot;55.0&quot; width&#x3D;&quot;105.0&quot; x&#x3D;&quot;130.0&quot; y&#x3D;&quot;150.0&quot;&gt;&lt;&#x2F;omgdc:Bounds&gt;</span><br><span class="line">            &lt;&#x2F;bpmndi:BPMNShape&gt;</span><br><span class="line">            &lt;bpmndi:BPMNShape bpmnElement&#x3D;&quot;usertask2&quot; id&#x3D;&quot;BPMNShape_usertask2&quot;&gt;</span><br><span class="line">                &lt;omgdc:Bounds height&#x3D;&quot;55.0&quot; width&#x3D;&quot;105.0&quot; x&#x3D;&quot;280.0&quot; y&#x3D;&quot;150.0&quot;&gt;&lt;&#x2F;omgdc:Bounds&gt;</span><br><span class="line">            &lt;&#x2F;bpmndi:BPMNShape&gt;</span><br><span class="line">            &lt;bpmndi:BPMNShape bpmnElement&#x3D;&quot;endevent1&quot; id&#x3D;&quot;BPMNShape_endevent1&quot;&gt;</span><br><span class="line">                &lt;omgdc:Bounds height&#x3D;&quot;35.0&quot; width&#x3D;&quot;35.0&quot; x&#x3D;&quot;430.0&quot; y&#x3D;&quot;160.0&quot;&gt;&lt;&#x2F;omgdc:Bounds&gt;</span><br><span class="line">            &lt;&#x2F;bpmndi:BPMNShape&gt;</span><br><span class="line">            &lt;bpmndi:BPMNEdge bpmnElement&#x3D;&quot;flow1&quot; id&#x3D;&quot;BPMNEdge_flow1&quot;&gt;</span><br><span class="line">                &lt;omgdi:waypoint x&#x3D;&quot;85.0&quot; y&#x3D;&quot;177.0&quot;&gt;&lt;&#x2F;omgdi:waypoint&gt;</span><br><span class="line">                &lt;omgdi:waypoint x&#x3D;&quot;130.0&quot; y&#x3D;&quot;177.0&quot;&gt;&lt;&#x2F;omgdi:waypoint&gt;</span><br><span class="line">            &lt;&#x2F;bpmndi:BPMNEdge&gt;</span><br><span class="line">            &lt;bpmndi:BPMNEdge bpmnElement&#x3D;&quot;flow2&quot; id&#x3D;&quot;BPMNEdge_flow2&quot;&gt;</span><br><span class="line">                &lt;omgdi:waypoint x&#x3D;&quot;235.0&quot; y&#x3D;&quot;177.0&quot;&gt;&lt;&#x2F;omgdi:waypoint&gt;</span><br><span class="line">                &lt;omgdi:waypoint x&#x3D;&quot;280.0&quot; y&#x3D;&quot;177.0&quot;&gt;&lt;&#x2F;omgdi:waypoint&gt;</span><br><span class="line">            &lt;&#x2F;bpmndi:BPMNEdge&gt;</span><br><span class="line">            &lt;bpmndi:BPMNEdge bpmnElement&#x3D;&quot;flow3&quot; id&#x3D;&quot;BPMNEdge_flow3&quot;&gt;</span><br><span class="line">                &lt;omgdi:waypoint x&#x3D;&quot;385.0&quot; y&#x3D;&quot;177.0&quot;&gt;&lt;&#x2F;omgdi:waypoint&gt;</span><br><span class="line">                &lt;omgdi:waypoint x&#x3D;&quot;430.0&quot; y&#x3D;&quot;177.0&quot;&gt;&lt;&#x2F;omgdi:waypoint&gt;</span><br><span class="line">            &lt;&#x2F;bpmndi:BPMNEdge&gt;</span><br><span class="line">        &lt;&#x2F;bpmndi:BPMNPlane&gt;</span><br><span class="line">    &lt;&#x2F;bpmndi:BPMNDiagram&gt;</span><br><span class="line">&lt;&#x2F;definitions&gt;</span><br></pre></td></tr></table></figure>

<p>src\main\java\io\lemon\activiti\LemonActivitiApplication.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">package io.lemon.activiti;</span><br><span class="line"></span><br><span class="line">import org.activiti.api.runtime.shared.query.Page;</span><br><span class="line">import org.activiti.api.runtime.shared.query.Pageable;</span><br><span class="line">import org.activiti.api.task.model.Task;</span><br><span class="line">import org.activiti.api.task.model.builders.TaskPayloadBuilder;</span><br><span class="line">import org.activiti.api.task.runtime.TaskRuntime;</span><br><span class="line">import org.activiti.api.task.runtime.events.TaskAssignedEvent;</span><br><span class="line">import org.activiti.api.task.runtime.events.TaskCompletedEvent;</span><br><span class="line">import org.activiti.api.task.runtime.events.listener.TaskRuntimeEventListener;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.CommandLineRunner;</span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class LemonActivitiApplication implements CommandLineRunner &#123;</span><br><span class="line"></span><br><span class="line">    private Logger logger &#x3D; LoggerFactory.getLogger(LemonActivitiApplication.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private TaskRuntime taskRuntime;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private SecurityUtil securityUtil;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(LemonActivitiApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(String... args) &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Using Security Util to simulate a logged in user</span><br><span class="line">        securityUtil.logInAs(&quot;salaboy&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Let&#39;s create a Group Task (not assigned, all the members of the group can claim it)</span><br><span class="line">        &#x2F;&#x2F;  Here &#39;salaboy&#39; is the owner of the created task</span><br><span class="line">        logger.info(&quot;&gt; Creating a Group Task for &#39;activitiTeam&#39;&quot;);</span><br><span class="line">        taskRuntime.create(TaskPayloadBuilder.create()</span><br><span class="line">                .withName(&quot;First Team Task&quot;)</span><br><span class="line">                .withDescription(&quot;This is something really important&quot;)</span><br><span class="line">                .withCandidateGroup(&quot;activitiTeam&quot;)</span><br><span class="line">                .withPriority(10)</span><br><span class="line">                .build());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Let&#39;s log in as &#39;other&#39; user that doesn&#39;t belong to the &#39;activitiTeam&#39; group</span><br><span class="line">        securityUtil.logInAs(&quot;other&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Let&#39;s get all my tasks (as &#39;other&#39; user)</span><br><span class="line">        logger.info(&quot;&gt; Getting all the tasks&quot;);</span><br><span class="line">        Page&lt;Task&gt; tasks &#x3D; taskRuntime.tasks(Pageable.of(0, 10));</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; No tasks are returned</span><br><span class="line">        logger.info(&quot;&gt;  Other cannot see the task: &quot; + tasks.getTotalItems());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Now let&#39;s switch to a user that belongs to the activitiTeam</span><br><span class="line">        securityUtil.logInAs(&quot;erdemedeiros&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Let&#39;s get &#39;erdemedeiros&#39; tasks</span><br><span class="line">        logger.info(&quot;&gt; Getting all the tasks&quot;);</span><br><span class="line">        tasks &#x3D; taskRuntime.tasks(Pageable.of(0, 10));</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; &#39;erdemedeiros&#39; can see and claim the task</span><br><span class="line">        logger.info(&quot;&gt;  erdemedeiros can see the task: &quot; + tasks.getTotalItems());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String availableTaskId &#x3D; tasks.getContent().get(0).getId();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Let&#39;s claim the task, after the claim, nobody else can see the task and &#39;erdemedeiros&#39; becomes the assignee</span><br><span class="line">        logger.info(&quot;&gt; Claiming the task&quot;);</span><br><span class="line">        taskRuntime.claim(TaskPayloadBuilder.claim().withTaskId(availableTaskId).build());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Let&#39;s complete the task</span><br><span class="line">        logger.info(&quot;&gt; Completing the task&quot;);</span><br><span class="line">        taskRuntime.complete(TaskPayloadBuilder.complete().withTaskId(availableTaskId).build());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public TaskRuntimeEventListener&lt;TaskAssignedEvent&gt; taskAssignedListener() &#123;</span><br><span class="line">        return taskAssigned -&gt; logger.info(&quot;&gt;&gt;&gt; Task Assigned: &#39;&quot;</span><br><span class="line">                + taskAssigned.getEntity().getName() +</span><br><span class="line">                &quot;&#39; We can send a notification to the assginee: &quot; + taskAssigned.getEntity().getAssignee());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public TaskRuntimeEventListener&lt;TaskCompletedEvent&gt; taskCompletedListener() &#123;</span><br><span class="line">        return taskCompleted -&gt; logger.info(&quot;&gt;&gt;&gt; Task Completed: &#39;&quot;</span><br><span class="line">                + taskCompleted.getEntity().getName() +</span><br><span class="line">                &quot;&#39; We can send a notification to the owner: &quot; + taskCompleted.getEntity().getOwner());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>src\main\java\io\lemon\activiti\LemonConfiguration.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">package io.lemon.activiti;</span><br><span class="line"></span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line">import org.springframework.security.core.userdetails.User;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line">import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line">import org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line">import org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class LemonConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    private Logger logger &#x3D; LoggerFactory.getLogger(LemonConfiguration.class);</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public UserDetailsService myUserDetailsService() &#123;</span><br><span class="line"></span><br><span class="line">        InMemoryUserDetailsManager inMemoryUserDetailsManager &#x3D; new InMemoryUserDetailsManager();</span><br><span class="line"></span><br><span class="line">        String[][] usersGroupsAndRoles &#x3D; &#123;</span><br><span class="line">                &#123;&quot;salaboy&quot;, &quot;password&quot;, &quot;ROLE_ACTIVITI_USER&quot;, &quot;GROUP_activitiTeam&quot;&#125;,</span><br><span class="line">                &#123;&quot;ryandawsonuk&quot;, &quot;password&quot;, &quot;ROLE_ACTIVITI_USER&quot;, &quot;GROUP_activitiTeam&quot;&#125;,</span><br><span class="line">                &#123;&quot;erdemedeiros&quot;, &quot;password&quot;, &quot;ROLE_ACTIVITI_USER&quot;, &quot;GROUP_activitiTeam&quot;&#125;,</span><br><span class="line">                &#123;&quot;other&quot;, &quot;password&quot;, &quot;ROLE_ACTIVITI_USER&quot;, &quot;GROUP_otherTeam&quot;&#125;,</span><br><span class="line">                &#123;&quot;admin&quot;, &quot;password&quot;, &quot;ROLE_ACTIVITI_ADMIN&quot;&#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        for (String[] user : usersGroupsAndRoles) &#123;</span><br><span class="line">            List&lt;String&gt; authoritiesStrings &#x3D; Arrays.asList(Arrays.copyOfRange(user, 2, user.length));</span><br><span class="line">            logger.info(&quot;&gt; Registering new user: &quot; + user[0] + &quot; with the following Authorities[&quot; + authoritiesStrings + &quot;]&quot;);</span><br><span class="line">            inMemoryUserDetailsManager.createUser(new User(user[0], passwordEncoder().encode(user[1]),</span><br><span class="line">                    authoritiesStrings.stream().map(s -&gt; new SimpleGrantedAuthority(s)).collect(Collectors.toList())));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        return inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder() &#123;</span><br><span class="line">        return new BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>src\main\java\io\lemon\activiti\SecurityUtil.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">package io.lemon.activiti;</span><br><span class="line"></span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line">import org.springframework.security.core.Authentication;</span><br><span class="line">import org.springframework.security.core.GrantedAuthority;</span><br><span class="line">import org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line">import org.springframework.security.core.context.SecurityContextImpl;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import java.util.Collection;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class SecurityUtil &#123;</span><br><span class="line"></span><br><span class="line">    private Logger logger &#x3D; LoggerFactory.getLogger(SecurityUtil.class);</span><br><span class="line"></span><br><span class="line">    @Qualifier(&quot;myUserDetailsService&quot;)</span><br><span class="line">    @Autowired</span><br><span class="line">    private UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    public void logInAs(String username) &#123;</span><br><span class="line"></span><br><span class="line">        UserDetails user &#x3D; userDetailsService.loadUserByUsername(username);</span><br><span class="line">        if (user &#x3D;&#x3D; null) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;User &quot; + username + &quot; doesn&#39;t exist, please provide a valid user&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(&quot;&gt; Logged in as: &quot; + username);</span><br><span class="line">        SecurityContextHolder.setContext(new SecurityContextImpl(new Authentication() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">                return user.getAuthorities();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public Object getCredentials() &#123;</span><br><span class="line">                return user.getPassword();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public Object getDetails() &#123;</span><br><span class="line">                return user;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public Object getPrincipal() &#123;</span><br><span class="line">                return user;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public boolean isAuthenticated() &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public String getName() &#123;</span><br><span class="line">                return user.getUsername();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        org.activiti.engine.impl.identity.Authentication.setAuthenticatedUserId(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>src\test\java\io\lemon\activiti\LemonActivitiApplicationTests.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.lemon.activiti;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.api.process.model.ProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.process.model.builders.ProcessPayloadBuilder;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.process.runtime.ProcessRuntime;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.runtime.shared.query.Page;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.runtime.shared.query.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.task.model.Task;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.task.model.builders.TaskPayloadBuilder;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.task.runtime.TaskRuntime;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RepositoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.Deployment;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.DeploymentBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">LemonActivitiApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProcessRuntime processRuntime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TaskRuntime taskRuntime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecurityUtil securityUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RepositoryService repositoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span> <span class="comment">// 查看流程</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        securityUtil.logInAs(<span class="string">"salaboy"</span>);</span><br><span class="line">        Page processDefinitionPage = processRuntime.processDefinitions(Pageable.of(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        System.err.println(<span class="string">"已部署的流程个数："</span> + processDefinitionPage.getTotalItems());</span><br><span class="line">        <span class="keyword">for</span> (Object obj : processDefinitionPage.getContent()) &#123;</span><br><span class="line">            System.err.println(<span class="string">"流程定义："</span> + obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span> <span class="comment">// 部署流程</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deploy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        securityUtil.logInAs(<span class="string">"salaboy"</span>);</span><br><span class="line">        String bpmnName = <span class="string">"MyProcess"</span>;</span><br><span class="line">        DeploymentBuilder deploymentBuilder = repositoryService.createDeployment().name(<span class="string">"请假流程"</span>);</span><br><span class="line">        Deployment deployment = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            deployment = deploymentBuilder.addClasspathResource(<span class="string">"processes/"</span> + bpmnName + <span class="string">".bpmn.xml"</span>)</span><br><span class="line">                    .deploy();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span> <span class="comment">// 查看流程</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        securityUtil.logInAs(<span class="string">"salaboy"</span>);</span><br><span class="line">        Page processDefinitionPage = processRuntime.processDefinitions(Pageable.of(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        System.err.println(<span class="string">"已部署的流程个数："</span> + processDefinitionPage.getTotalItems());</span><br><span class="line">        <span class="keyword">for</span> (Object obj : processDefinitionPage.getContent()) &#123;</span><br><span class="line">            System.err.println(<span class="string">"流程定义："</span> + obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span> <span class="comment">// 启动流程</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        securityUtil.logInAs(<span class="string">"salaboy"</span>);</span><br><span class="line">        ProcessInstance processInstance = processRuntime</span><br><span class="line">                .start(ProcessPayloadBuilder.start().withProcessDefinitionKey(<span class="string">"myProcess_1"</span>).build());</span><br><span class="line">        System.err.println(<span class="string">"流程实例ID："</span> + processInstance.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span> <span class="comment">// 执行流程</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        securityUtil.logInAs(<span class="string">"salaboy"</span>);</span><br><span class="line">        Page&lt;Task&gt; page = taskRuntime.tasks(Pageable.of(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        <span class="keyword">if</span> (page.getTotalItems() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Task task : page.getContent()) &#123;</span><br><span class="line">                System.err.println(<span class="string">"当前任务有1："</span> + task);</span><br><span class="line">                <span class="comment">// 拾取</span></span><br><span class="line">                taskRuntime.claim(TaskPayloadBuilder.claim().withTaskId(task.getId()).build());</span><br><span class="line">                <span class="comment">// 执行</span></span><br><span class="line">                taskRuntime.complete(TaskPayloadBuilder.complete().withTaskId(task.getId()).build());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.err.println(<span class="string">"没的任务1"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        page = taskRuntime.tasks(Pageable.of(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        <span class="keyword">if</span> (page.getTotalItems() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Task task : page.getContent()) &#123;</span><br><span class="line">                System.err.println(<span class="string">"当前任务有2："</span> + task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.err.println(<span class="string">"没的任务2"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3><span id="取消activiti-api-security-验证">取消Activiti api security 验证</span></h3><hr>
<p>@SpringBootApplication(exclude ={SecurityAutoConfiguration.class, org.activiti.spring.boot.SecurityAutoConfiguration.class} )</p>
<h3><span id="取消activiti7-集成swagger">取消Activiti7 集成swagger</span></h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line">import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line">import org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line">import org.springframework.security.core.userdetails.User;</span><br><span class="line">import org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line">import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line">import org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line">import org.springframework.security.provisioning.JdbcUserDetailsManager;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class ApplicationConfiguration  extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    private Logger logger &#x3D; LoggerFactory.getLogger(ApplicationConfiguration.class);</span><br><span class="line">    @Autowired</span><br><span class="line">    private DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public UserDetailsService myUserDetailsService() &#123;</span><br><span class="line"></span><br><span class="line">        JdbcUserDetailsManager jdbcUserDetailsManager &#x3D; new JdbcUserDetailsManager(dataSource);</span><br><span class="line"></span><br><span class="line">        String[][] usersGroupsAndRoles &#x3D; &#123;</span><br><span class="line">                &#123;&quot;salaboy&quot;, &quot;password&quot;, &quot;ROLE_ACTIVITI_USER&quot;, &quot;GROUP_activitiTeam&quot;&#125;,</span><br><span class="line">                &#123;&quot;ryandawsonuk&quot;, &quot;password&quot;, &quot;ROLE_ACTIVITI_USER&quot;, &quot;GROUP_activitiTeam&quot;&#125;,</span><br><span class="line">                &#123;&quot;erdemedeiros&quot;, &quot;password&quot;, &quot;ROLE_ACTIVITI_USER&quot;, &quot;GROUP_activitiTeam&quot;&#125;,</span><br><span class="line">                &#123;&quot;other&quot;, &quot;password&quot;, &quot;ROLE_ACTIVITI_USER&quot;, &quot;GROUP_otherTeam&quot;&#125;,</span><br><span class="line">                &#123;&quot;admin&quot;, &quot;password&quot;, &quot;ROLE_ACTIVITI_ADMIN&quot;&#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        for (String[] user : usersGroupsAndRoles) &#123;</span><br><span class="line">            List&lt;String&gt; authoritiesStrings &#x3D; Arrays.asList(Arrays.copyOfRange(user, 2, user.length));</span><br><span class="line">            logger.info(&quot;&gt; Registering new user: &quot; + user[0] + &quot; with the following Authorities[&quot; + authoritiesStrings + &quot;]&quot;);</span><br><span class="line">&#x2F;&#x2F;            jdbcUserDetailsManager.createUser(new User(user[0], passwordEncoder().encode(user[1]),</span><br><span class="line">&#x2F;&#x2F;                    authoritiesStrings.stream().map(s -&gt; new SimpleGrantedAuthority(s)).collect(Collectors.toList())));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return jdbcUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest()</span><br><span class="line">                .authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .httpBasic();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public PasswordEncoder passwordEncoder() &#123;</span><br><span class="line">        return new BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3><span id="activiti-数据表解释">Activiti 数据表解释</span></h3><hr>
<img src="/images/activiti-mysql.png" width="74%" height="75%">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/07/08/Alluxio%20JNI-FUSE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/08/Alluxio%20JNI-FUSE/" class="post-title-link" itemprop="url">Alluxio JNI-FUSE</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-08 00:00:00 / 修改时间：18:37:22" itemprop="dateCreated datePublished" datetime="2021-07-08T00:00:00+08:00">2021-07-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Alluxio-JNI-FUSE/" itemprop="url" rel="index"><span itemprop="name">Alluxio JNI-FUSE</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->

<ul>
<li><a href="#alluxio-jni-fuse">Alluxio JNI-FUSE</a><ul>
<li><a href="#挂载源码分析">挂载源码分析</a><ul>
<li><a href="#fuse_main">fuse_main</a></li>
</ul>
</li>
<li><a href="#libjnifuseso">libjnifuse.so</a><ul>
<li><a href="#将源码编译为libfuseso">将源码编译为libfuse.so</a></li>
<li><a href="#源码解析">源码解析</a><ul>
<li><a href="#jnifuse_implsh-jnifuse_implscc">jnifuse_impls.h &amp; jnifuse_impls.cc</a></li>
<li><a href="#jnifuse_fsh-jnifuse_fsh">jnifuse_fs.h &amp; jnifuse_fs.h</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#suse">SUSE</a><ul>
<li><a href="#example-helloc">Example-hello.c</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

<hr>
<h2><span id="alluxio-jni-fuse">Alluxio JNI-FUSE</span></h2><h3><span id="挂载源码分析">挂载源码分析</span></h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#96;$ .&#x2F;bin&#x2F;alluxio-fuse.sh umount mount_point&#96;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mount_fuse() &#123;</span><br><span class="line">  local mount_point&#x3D;$1</span><br><span class="line">  local alluxio_root&#x3D;$2</span><br><span class="line">  local full_mount_option&#x3D;&quot;&quot;</span><br><span class="line">  if [[ ! -z &quot;$&#123;mount_option&#125;&quot; ]]; then</span><br><span class="line">    full_mount_option&#x3D;&quot;big_writes,$&#123;mount_option&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    full_mount_option&#x3D;&quot;big_writes&quot;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ $&#123;NO_DAEMON&#125; -eq &quot;1&quot; ]]; then</span><br><span class="line">    ALLUXIO_FUSE_JAVA_OPTS+&#x3D;&quot; -Dalluxio.logger.type&#x3D;FUSE_LOGGER,Console&quot;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  local cmd&#x3D;&quot;$&#123;JAVA&#125; -cp $&#123;CLASSPATH&#125; $&#123;JAVA_OPTS&#125; $&#123;ALLUXIO_FUSE_JAVA_OPTS&#125; \</span><br><span class="line">    alluxio.fuse.AlluxioFuse \</span><br><span class="line">    -o $&#123;full_mount_option&#125; \</span><br><span class="line">    -m $&#123;mount_point&#125; \</span><br><span class="line">    -r $&#123;alluxio_root&#125;&quot;</span><br><span class="line">  echo &quot;Starting AlluxioFuse process: mounting alluxio path \&quot;$&#123;alluxio_root&#125;\&quot; to local mount point \&quot;$&#123;mount_point&#125;\&quot; with options&#x3D;\&quot;$&#123;full_mount_option&#125;\&quot;&quot;</span><br><span class="line">  if [[ $&#123;NO_DAEMON&#125; -eq &quot;1&quot; ]]; then</span><br><span class="line">    exec $&#123;cmd&#125;</span><br><span class="line">  else</span><br><span class="line">    (nohup $&#123;cmd&#125; &gt; $&#123;ALLUXIO_LOGS_DIR&#125;&#x2F;fuse.out 2&gt;&amp;1) &amp;</span><br><span class="line">    # sleep: workaround to let the bg java process exit on errors, if any</span><br><span class="line">    sleep 2s</span><br><span class="line">    if kill -0 $! &gt; &#x2F;dev&#x2F;null 2&gt;&amp;1 ; then</span><br><span class="line">      echo &quot;Successfully mounted Alluxio path \&quot;$&#123;alluxio_root&#125;\&quot; to $&#123;mount_point&#125;.&quot;</span><br><span class="line">      echo &quot;See $&#123;ALLUXIO_LOGS_DIR&#125;&#x2F;fuse.log for logging messages&quot;</span><br><span class="line">      return 0</span><br><span class="line">    else</span><br><span class="line">      echo &quot;Failed to mount Alluxio path \&quot;$&#123;alluxio_root&#125;\&quot; to $&#123;mount_point&#125;.&quot;</span><br><span class="line">      echo &quot;See $&#123;ALLUXIO_LOGS_DIR&#125;&#x2F;fuse.out for more details&quot;</span><br><span class="line">      return 1</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">umount_fuse() &#123;</span><br><span class="line">  local mount_point&#x3D;$1</span><br><span class="line">  local fuse_pid&#x3D;$(fuse_stat | awk &#39;&#123;print $1,$2&#125;&#39; | grep -w $&#123;mount_point&#125; | awk &#39;&#123;print $1&#125;&#39;)</span><br><span class="line">  if [[ -z $&#123;fuse_pid&#125; ]]; then</span><br><span class="line">    echo &quot;$&#123;mount_point&#125; not mounted&quot; &gt;&amp;2</span><br><span class="line">    return 1</span><br><span class="line">  else</span><br><span class="line">    echo &quot;Unmount fuse at $&#123;mount_point&#125; (PID: $&#123;fuse_pid&#125;).&quot;</span><br><span class="line">    kill $&#123;fuse_pid&#125;</span><br><span class="line">    return $?</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会执行到</p>
<p>alluxio.fuse.AlluxioFuse</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">          LOG.info(&quot;Mounting AlluxioJniFuseFileSystem: mount point&#x3D;\&quot;&#123;&#125;\&quot;, OPTIONS&#x3D;\&quot;&#123;&#125;\&quot;&quot;,</span><br><span class="line">              opts.getMountPoint(), fuseOpts.toArray(new String[0]));</span><br><span class="line">          fuseFs.mount(true, opts.isDebug(), fuseOpts.toArray(new String[0]));</span><br><span class="line">        &#125; catch (FuseException e) &#123;</span><br><span class="line">          LOG.error(&quot;Failed to mount &#123;&#125;&quot;, opts.getMountPoint(), e);</span><br><span class="line">          &#x2F;&#x2F; only try to umount file system when exception occurred.</span><br><span class="line">          &#x2F;&#x2F; jni-fuse registers JVM shutdown hook to ensure fs.umount()</span><br><span class="line">          &#x2F;&#x2F; will be executed when this process is exiting.</span><br><span class="line">          fuseFs.umount();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<p>AlluxioJniFuseFileSystem -&gt; alluxio.jnifuse.AbstractFuseFileSystem</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractFuseFileSystem implements FuseFileSystem &#123;</span><br><span class="line"></span><br><span class="line">  static &#123;</span><br><span class="line">    System.loadLibrary(&quot;jnifuse&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">try &#123;</span><br><span class="line">      if (SecurityUtils.canHandleShutdownHooks()) &#123;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(new Thread(this::umount));</span><br><span class="line">      &#125;</span><br><span class="line">      int res;</span><br><span class="line">      if (blocking) &#123;</span><br><span class="line">        res &#x3D; execMount(args);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          res &#x3D; CompletableFuture.supplyAsync(() -&gt; execMount(args)).get(MOUNT_TIMEOUT_MS,</span><br><span class="line">              TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125; catch (TimeoutException e) &#123;</span><br><span class="line">          &#x2F;&#x2F; ok</span><br><span class="line">          res &#x3D; 0;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (res !&#x3D; 0) &#123;</span><br><span class="line">        throw new FuseException(&quot;Unable to mount FS, return code &#x3D; &quot; + res);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">  private int execMount(String[] arg) &#123;</span><br><span class="line">    return libFuse.fuse_main_real(this, arg.length, arg);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>alluxio.jnifuse.LibFuse</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class LibFuse &#123;</span><br><span class="line"></span><br><span class="line">  public native int fuse_main_real(AbstractFuseFileSystem fs, int argc, String[] argv);</span><br><span class="line"></span><br><span class="line">  public native ByteBuffer fuse_get_context();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>fuse_main_real 会调用Fuse库的 fuse_main_real(argc, argv, op, sizeof(*(op)), user_data) </p>
<h5><span id="fuse_main">fuse_main</span></h5><hr>
<p>1.先打开设备文件/dev/fuse；<br>2.然后挂载FUSE文件系统；<br>3.产生FUSE文件系统指针；<br>4.初始化FUSE文件系统的操作函数集：<br>5.初始化信号处理函数集；<br>6.进入等待循环： </p>
<p>fuse_setup_common()函数调用fuse_new_common（lib/fuse.c）,fuse_new_common()函数分配fuse数据结构，存储并维护一个文件系统数据镜像缓存cached，返回到fuse_main()。</p>
<p>在用户态程序调用fuse_main() （lib/helper.c）时，先调用fuse_setup_common()该函数先解析用户态程序传递过来的参数，然后调用fuse_mount_common()（该函数是fuse_kern_mount()函数的封装，lib/mount.c）。 </p>
<p>fuse_kern_mount()通过/dev/fuse返回文件句柄给fuse_kern_chan_new()负责处理内核数据，然后返回到fuse_mount_common()函数。</p>
<p>fuse_setup_common()函数调用fuse_new_common（lib/fuse.c）,fuse_new_common()函数分配fuse数据结构，存储并维护一个文件系统数据镜像缓存cached，返回到fuse_main()。</p>
<p>fuse_kern_mount()函数中调用fuse_mount_fusermount()使用socketpair()创建一个UNIX域套接字，然后使用创建子进程执行fusermount程序，将FUSE_COMMFD_ENV环境变量中套接字的一端传递给它。</p>
<p>fusermount（util/fusermount.c）确保fuse 模块已经被加载，然后打开/dev/fuse并通过一个UNIX套接字发送文件处理句柄。父进程等待子进程执行完毕回收，然后返回fuse_mount_fusermount()函数。</p>
<p>最后，fuse_main()调用fuse_loop（lib/fuse.c）或者fuse_loop_mt()（lib/fuse_mt.c），这两个函数都可以从设备/dev/fuse读取文件系统调用，调用fuse_main()之前调用存储在fuse_operations结构体中的用户态函数。这些调用的结果回写到/dev/fuse设备（这个设备可以转发给系统调用）</p>
<h3><span id="libjnifuseso">libjnifuse.so</span></h3><hr>
<p>Linux下查看so包含的方法</p>
<p>nm -D libjnifuse.so &gt; listmethod.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">                 w __cxa_finalize</span><br><span class="line">                 U exit</span><br><span class="line">                 U fprintf</span><br><span class="line">                 U free</span><br><span class="line">                 U fuse_get_context</span><br><span class="line">                 U fuse_main_real</span><br><span class="line">                 w __gmon_start__</span><br><span class="line">                 U __gxx_personality_v0</span><br><span class="line">                 w _ITM_deregisterTMCloneTable</span><br><span class="line">                 w _ITM_registerTMCloneTable</span><br><span class="line">000000000000572d T Java_alluxio_jnifuse_FuseFillDir_fill</span><br><span class="line">00000000000057a8 T Java_alluxio_jnifuse_LibFuse_fuse_1get_1context</span><br><span class="line">0000000000005595 T Java_alluxio_jnifuse_LibFuse_fuse_1main_1real</span><br><span class="line">                 U malloc</span><br><span class="line">                 U pthread_getspecific</span><br><span class="line">                 U pthread_key_create</span><br><span class="line">                 U pthread_setspecific</span><br><span class="line">                 U stderr</span><br><span class="line">                 U _Unwind_Resume</span><br><span class="line">0000000000007f9b T _Z12open_wrapperPKcP14fuse_file_info</span><br><span class="line">0000000000007fcf T _Z12read_wrapperPKcPcmlP14fuse_file_info</span><br><span class="line">0000000000007eb0 T _Z13chmod_wrapperPKcj</span><br><span class="line">0000000000007f0d T _Z13flush_wrapperPKcP14fuse_file_info</span><br><span class="line">0000000000007f6f T _Z13mkdir_wrapperPKcj</span><br><span class="line">00000000000080c9 T _Z13rmdir_wrapperPKc</span><br><span class="line">0000000000008115 T _Z13write_wrapperPKcS0_mlP14fuse_file_info</span><br><span class="line">0000000000007edc T _Z14create_wrapperPKcjP14fuse_file_info</span><br><span class="line">000000000000809b T _Z14rename_wrapperPKcS0_</span><br><span class="line">00000000000080ef T _Z14unlink_wrapperPKc</span><br><span class="line">0000000000007f3b T _Z15getattr_wrapperPKcP4stat</span><br><span class="line">000000000000801e T _Z15readdir_wrapperPKcPvPFiS1_S0_PK4statlElP14fuse_file_info</span><br><span class="line">000000000000806d T _Z15release_wrapperPKcP14fuse_file_info</span><br><span class="line">                 U _ZdlPv</span><br><span class="line">00000000000060a4 W _ZN7JavaVM_19DetachCurrentThreadEv</span><br><span class="line">00000000000060c6 W _ZN7JavaVM_27AttachCurrentThreadAsDaemonEPPvS0_</span><br><span class="line">000000000000793e W _ZN7JNIEnv_11GetMethodIDEP7_jclassPKcS3_</span><br><span class="line">0000000000006044 W _ZN7JNIEnv_12NewGlobalRefEP8_jobject</span><br><span class="line">0000000000007a3c W _ZN7JNIEnv_12NewStringUTFEPKc</span><br><span class="line">0000000000007978 W _ZN7JNIEnv_13CallIntMethodEP8_jobjectP10_jmethodIDz</span><br><span class="line">0000000000007816 W _ZN7JNIEnv_14DeleteLocalRefEP8_jobject</span><br><span class="line">000000000000790e W _ZN7JNIEnv_14GetObjectClassEP8_jobject</span><br><span class="line">00000000000057e4 W _ZN7JNIEnv_17GetStringUTFCharsEP8_jstringPh</span><br><span class="line">0000000000005884 W _ZN7JNIEnv_19NewDirectByteBufferEPvl</span><br><span class="line">0000000000005850 W _ZN7JNIEnv_21GetObjectArrayElementEP13_jobjectArrayi</span><br><span class="line">000000000000581a W _ZN7JNIEnv_21ReleaseStringUTFCharsEP8_jstringPKc</span><br><span class="line">00000000000077e8 W _ZN7JNIEnv_9FindClassEPKc</span><br><span class="line">0000000000006074 W _ZN7JNIEnv_9GetJavaVMEPP7JavaVM_</span><br><span class="line">0000000000007848 W _ZN7JNIEnv_9NewObjectEP7_jclassP10_jmethodIDz</span><br><span class="line">0000000000006440 T _ZN7jnifuse13OpenOperation4callEPKcP14fuse_file_info</span><br><span class="line">0000000000006346 T _ZN7jnifuse13OpenOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000006346 T _ZN7jnifuse13OpenOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007e36 W _ZN7jnifuse13OpenOperationD0Ev</span><br><span class="line">0000000000007e08 W _ZN7jnifuse13OpenOperationD1Ev</span><br><span class="line">0000000000007e08 W _ZN7jnifuse13OpenOperationD2Ev</span><br><span class="line">00000000000065f0 T _ZN7jnifuse13ReadOperation4callEPKcPcmlP14fuse_file_info</span><br><span class="line">00000000000064f6 T _ZN7jnifuse13ReadOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">00000000000064f6 T _ZN7jnifuse13ReadOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007de2 W _ZN7jnifuse13ReadOperationD0Ev</span><br><span class="line">0000000000007db4 W _ZN7jnifuse13ReadOperationD1Ev</span><br><span class="line">0000000000007db4 W _ZN7jnifuse13ReadOperationD2Ev</span><br><span class="line">0000000000006f14 T _ZN7jnifuse14ChmodOperation4callEPKcj</span><br><span class="line">0000000000006e1a T _ZN7jnifuse14ChmodOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000006e1a T _ZN7jnifuse14ChmodOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007c3e W _ZN7jnifuse14ChmodOperationD0Ev</span><br><span class="line">0000000000007c10 W _ZN7jnifuse14ChmodOperationD1Ev</span><br><span class="line">0000000000007c10 W _ZN7jnifuse14ChmodOperationD2Ev</span><br><span class="line">0000000000006bb4 T _ZN7jnifuse14FlushOperation4callEPKcP14fuse_file_info</span><br><span class="line">0000000000006aba T _ZN7jnifuse14FlushOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000006aba T _ZN7jnifuse14FlushOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007ce6 W _ZN7jnifuse14FlushOperationD0Ev</span><br><span class="line">0000000000007cb8 W _ZN7jnifuse14FlushOperationD1Ev</span><br><span class="line">0000000000007cb8 W _ZN7jnifuse14FlushOperationD2Ev</span><br><span class="line">000000000000724a T _ZN7jnifuse14MkdirOperation4callEPKcj</span><br><span class="line">0000000000007150 T _ZN7jnifuse14MkdirOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007150 T _ZN7jnifuse14MkdirOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007b96 W _ZN7jnifuse14MkdirOperationD0Ev</span><br><span class="line">0000000000007b68 W _ZN7jnifuse14MkdirOperationD1Ev</span><br><span class="line">0000000000007b68 W _ZN7jnifuse14MkdirOperationD2Ev</span><br><span class="line">00000000000073c8 T _ZN7jnifuse14RmdirOperation4callEPKc</span><br><span class="line">00000000000072ce T _ZN7jnifuse14RmdirOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">00000000000072ce T _ZN7jnifuse14RmdirOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007aee W _ZN7jnifuse14RmdirOperationD0Ev</span><br><span class="line">0000000000007ac0 W _ZN7jnifuse14RmdirOperationD1Ev</span><br><span class="line">0000000000007ac0 W _ZN7jnifuse14RmdirOperationD2Ev</span><br><span class="line">000000000000753e T _ZN7jnifuse14WriteOperation4callEPKcS2_mlP14fuse_file_info</span><br><span class="line">0000000000007444 T _ZN7jnifuse14WriteOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007444 T _ZN7jnifuse14WriteOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007a9a W _ZN7jnifuse14WriteOperationD0Ev</span><br><span class="line">0000000000007a6c W _ZN7jnifuse14WriteOperationD1Ev</span><br><span class="line">0000000000007a6c W _ZN7jnifuse14WriteOperationD2Ev</span><br><span class="line">0000000000007092 T _ZN7jnifuse15CreateOperation4callEPKcjP14fuse_file_info</span><br><span class="line">0000000000006f98 T _ZN7jnifuse15CreateOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000006f98 T _ZN7jnifuse15CreateOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007bea W _ZN7jnifuse15CreateOperationD0Ev</span><br><span class="line">0000000000007bbc W _ZN7jnifuse15CreateOperationD1Ev</span><br><span class="line">0000000000007bbc W _ZN7jnifuse15CreateOperationD2Ev</span><br><span class="line">0000000000007738 T _ZN7jnifuse15RenameOperation4callEPKcS2_</span><br><span class="line">000000000000763e T _ZN7jnifuse15RenameOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">000000000000763e T _ZN7jnifuse15RenameOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007b42 W _ZN7jnifuse15RenameOperationD0Ev</span><br><span class="line">0000000000007b14 W _ZN7jnifuse15RenameOperationD1Ev</span><br><span class="line">0000000000007b14 W _ZN7jnifuse15RenameOperationD2Ev</span><br><span class="line">0000000000006a3e T _ZN7jnifuse15UnlinkOperation4callEPKc</span><br><span class="line">0000000000006944 T _ZN7jnifuse15UnlinkOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000006944 T _ZN7jnifuse15UnlinkOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007d3a W _ZN7jnifuse15UnlinkOperationD0Ev</span><br><span class="line">0000000000007d0c W _ZN7jnifuse15UnlinkOperationD1Ev</span><br><span class="line">0000000000007d0c W _ZN7jnifuse15UnlinkOperationD2Ev</span><br><span class="line">0000000000006290 T _ZN7jnifuse16GetattrOperation4callEPKcP4stat</span><br><span class="line">0000000000006196 T _ZN7jnifuse16GetattrOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000006196 T _ZN7jnifuse16GetattrOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007e8a W _ZN7jnifuse16GetattrOperationD0Ev</span><br><span class="line">0000000000007e5c W _ZN7jnifuse16GetattrOperationD1Ev</span><br><span class="line">0000000000007e5c W _ZN7jnifuse16GetattrOperationD2Ev</span><br><span class="line">0000000000006836 T _ZN7jnifuse16ReaddirOperation4callEPKcPvPFiS3_S2_PK4statlElP14fuse_file_info</span><br><span class="line">00000000000066f0 T _ZN7jnifuse16ReaddirOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">00000000000066f0 T _ZN7jnifuse16ReaddirOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007d8e W _ZN7jnifuse16ReaddirOperationD0Ev</span><br><span class="line">0000000000007d60 W _ZN7jnifuse16ReaddirOperationD1Ev</span><br><span class="line">0000000000007d60 W _ZN7jnifuse16ReaddirOperationD2Ev</span><br><span class="line">0000000000006d64 T _ZN7jnifuse16ReleaseOperation4callEPKcP14fuse_file_info</span><br><span class="line">0000000000006c6a T _ZN7jnifuse16ReleaseOperationC1EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000006c6a T _ZN7jnifuse16ReleaseOperationC2EPNS_17JniFuseFileSystemE</span><br><span class="line">0000000000007c92 W _ZN7jnifuse16ReleaseOperationD0Ev</span><br><span class="line">0000000000007c64 W _ZN7jnifuse16ReleaseOperationD1Ev</span><br><span class="line">0000000000007c64 W _ZN7jnifuse16ReleaseOperationD2Ev</span><br><span class="line">0000000000005f36 T _ZN7jnifuse17JniFuseFileSystem11getInstanceEv</span><br><span class="line">0000000000005e8c T _ZN7jnifuse17JniFuseFileSystem4initEP7JNIEnv_P8_jobject</span><br><span class="line">0000000000005f8a T _ZN7jnifuse17JniFuseFileSystem6getEnvEv</span><br><span class="line">0000000000006020 T _ZN7jnifuse17JniFuseFileSystem6getJVMEv</span><br><span class="line">0000000000006032 T _ZN7jnifuse17JniFuseFileSystem8getFSObjEv</span><br><span class="line">000000000000c408 B _ZN7jnifuse17JniFuseFileSystem8instanceE</span><br><span class="line">00000000000058f8 T _ZN7jnifuse17JniFuseFileSystemC1EP7JNIEnv_P8_jobject</span><br><span class="line">00000000000058f8 T _ZN7jnifuse17JniFuseFileSystemC2EP7JNIEnv_P8_jobject</span><br><span class="line">0000000000005c40 T _ZN7jnifuse17JniFuseFileSystemD1Ev</span><br><span class="line">0000000000005c40 T _ZN7jnifuse17JniFuseFileSystemD2Ev</span><br><span class="line">00000000000060f8 T _ZN7jnifuse9OperationC1Ev</span><br><span class="line">00000000000060f8 T _ZN7jnifuse9OperationC2Ev</span><br><span class="line">0000000000006170 T _ZN7jnifuse9OperationD0Ev</span><br><span class="line">0000000000006152 T _ZN7jnifuse9OperationD1Ev</span><br><span class="line">0000000000006152 T _ZN7jnifuse9OperationD2Ev</span><br><span class="line">                 U _Znwm</span><br><span class="line">000000000000bca8 V _ZTIN7jnifuse13OpenOperationE</span><br><span class="line">000000000000bc90 V _ZTIN7jnifuse13ReadOperationE</span><br><span class="line">000000000000bc18 V _ZTIN7jnifuse14ChmodOperationE</span><br><span class="line">000000000000bc48 V _ZTIN7jnifuse14FlushOperationE</span><br><span class="line">000000000000bbe8 V _ZTIN7jnifuse14MkdirOperationE</span><br><span class="line">000000000000bbb8 V _ZTIN7jnifuse14RmdirOperationE</span><br><span class="line">000000000000bba0 V _ZTIN7jnifuse14WriteOperationE</span><br><span class="line">000000000000bc00 V _ZTIN7jnifuse15CreateOperationE</span><br><span class="line">000000000000bbd0 V _ZTIN7jnifuse15RenameOperationE</span><br><span class="line">000000000000bc60 V _ZTIN7jnifuse15UnlinkOperationE</span><br><span class="line">000000000000bcc0 V _ZTIN7jnifuse16GetattrOperationE</span><br><span class="line">000000000000bc78 V _ZTIN7jnifuse16ReaddirOperationE</span><br><span class="line">000000000000bc30 V _ZTIN7jnifuse16ReleaseOperationE</span><br><span class="line">000000000000bcd8 V _ZTIN7jnifuse9OperationE</span><br><span class="line">0000000000009430 V _ZTSN7jnifuse13OpenOperationE</span><br><span class="line">0000000000009410 V _ZTSN7jnifuse13ReadOperationE</span><br><span class="line">0000000000009370 V _ZTSN7jnifuse14ChmodOperationE</span><br><span class="line">00000000000093b0 V _ZTSN7jnifuse14FlushOperationE</span><br><span class="line">0000000000009330 V _ZTSN7jnifuse14MkdirOperationE</span><br><span class="line">00000000000092f0 V _ZTSN7jnifuse14RmdirOperationE</span><br><span class="line">00000000000092d0 V _ZTSN7jnifuse14WriteOperationE</span><br><span class="line">0000000000009350 V _ZTSN7jnifuse15CreateOperationE</span><br><span class="line">0000000000009310 V _ZTSN7jnifuse15RenameOperationE</span><br><span class="line">00000000000093d0 V _ZTSN7jnifuse15UnlinkOperationE</span><br><span class="line">0000000000009450 V _ZTSN7jnifuse16GetattrOperationE</span><br><span class="line">00000000000093f0 V _ZTSN7jnifuse16ReaddirOperationE</span><br><span class="line">0000000000009390 V _ZTSN7jnifuse16ReleaseOperationE</span><br><span class="line">0000000000009470 V _ZTSN7jnifuse9OperationE</span><br><span class="line">                 U _ZTVN10__cxxabiv117__class_type_infoE</span><br><span class="line">                 U _ZTVN10__cxxabiv120__si_class_type_infoE</span><br><span class="line">000000000000bb60 V _ZTVN7jnifuse13OpenOperationE</span><br><span class="line">000000000000bb40 V _ZTVN7jnifuse13ReadOperationE</span><br><span class="line">000000000000baa0 V _ZTVN7jnifuse14ChmodOperationE</span><br><span class="line">000000000000bae0 V _ZTVN7jnifuse14FlushOperationE</span><br><span class="line">000000000000ba60 V _ZTVN7jnifuse14MkdirOperationE</span><br><span class="line">000000000000ba20 V _ZTVN7jnifuse14RmdirOperationE</span><br><span class="line">000000000000ba00 V _ZTVN7jnifuse14WriteOperationE</span><br><span class="line">000000000000ba80 V _ZTVN7jnifuse15CreateOperationE</span><br><span class="line">000000000000ba40 V _ZTVN7jnifuse15RenameOperationE</span><br><span class="line">000000000000bb00 V _ZTVN7jnifuse15UnlinkOperationE</span><br><span class="line">000000000000bb80 V _ZTVN7jnifuse16GetattrOperationE</span><br><span class="line">000000000000bb20 V _ZTVN7jnifuse16ReaddirOperationE</span><br><span class="line">000000000000bac0 V _ZTVN7jnifuse16ReleaseOperationE</span><br><span class="line">000000000000b9e0 V _ZTVN7jnifuse9OperationE</span><br></pre></td></tr></table></figure>



<h4><span id="将源码编译为libfuseso">将源码编译为libfuse.so</span></h4><hr>
<p>查看makefile文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># The Alluxio Open Foundation licenses this work under the Apache License, version 2.0</span><br><span class="line"># (the &quot;License&quot;). You may not use this work except in compliance with the License, which is</span><br><span class="line"># available at www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line">#</span><br><span class="line"># This software is distributed on an &quot;AS IS&quot; basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,</span><br><span class="line"># either express or implied, as more fully set forth in the License.</span><br><span class="line">#</span><br><span class="line"># See the NOTICE file distributed with this work for information regarding copyright ownership.</span><br><span class="line"></span><br><span class="line">CXX :&#x3D; g++</span><br><span class="line">UNAME :&#x3D; $(shell uname)</span><br><span class="line">INCDIR &#x3D; -I &#x2F;usr&#x2F;include -I $(JAVA_HOME)&#x2F;include -I .&#x2F;</span><br><span class="line">FUSE_LIBS &#x3D; $(shell pkg-config fuse --libs)</span><br><span class="line">FUSE_CXXFLAGS &#x3D; $(shell pkg-config fuse --cflags)</span><br><span class="line"></span><br><span class="line"># Linux</span><br><span class="line">ifeq ($(UNAME), Linux)</span><br><span class="line">	INCDIR +&#x3D; -I $(JAVA_HOME)&#x2F;include&#x2F;linux</span><br><span class="line">	TARGET_LIB :&#x3D; libjnifuse.so</span><br><span class="line">endif</span><br><span class="line"># MacOS</span><br><span class="line">ifeq ($(UNAME), Darwin)</span><br><span class="line">	INCDIR +&#x3D; -I $(JAVA_HOME)&#x2F;include&#x2F;darwin</span><br><span class="line">	TARGET_LIB :&#x3D; libjnifuse.dylib</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">CXXFLAGS &#x3D; -std&#x3D;c++11 -Wall -fPIC -D_FILE_OFFSET_BITS&#x3D;64 $&#123;INCDIR&#125; $&#123;FUSE_CXXFLAGS&#125;</span><br><span class="line">LDFLAGS &#x3D; -shared $&#123;FUSE_LIBS&#125;</span><br><span class="line">OUTPUT_DIR ?&#x3D; .</span><br><span class="line">SRC_DIR ?&#x3D; ..&#x2F;..&#x2F;src&#x2F;main&#x2F;native&#x2F;libjnifuse</span><br><span class="line">OBJS&#x3D; $(addprefix $(OUTPUT_DIR)&#x2F;, $(patsubst %.cc,%.o,$(notdir $(wildcard $(SRC_DIR)&#x2F;*.cc))))</span><br><span class="line"></span><br><span class="line">$&#123;TARGET_LIB&#125;: $&#123;OBJS&#125;</span><br><span class="line">	$&#123;CXX&#125; $&#123;CXXFLAGS&#125; -o $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;TARGET_LIB&#125; $&#123;OBJS&#125; $&#123;LDFLAGS&#125;</span><br><span class="line"></span><br><span class="line">install: $&#123;TARGET_LIB&#125;</span><br><span class="line">	sudo mv $&#123;TARGET_LIB&#125; &#x2F;usr&#x2F;lib&#x2F;</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	rm -rf $&#123;OBJS&#125; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;TARGET_LIB&#125;</span><br><span class="line"></span><br><span class="line">$&#123;OUTPUT_DIR&#125;&#x2F;%.o: $&#123;SRC_DIR&#125;&#x2F;%.cc</span><br><span class="line">	$&#123;CXX&#125; $&#123;CXXFLAGS&#125; -o $@ -c $&lt;</span><br></pre></td></tr></table></figure>



<h4><span id="源码解析">源码解析</span></h4><hr>
<p>/src/main/native/libjnifuse</p>
<p>debug.h</p>
<p>jnifuse_fs.cc</p>
<p>jnifuse_fs.h</p>
<p>jnifuse_helper.cc</p>
<p>jnifuse_impls.cc</p>
<p>jnifuse_impls.h</p>
<p>Makefile</p>
<p>operation.cc</p>
<p>operation.h</p>
<p>依赖库</p>
<p>libfuse-dev，fuse-utils</p>
<p>在用户态程序调用fuse_main() （lib/helper.c）时，先调用fuse_setup_common()该函数先解析用户态程序传递过来的参数，然后调用fuse_mount_common()（该函数是fuse_kern_mount()函数的封装，lib/mount.c）。<br>fuse_main()是一个宏定义（include/fuse.h）,如下：</p>
<h5><span id="jnifuse_implsh-amp-jnifuse_implscc">jnifuse_impls.h &amp; jnifuse_impls.cc</span></h5><hr>
<p>转发实现</p>
<p>头文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0</span><br><span class="line"> * (the &quot;License&quot;). You may not use this work except in compliance with the License, which is</span><br><span class="line"> * available at www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * This software is distributed on an &quot;AS IS&quot; basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,</span><br><span class="line"> * either express or implied, as more fully set forth in the License.</span><br><span class="line"> *</span><br><span class="line"> * See the NOTICE file distributed with this work for information regarding copyright ownership.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">#ifndef FUSE_NATIVE_LIBJNIFUSE_IMPLS_H_</span><br><span class="line">#define FUSE_NATIVE_LIBJNIFUSE_IMPLS_H_</span><br><span class="line"></span><br><span class="line">#ifndef FUSE_USE_VERSION</span><br><span class="line">#define FUSE_USE_VERSION 26</span><br><span class="line">#endif</span><br><span class="line">#include &lt;fuse.h&gt;</span><br><span class="line"></span><br><span class="line">int chmod_wrapper(const char *path, mode_t mode);</span><br><span class="line">int create_wrapper(const char *path, mode_t mode, struct fuse_file_info *fi);</span><br><span class="line">int flush_wrapper(const char *path, struct fuse_file_info *fi);</span><br><span class="line">int getattr_wrapper(const char *path, struct stat *stbuf);</span><br><span class="line">int mkdir_wrapper(const char *path, mode_t mode);</span><br><span class="line">int open_wrapper(const char *path, struct fuse_file_info *fi);</span><br><span class="line">int read_wrapper(const char *path, char *buf, size_t size, off_t offset,</span><br><span class="line">                 struct fuse_file_info *fi);</span><br><span class="line">int readdir_wrapper(const char *path, void *buf, fuse_fill_dir_t filler,</span><br><span class="line">                    off_t offset, struct fuse_file_info *fi);</span><br><span class="line">int release_wrapper(const char *path, struct fuse_file_info *fi);</span><br><span class="line">int rename_wrapper(const char *oldPath, const char *newPath);</span><br><span class="line">int rmdir_wrapper(const char *path);</span><br><span class="line">int unlink_wrapper(const char *path);</span><br><span class="line">int write_wrapper(const char *path, const char *buf, size_t size, off_t off,</span><br><span class="line">                  struct fuse_file_info *fi);</span><br><span class="line"></span><br><span class="line">#endif  &#x2F;&#x2F; FUSE_NATIVE_LIBJNIFUSE_IMPLS_H_</span><br></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0</span><br><span class="line"> * (the &quot;License&quot;). You may not use this work except in compliance with the License, which is</span><br><span class="line"> * available at www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * This software is distributed on an &quot;AS IS&quot; basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,</span><br><span class="line"> * either express or implied, as more fully set forth in the License.</span><br><span class="line"> *</span><br><span class="line"> * See the NOTICE file distributed with this work for information regarding copyright ownership.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">#include &quot;jnifuse_impls.h&quot;</span><br><span class="line"></span><br><span class="line">#include &quot;debug.h&quot;</span><br><span class="line">#include &quot;jnifuse_fs.h&quot;</span><br><span class="line"></span><br><span class="line">int chmod_wrapper(const char *path, mode_t mode) &#123;</span><br><span class="line">  return jnifuse::JniFuseFileSystem::getInstance()-&gt;chmodOper-&gt;call(path, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int create_wrapper(const char *path, mode_t mode, struct fuse_file_info *fi) &#123;</span><br><span class="line">  return jnifuse::JniFuseFileSystem::getInstance()-&gt;createOper-&gt;call(path, mode,</span><br><span class="line">                                                                     fi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int flush_wrapper(const char *path, struct fuse_file_info *fi) &#123;</span><br><span class="line">  return jnifuse::JniFuseFileSystem::getInstance()-&gt;flushOper-&gt;call(path, fi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int getattr_wrapper(const char *path, struct stat *stbuf) &#123;</span><br><span class="line">  LOGD(&quot;getattr %s&quot;, path);</span><br><span class="line"></span><br><span class="line">  int ret &#x3D;</span><br><span class="line">      jnifuse::JniFuseFileSystem::getInstance()-&gt;getattrOper-&gt;call(path, stbuf);</span><br><span class="line"></span><br><span class="line">  LOGD(&quot;file %s: size&#x3D;%ld, mod&#x3D;%d&quot;, path, stbuf-&gt;st_size, stbuf-&gt;st_mode);</span><br><span class="line"></span><br><span class="line">  return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int mkdir_wrapper(const char *path, mode_t mode) &#123;</span><br><span class="line">  return jnifuse::JniFuseFileSystem::getInstance()-&gt;mkdirOper-&gt;call(path, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int open_wrapper(const char *path, struct fuse_file_info *fi) &#123;</span><br><span class="line">  LOGD(&quot;open %s&quot;, path);</span><br><span class="line"></span><br><span class="line">  int ret &#x3D; jnifuse::JniFuseFileSystem::getInstance()-&gt;openOper-&gt;call(path, fi);</span><br><span class="line"></span><br><span class="line">  return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int read_wrapper(const char *path, char *buf, size_t size, off_t offset,</span><br><span class="line">                 struct fuse_file_info *fi) &#123;</span><br><span class="line">  LOGD(&quot;read: %s&quot;, path);</span><br><span class="line"></span><br><span class="line">  int ret &#x3D; jnifuse::JniFuseFileSystem::getInstance()-&gt;readOper-&gt;call(</span><br><span class="line">      path, buf, size, offset, fi);</span><br><span class="line"></span><br><span class="line">  LOGD(&quot;nread&#x3D;%d&quot;, ret);</span><br><span class="line"></span><br><span class="line">  return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int readdir_wrapper(const char *path, void *buf, fuse_fill_dir_t filler,</span><br><span class="line">                    off_t offset, struct fuse_file_info *fi) &#123;</span><br><span class="line">  LOGD(&quot;readdir: %s&quot;, path);</span><br><span class="line"></span><br><span class="line">  int ret &#x3D; jnifuse::JniFuseFileSystem::getInstance()-&gt;readdirOper-&gt;call(</span><br><span class="line">      path, buf, filler, offset, fi);</span><br><span class="line"></span><br><span class="line">  return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int release_wrapper(const char *path, struct fuse_file_info *fi) &#123;</span><br><span class="line">  return jnifuse::JniFuseFileSystem::getInstance()-&gt;releaseOper-&gt;call(path, fi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int rename_wrapper(const char *oldPath, const char *newPath) &#123;</span><br><span class="line">  return jnifuse::JniFuseFileSystem::getInstance()-&gt;renameOper-&gt;call(oldPath, newPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int rmdir_wrapper(const char *path) &#123;</span><br><span class="line">  return jnifuse::JniFuseFileSystem::getInstance()-&gt;rmdirOper-&gt;call(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int unlink_wrapper(const char *path) &#123;</span><br><span class="line">  return jnifuse::JniFuseFileSystem::getInstance()-&gt;unlinkOper-&gt;call(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int write_wrapper(const char *path, const char *buf, size_t size, off_t off,</span><br><span class="line">                  struct fuse_file_info *fi) &#123;</span><br><span class="line">  return jnifuse::JniFuseFileSystem::getInstance()-&gt;writeOper-&gt;call(</span><br><span class="line">      path, buf, size, off, fi);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5><span id="jnifuse_fsh-amp-jnifuse_fsh">jnifuse_fs.h &amp; jnifuse_fs.h</span></h5><hr>
<p>调用</p>
<p>头文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0</span><br><span class="line"> * (the &quot;License&quot;). You may not use this work except in compliance with the License, which is</span><br><span class="line"> * available at www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * This software is distributed on an &quot;AS IS&quot; basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,</span><br><span class="line"> * either express or implied, as more fully set forth in the License.</span><br><span class="line"> *</span><br><span class="line"> * See the NOTICE file distributed with this work for information regarding copyright ownership.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">#ifndef FUSE_NATIVE_LIBJNIFUSE_FS_H_</span><br><span class="line">#define FUSE_NATIVE_LIBJNIFUSE_FS_H_</span><br><span class="line"></span><br><span class="line">#include &lt;jni.h&gt;</span><br><span class="line"></span><br><span class="line">#include &quot;operation.h&quot;</span><br><span class="line"></span><br><span class="line">namespace jnifuse &#123;</span><br><span class="line"></span><br><span class="line">class ChmodOperation;</span><br><span class="line">class CreateOperation;</span><br><span class="line">class FlushOperation;</span><br><span class="line">class GetattrOperation;</span><br><span class="line">class MkdirOperation;</span><br><span class="line">class OpenOperation;</span><br><span class="line">class Operation;</span><br><span class="line">class ReaddirOperation;</span><br><span class="line">class ReadOperation;</span><br><span class="line">class ReleaseOperation;</span><br><span class="line">class RenameOperation;</span><br><span class="line">class RmdirOperation;</span><br><span class="line">class UnlinkOperation;</span><br><span class="line">class WriteOperation;</span><br><span class="line"></span><br><span class="line">class JniFuseFileSystem &#123;</span><br><span class="line"> private:</span><br><span class="line">  JniFuseFileSystem(JNIEnv *env, jobject obj);</span><br><span class="line">  ~JniFuseFileSystem();</span><br><span class="line"></span><br><span class="line"> public:</span><br><span class="line">  static JniFuseFileSystem *getInstance();</span><br><span class="line">  static void init(JNIEnv *env, jobject obj);</span><br><span class="line">  JNIEnv *getEnv();</span><br><span class="line">  JavaVM *getJVM();</span><br><span class="line">  jobject getFSObj();</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  static JniFuseFileSystem *instance;</span><br><span class="line">  JavaVM *jvm;</span><br><span class="line">  jobject fs;</span><br><span class="line"></span><br><span class="line"> public:</span><br><span class="line">  ChmodOperation *chmodOper;</span><br><span class="line">  CreateOperation *createOper;</span><br><span class="line">  FlushOperation *flushOper;</span><br><span class="line">  GetattrOperation *getattrOper;</span><br><span class="line">  MkdirOperation *mkdirOper;</span><br><span class="line">  OpenOperation *openOper;</span><br><span class="line">  ReadOperation *readOper;</span><br><span class="line">  ReaddirOperation *readdirOper;</span><br><span class="line">  ReleaseOperation *releaseOper;</span><br><span class="line">  RenameOperation *renameOper;</span><br><span class="line">  RmdirOperation *rmdirOper;</span><br><span class="line">  UnlinkOperation *unlinkOper;</span><br><span class="line">  WriteOperation *writeOper;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  &#x2F;&#x2F; namespace jnifuse</span><br><span class="line"></span><br><span class="line">#endif  &#x2F;&#x2F; FUSE_NATIVE_LIBJNIFUSE_FS_H_</span><br></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0</span><br><span class="line"> * (the &quot;License&quot;). You may not use this work except in compliance with the License, which is</span><br><span class="line"> * available at www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * This software is distributed on an &quot;AS IS&quot; basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,</span><br><span class="line"> * either express or implied, as more fully set forth in the License.</span><br><span class="line"> *</span><br><span class="line"> * See the NOTICE file distributed with this work for information regarding copyright ownership.</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">#include &quot;jnifuse_fs.h&quot;</span><br><span class="line"></span><br><span class="line">#include &lt;assert.h&gt;</span><br><span class="line">#include &lt;errno.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;fuse.h&gt;</span><br><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">#include &lt;pthread.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">#include &quot;debug.h&quot;</span><br><span class="line"></span><br><span class="line">namespace jnifuse &#123;</span><br><span class="line"></span><br><span class="line">struct ThreadData &#123;</span><br><span class="line">  JavaVM *attachedJVM;</span><br><span class="line">  JNIEnv *attachedEnv;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static pthread_key_t jffs_threadKey;</span><br><span class="line"></span><br><span class="line">static void thread_data_free(void *ptr) &#123;</span><br><span class="line">  ThreadData *td &#x3D; (ThreadData *)ptr;</span><br><span class="line">  if (td-&gt;attachedJVM !&#x3D; nullptr) &#123;</span><br><span class="line">    td-&gt;attachedJVM-&gt;DetachCurrentThread();</span><br><span class="line">  &#125;</span><br><span class="line">  delete td;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JniFuseFileSystem *JniFuseFileSystem::instance &#x3D; nullptr;</span><br><span class="line"></span><br><span class="line">JniFuseFileSystem::JniFuseFileSystem(JNIEnv *env, jobject obj) &#123;</span><br><span class="line">  env-&gt;GetJavaVM(&amp;this-&gt;jvm);</span><br><span class="line">  this-&gt;fs &#x3D; env-&gt;NewGlobalRef(obj);</span><br><span class="line"></span><br><span class="line">  this-&gt;chmodOper &#x3D; new ChmodOperation(this);</span><br><span class="line">  this-&gt;createOper &#x3D; new CreateOperation(this);</span><br><span class="line">  this-&gt;flushOper &#x3D; new FlushOperation(this);</span><br><span class="line">  this-&gt;getattrOper &#x3D; new GetattrOperation(this);</span><br><span class="line">  this-&gt;mkdirOper &#x3D; new MkdirOperation(this);</span><br><span class="line">  this-&gt;openOper &#x3D; new OpenOperation(this);</span><br><span class="line">  this-&gt;readOper &#x3D; new ReadOperation(this);</span><br><span class="line">  this-&gt;readdirOper &#x3D; new ReaddirOperation(this);</span><br><span class="line">  this-&gt;releaseOper &#x3D; new ReleaseOperation(this);</span><br><span class="line">  this-&gt;renameOper &#x3D; new RenameOperation(this);</span><br><span class="line">  this-&gt;rmdirOper &#x3D; new RmdirOperation(this);</span><br><span class="line">  this-&gt;unlinkOper &#x3D; new UnlinkOperation(this);</span><br><span class="line">  this-&gt;writeOper &#x3D; new WriteOperation(this);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JniFuseFileSystem::~JniFuseFileSystem() &#123;</span><br><span class="line">  delete this-&gt;chmodOper;</span><br><span class="line">  delete this-&gt;createOper;</span><br><span class="line">  delete this-&gt;flushOper;</span><br><span class="line">  delete this-&gt;getattrOper;</span><br><span class="line">  delete this-&gt;mkdirOper;</span><br><span class="line">  delete this-&gt;openOper;</span><br><span class="line">  delete this-&gt;readOper;</span><br><span class="line">  delete this-&gt;readdirOper;</span><br><span class="line">  delete this-&gt;releaseOper;</span><br><span class="line">  delete this-&gt;renameOper;</span><br><span class="line">  delete this-&gt;rmdirOper;</span><br><span class="line">  delete this-&gt;unlinkOper;</span><br><span class="line">  delete this-&gt;writeOper;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void JniFuseFileSystem::init(JNIEnv *env, jobject obj) &#123;</span><br><span class="line">  if (instance !&#x3D; nullptr) &#123;</span><br><span class="line">    LOGE(&quot;you cant initialize more than once&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  pthread_key_create(&amp;jffs_threadKey, thread_data_free);</span><br><span class="line">  instance &#x3D; new JniFuseFileSystem(env, obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JniFuseFileSystem *JniFuseFileSystem::getInstance() &#123;</span><br><span class="line">  if (instance &#x3D;&#x3D; nullptr) &#123;</span><br><span class="line">    LOGE(&quot;you must initialize before using JniFuseFileSystem&quot;);</span><br><span class="line">    exit(-1);</span><br><span class="line">  &#125;</span><br><span class="line">  return instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEnv *JniFuseFileSystem::getEnv() &#123;</span><br><span class="line">  ThreadData *td &#x3D; (ThreadData *)pthread_getspecific(jffs_threadKey);</span><br><span class="line">  if (td &#x3D;&#x3D; nullptr) &#123;</span><br><span class="line">    td &#x3D; new ThreadData();</span><br><span class="line">    td-&gt;attachedJVM &#x3D; this-&gt;jvm;</span><br><span class="line">    this-&gt;jvm-&gt;AttachCurrentThreadAsDaemon((void **)&amp;td-&gt;attachedEnv, nullptr);</span><br><span class="line">    pthread_setspecific(jffs_threadKey, td);</span><br><span class="line">    return td-&gt;attachedEnv;</span><br><span class="line">  &#125;</span><br><span class="line">  return td-&gt;attachedEnv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JavaVM *JniFuseFileSystem::getJVM() &#123; return this-&gt;jvm; &#125;</span><br><span class="line"></span><br><span class="line">jobject JniFuseFileSystem::getFSObj() &#123; return this-&gt;fs; &#125;</span><br><span class="line"></span><br><span class="line">&#125;  &#x2F;&#x2F; namespace jnifuse</span><br></pre></td></tr></table></figure>



<h2><span id="suse">SUSE</span></h2><p>FUSE (Filesystem in Userspace) is an interface for userspace programs to export a filesystem to the Linux kernel. The FUSE project consists of two components: the <em>fuse</em> kernel module (maintained in the regular kernel repositories) and the <em>libfuse</em> userspace library. libfuse provides the reference implementation for communicating with the FUSE kernel module.</p>
<p>A FUSE file system is typically implemented as a standalone application that links with libfuse. libfuse provides functions to mount the file system, unmount it, read requests from the kernel, and send responses back.</p>
<p>libfuse offers two APIs: a “high-level”, synchronous API, and a “low-level” asynchronous API. In both cases, incoming requests from the kernel are passed to the main program using callbacks. When using the high-level API, the callbacks may work with file names and paths instead of inodes, and processing of a request finishes when the callback function returns. When using the low-level API, the callbacks must work with inodes and responses must be sent explicitly using a separate set of API functions.</p>
<p>The high-level API that is primarily specified in fuse.h. The low-level API that is primarily documented in fuse_lowlevel.h.</p>
<p>libfuse源码查看</p>
<p><a href="http://libfuse.github.io/doxygen/files.html" target="_blank" rel="noopener">http://libfuse.github.io/doxygen/files.html</a></p>
<p>目录结构</p>
<p>-example</p>
<p>-include</p>
<p>-lib</p>
<p>-test</p>
<p>-util</p>
<p>lib/mount.c</p>
<p>lib/helper.c</p>
<p>lib/fuse.c</p>
<p>util/fusermount.c</p>
<h3><span id="example-helloc">Example-hello.c</span></h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall hello.c &#96;pkg-config fuse3 --cflags --libs&#96; -o hello</span><br></pre></td></tr></table></figure>



<p>hello.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">  FUSE: Filesystem in Userspace</span><br><span class="line">  Copyright (C) 2001-2007  Miklos Szeredi &lt;miklos@szeredi.hu&gt;</span><br><span class="line">  This program can be distributed under the terms of the GNU GPLv2.</span><br><span class="line">  See the file COPYING.</span><br><span class="line">*&#x2F;</span><br><span class="line">#define FUSE_USE_VERSION 31</span><br><span class="line">#include &lt;fuse.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;errno.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;stddef.h&gt;</span><br><span class="line">#include &lt;assert.h&gt;</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Command line options</span><br><span class="line"> *</span><br><span class="line"> * We can&#39;t set default values for the char* fields here because</span><br><span class="line"> * fuse_opt_parse would attempt to free() them when the user specifies</span><br><span class="line"> * different values on the command line.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static struct options &#123;</span><br><span class="line">        const char *filename;</span><br><span class="line">        const char *contents;</span><br><span class="line">        int show_help;</span><br><span class="line">&#125; options;</span><br><span class="line">#define OPTION(t, p)                           \</span><br><span class="line">    &#123; t, offsetof(struct options, p), 1 &#125;</span><br><span class="line">static const struct fuse_opt option_spec[] &#x3D; &#123;</span><br><span class="line">        OPTION(&quot;--name&#x3D;%s&quot;, filename),</span><br><span class="line">        OPTION(&quot;--contents&#x3D;%s&quot;, contents),</span><br><span class="line">        OPTION(&quot;-h&quot;, show_help),</span><br><span class="line">        OPTION(&quot;--help&quot;, show_help),</span><br><span class="line">        FUSE_OPT_END</span><br><span class="line">&#125;;</span><br><span class="line">static void *hello_init(struct fuse_conn_info *conn,</span><br><span class="line">                        struct fuse_config *cfg)</span><br><span class="line">&#123;</span><br><span class="line">        (void) conn;</span><br><span class="line">        cfg-&gt;kernel_cache &#x3D; 1;</span><br><span class="line">        return NULL;</span><br><span class="line">&#125;</span><br><span class="line">static int hello_getattr(const char *path, struct stat *stbuf,</span><br><span class="line">                         struct fuse_file_info *fi)</span><br><span class="line">&#123;</span><br><span class="line">        (void) fi;</span><br><span class="line">        int res &#x3D; 0;</span><br><span class="line">        memset(stbuf, 0, sizeof(struct stat));</span><br><span class="line">        if (strcmp(path, &quot;&#x2F;&quot;) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                stbuf-&gt;st_mode &#x3D; S_IFDIR | 0755;</span><br><span class="line">                stbuf-&gt;st_nlink &#x3D; 2;</span><br><span class="line">        &#125; else if (strcmp(path+1, options.filename) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                stbuf-&gt;st_mode &#x3D; S_IFREG | 0444;</span><br><span class="line">                stbuf-&gt;st_nlink &#x3D; 1;</span><br><span class="line">                stbuf-&gt;st_size &#x3D; strlen(options.contents);</span><br><span class="line">        &#125; else</span><br><span class="line">                res &#x3D; -ENOENT;</span><br><span class="line">        return res;</span><br><span class="line">&#125;</span><br><span class="line">static int hello_readdir(const char *path, void *buf, fuse_fill_dir_t filler,</span><br><span class="line">                         off_t offset, struct fuse_file_info *fi,</span><br><span class="line">                         enum fuse_readdir_flags flags)</span><br><span class="line">&#123;</span><br><span class="line">        (void) offset;</span><br><span class="line">        (void) fi;</span><br><span class="line">        (void) flags;</span><br><span class="line">        if (strcmp(path, &quot;&#x2F;&quot;) !&#x3D; 0)</span><br><span class="line">                return -ENOENT;</span><br><span class="line">        filler(buf, &quot;.&quot;, NULL, 0, 0);</span><br><span class="line">        filler(buf, &quot;..&quot;, NULL, 0, 0);</span><br><span class="line">        filler(buf, options.filename, NULL, 0, 0);</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line">static int hello_open(const char *path, struct fuse_file_info *fi)</span><br><span class="line">&#123;</span><br><span class="line">        if (strcmp(path+1, options.filename) !&#x3D; 0)</span><br><span class="line">                return -ENOENT;</span><br><span class="line">        if ((fi-&gt;flags &amp; O_ACCMODE) !&#x3D; O_RDONLY)</span><br><span class="line">                return -EACCES;</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line">static int hello_read(const char *path, char *buf, size_t size, off_t offset,</span><br><span class="line">                      struct fuse_file_info *fi)</span><br><span class="line">&#123;</span><br><span class="line">        size_t len;</span><br><span class="line">        (void) fi;</span><br><span class="line">        if(strcmp(path+1, options.filename) !&#x3D; 0)</span><br><span class="line">                return -ENOENT;</span><br><span class="line">        len &#x3D; strlen(options.contents);</span><br><span class="line">        if (offset &lt; len) &#123;</span><br><span class="line">                if (offset + size &gt; len)</span><br><span class="line">                        size &#x3D; len - offset;</span><br><span class="line">                memcpy(buf, options.contents + offset, size);</span><br><span class="line">        &#125; else</span><br><span class="line">                size &#x3D; 0;</span><br><span class="line">        return size;</span><br><span class="line">&#125;</span><br><span class="line">static const struct fuse_operations hello_oper &#x3D; &#123;</span><br><span class="line">        .init           &#x3D; hello_init,</span><br><span class="line">        .getattr        &#x3D; hello_getattr,</span><br><span class="line">        .readdir        &#x3D; hello_readdir,</span><br><span class="line">        .open           &#x3D; hello_open,</span><br><span class="line">        .read           &#x3D; hello_read,</span><br><span class="line">&#125;;</span><br><span class="line">static void show_help(const char *progname)</span><br><span class="line">&#123;</span><br><span class="line">        printf(&quot;usage: %s [options] &lt;mountpoint&gt;\n\n&quot;, progname);</span><br><span class="line">        printf(&quot;File-system specific options:\n&quot;</span><br><span class="line">               &quot;    --name&#x3D;&lt;s&gt;          Name of the \&quot;hello\&quot; file\n&quot;</span><br><span class="line">               &quot;                        (default: \&quot;hello\&quot;)\n&quot;</span><br><span class="line">               &quot;    --contents&#x3D;&lt;s&gt;      Contents \&quot;hello\&quot; file\n&quot;</span><br><span class="line">               &quot;                        (default \&quot;Hello, World!\\n\&quot;)\n&quot;</span><br><span class="line">               &quot;\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">        int ret;</span><br><span class="line">        struct fuse_args args &#x3D; FUSE_ARGS_INIT(argc, argv);</span><br><span class="line">        &#x2F;* Set defaults -- we have to use strdup so that</span><br><span class="line">           fuse_opt_parse can free the defaults if other</span><br><span class="line">           values are specified *&#x2F;</span><br><span class="line">        options.filename &#x3D; strdup(&quot;hello&quot;);</span><br><span class="line">        options.contents &#x3D; strdup(&quot;Hello World!\n&quot;);</span><br><span class="line">        &#x2F;* Parse options *&#x2F;</span><br><span class="line">        if (fuse_opt_parse(&amp;args, &amp;options, option_spec, NULL) &#x3D;&#x3D; -1)</span><br><span class="line">                return 1;</span><br><span class="line">        &#x2F;* When --help is specified, first print our own file-system</span><br><span class="line">           specific help text, then signal fuse_main to show</span><br><span class="line">           additional help (by adding &#96;--help&#96; to the options again)</span><br><span class="line">           without usage: line (by setting argv[0] to the empty</span><br><span class="line">           string) *&#x2F;</span><br><span class="line">        if (options.show_help) &#123;</span><br><span class="line">                show_help(argv[0]);</span><br><span class="line">                assert(fuse_opt_add_arg(&amp;args, &quot;--help&quot;) &#x3D;&#x3D; 0);</span><br><span class="line">                args.argv[0][0] &#x3D; &#39;\0&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">        ret &#x3D; fuse_main(args.argc, args.argv, &amp;hello_oper, NULL);</span><br><span class="line">        fuse_opt_free_args(&amp;args);</span><br><span class="line">        return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/07/06/%E4%BB%8EJNI%E5%88%B0JNI-FUSE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/06/%E4%BB%8EJNI%E5%88%B0JNI-FUSE/" class="post-title-link" itemprop="url">从JNI到JNI-FUSE</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-06 00:00:00 / 修改时间：21:34:39" itemprop="dateCreated datePublished" datetime="2021-07-06T00:00:00+08:00">2021-07-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JNI/" itemprop="url" rel="index"><span itemprop="name">JNI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->

<ul>
<li><a href="#jni-简介">JNI 简介</a><ul>
<li><a href="#链接方式">链接方式</a><ul>
<li><a href="#让-java-虚拟机自动查找符合默认命名规范的-c-函数并且链接起来">让 Java 虚拟机自动查找符合默认命名规范的 C 函数，并且链接起来</a></li>
<li><a href="#在-c-代码中主动链接">在 C 代码中主动链接</a></li>
</ul>
</li>
<li><a href="#本地实现">本地实现</a></li>
<li><a href="#java-jni调用示例">Java JNI调用示例</a></li>
<li><a href="#c调用java">C调用Java</a></li>
</ul>
</li>
<li><a href="#jni-fuse">JNI-FUSE</a><ul>
<li><a href="#从mount挂在说起">从mount挂在说起</a></li>
<li><a href="#文件系统">文件系统</a></li>
<li><a href="#fuse">FUSE</a><ul>
<li><a href="#请求">请求</a></li>
<li><a href="#响应">响应</a></li>
<li><a href="#devfuse">/dev/fuse</a></li>
<li><a href="#使用">使用</a></li>
</ul>
</li>
<li><a href="#java开发fuse文件系统">Java开发Fuse文件系统</a></li>
</ul>
</li>
<li><a href="#alluxio-jni-fuse">Alluxio JNI Fuse</a></li>
</ul>
<!-- tocstop -->

<hr>
<h2><span id="jni-简介">JNI 简介</span></h2><p>借助 Java 虚拟机的 Java Native Interface（JNI）机制，我们可以跨语言的调用。</p>
<p>在Java中，使用native关键字标识本地方法，且该方法没有方法体。例如Java 的Object类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Object</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">registerNatives</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        registerNatives();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> Class&lt;?&gt; getClass();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">this</span> == obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">native</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> getClass().getName() + <span class="string">"@"</span> + Integer.toHexString(hashCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">notifyAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">wait</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">wait</span><span class="params">(<span class="keyword">long</span> timeout, <span class="keyword">int</span> nanos)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"timeout value is negative"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nanos &lt; <span class="number">0</span> || nanos &gt; <span class="number">999999</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">				<span class="string">"nanosecond timeout value out of range"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nanos &gt;= <span class="number">500000</span> || (nanos != <span class="number">0</span> &amp;&amp; timeout == <span class="number">0</span>)) &#123;</span><br><span class="line">	    timeout++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wait(timeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">wait</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">	wait(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在调用 native 方法前，Java 虚拟机需要将该 native 方法链接至对应的 C 函数上。</p>
<h3><span id="链接方式">链接方式</span></h3><hr>
<h4><span id="让-java-虚拟机自动查找符合默认命名规范的-c-函数并且链接起来">让 Java 虚拟机自动查找符合默认命名规范的 C 函数，并且链接起来</span></h4><hr>
<p>第一种是让 Java 虚拟机自动查找符合默认命名规范的 C 函数，并且链接起来。采用javac -h命令，便可以根据 Java 程序中的 native 方法声明，自动生成包含符合命名规范的 C 函数的头文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.lemon.jni;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JniTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当前目录</p>
<p>javac -h . io/lemon/jni/JniTest.java</p>
<p>io_lemon_jni_JniTest.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class io_lemon_jni_JniTest */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_io_lemon_jni_JniTest</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_io_lemon_jni_JniTest</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     io_lemon_jni_JniTest</span></span><br><span class="line"><span class="comment"> * Method:    test</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_io_lemon_jni_JniTest_test</span><br><span class="line">  (JNIEnv *, jclass);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<p>命名规范：native 方法对应的 C 函数都需要以Java_为前缀，之后跟着完整的包名和方法名由于 C 函数名不支持/字符，因此我们需要将/转换为_下划线，而原本方法名中的_符号，则需要转换为_下划线1。当某个类出现重载的 native 方法时，Java 虚拟机还会将参数类型纳入自动链接对象的考虑范围之中。具体的做法便是在前面 C 函数名的基础上，追加__以及方法描述符作为后缀。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package io.lemon.jni;</span><br><span class="line"></span><br><span class="line">public class JniTest &#123;</span><br><span class="line"></span><br><span class="line">    public static native void test();</span><br><span class="line"></span><br><span class="line">    public static native void test(String s);</span><br><span class="line"></span><br><span class="line">    public static native void test(String s, int a);</span><br><span class="line"></span><br><span class="line">    public static native String foo();</span><br><span class="line"></span><br><span class="line">    public native String hello(String s, Long a);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>io_lemon_jni_JniTest.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class io_lemon_jni_JniTest */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_io_lemon_jni_JniTest</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_io_lemon_jni_JniTest</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     io_lemon_jni_JniTest</span></span><br><span class="line"><span class="comment"> * Method:    test</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_io_lemon_jni_JniTest_test__</span><br><span class="line">  (JNIEnv *, jclass);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     io_lemon_jni_JniTest</span></span><br><span class="line"><span class="comment"> * Method:    test</span></span><br><span class="line"><span class="comment"> * Signature: (Ljava/lang/String;)V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_io_lemon_jni_JniTest_test__Ljava_lang_String_2</span><br><span class="line">  (JNIEnv *, jclass, jstring);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     io_lemon_jni_JniTest</span></span><br><span class="line"><span class="comment"> * Method:    test</span></span><br><span class="line"><span class="comment"> * Signature: (Ljava/lang/String;I)V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_io_lemon_jni_JniTest_test__Ljava_lang_String_2I</span><br><span class="line">  (JNIEnv *, jclass, jstring, jint);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     io_lemon_jni_JniTest</span></span><br><span class="line"><span class="comment"> * Method:    foo</span></span><br><span class="line"><span class="comment"> * Signature: ()Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jstring JNICALL Java_io_lemon_jni_JniTest_foo</span><br><span class="line">  (JNIEnv *, jclass);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     io_lemon_jni_JniTest</span></span><br><span class="line"><span class="comment"> * Method:    hello</span></span><br><span class="line"><span class="comment"> * Signature: (Ljava/lang/String;Ljava/lang/Long;)Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jstring JNICALL Java_io_lemon_jni_JniTest_hello</span><br><span class="line">  (JNIEnv *, jobject, jstring, jobject);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<h4><span id="在-c-代码中主动链接">在 C 代码中主动链接</span></h4><hr>
<p>这种链接方式对 C 函数名没有要求。通常我们会使用一个名为registerNatives的 native 方法，并按照第一种链接方式定义所能自动链接的 C 函数。在该 C 函数中，我们将手动链接该类的其他 native 方法。当使用第二种方式进行链接时，我们需要在其他 native 方法被调用之前完成链接工作。因此，我们往往会在类的初始化方法里调用该registerNatives方法。</p>
<h3><span id="本地实现">本地实现</span></h3><hr>
<p>JniTest.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package io.lemon.jni;</span><br><span class="line"></span><br><span class="line">public class JniTest &#123;</span><br><span class="line"></span><br><span class="line">    public static native void test();</span><br><span class="line">    </span><br><span class="line">    public static void main(String []args) &#123;</span><br><span class="line">        try &#123;      </span><br><span class="line">            System.loadLibrary(&quot;jnitest&quot;);    </span><br><span class="line">        &#125; catch (UnsatisfiedLinkError e) &#123;      </span><br><span class="line">            e.printStackTrace();      </span><br><span class="line">            System.exit(1);    </span><br><span class="line">        &#125;</span><br><span class="line">        test();</span><br><span class="line">        System.out.println(&quot;Hello World&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>jnitest.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* DO NOT EDIT THIS FILE - it is machine generated *&#x2F;</span><br><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">&#x2F;* Header for class JniTest *&#x2F;</span><br><span class="line"></span><br><span class="line">#ifndef _Included_JniTest</span><br><span class="line">#define _Included_JniTest</span><br><span class="line">#ifdef __cplusplus</span><br><span class="line">extern &quot;C&quot; &#123;</span><br><span class="line">#endif</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Class:     JniTest</span><br><span class="line"> * Method:    test</span><br><span class="line"> * Signature: ()V</span><br><span class="line"> *&#x2F;</span><br><span class="line">JNIEXPORT void JNICALL Java_JniTest_test</span><br><span class="line">  (JNIEnv *, jclass);</span><br><span class="line"></span><br><span class="line">#ifdef __cplusplus</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &quot;JniTest.h&quot;</span><br><span class="line"></span><br><span class="line">JNIEXPORT void JNICALL Java_JniTest_test</span><br><span class="line">  (JNIEnv *env, jobject thisObject) &#123;</span><br><span class="line">  printf(&quot;Hello, World\n&quot;);</span><br><span class="line">  return;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"io_lemon_jni_JniTest.h"</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_io_lemon_jni_JniTest_test__</span><br><span class="line">  (JNIEnv *, jclass) &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Hello, World\n"</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>通过 gcc 命令将其编译成为动态链接库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -I $JAVA_HOME&#x2F;include -I $JAVA_HOME&#x2F;include&#x2F;linux -fPIC  -c jnitest.c </span><br><span class="line">gcc -shared jnitest.o -o jnitest.so</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path&#x3D;&#x2F;home&#x2F;jni JniTest</span><br></pre></td></tr></table></figure>



<h3><span id="java-jni调用示例">Java JNI调用示例</span></h3><hr>
<p>cd /home/jni</p>
<p>JniTest.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class JniTest &#123;</span><br><span class="line"></span><br><span class="line">    public static native void test();</span><br><span class="line">    </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;      </span><br><span class="line">            System.load(&quot;&#x2F;home&#x2F;jni&#x2F;jnitest.so&quot;);    </span><br><span class="line">        &#125; catch (UnsatisfiedLinkError e) &#123;      </span><br><span class="line">            e.printStackTrace();      </span><br><span class="line">            System.exit(1);    </span><br><span class="line">        &#125;</span><br><span class="line">        test();</span><br><span class="line">        System.out.println(&quot;Hello World&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -h .  JniTest.java</span><br></pre></td></tr></table></figure>



<p>JniTest.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* DO NOT EDIT THIS FILE - it is machine generated *&#x2F;</span><br><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">&#x2F;* Header for class JniTest *&#x2F;</span><br><span class="line"></span><br><span class="line">#ifndef _Included_JniTest</span><br><span class="line">#define _Included_JniTest</span><br><span class="line">#ifdef __cplusplus</span><br><span class="line">extern &quot;C&quot; &#123;</span><br><span class="line">#endif</span><br><span class="line">&#x2F;*</span><br><span class="line"> * Class:     JniTest</span><br><span class="line"> * Method:    test</span><br><span class="line"> * Signature: ()V</span><br><span class="line"> *&#x2F;</span><br><span class="line">JNIEXPORT void JNICALL Java_JniTest_test</span><br><span class="line">  (JNIEnv *, jclass);</span><br><span class="line"></span><br><span class="line">#ifdef __cplusplus</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>



<p>jnitest.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &quot;JniTest.h&quot;</span><br><span class="line"></span><br><span class="line">JNIEXPORT void JNICALL Java_JniTest_test</span><br><span class="line">  (JNIEnv *env, jobject thisObject) &#123;</span><br><span class="line">  printf(&quot;Hello, World JNI\n&quot;);</span><br><span class="line">  return;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -I $JAVA_HOME&#x2F;include -I $JAVA_HOME&#x2F;include&#x2F;linux -fPIC  -c jnitest.c </span><br><span class="line">gcc -shared jnitest.o -o jnitest.so</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.library.path&#x3D;&#x2F;home&#x2F;jni JniTest</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">java JniTest</span><br><span class="line"></span><br><span class="line">Hello, World JNI</span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>



<p>gcc 与 g++ 分别是 gnu 的 c &amp; c++ 编译器</p>
<p><strong>-o</strong></p>
<p>制定目标名称, 默认的时候, gcc 编译出来的文件是 a.out, 很难听, 如果你和我有同感，改掉它, 哈哈</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>-shared</td>
<td>生成共享目标文件。通常用在建立共享库时。</td>
</tr>
<tr>
<td>-o FILE</td>
<td>生成指定的输出文件。用在生成可执行文件时。</td>
</tr>
<tr>
<td>-I $JAVA_HOME/include -I $JAVA_HOME/include/linux</td>
<td>表示将$JAVA_HOME/include目录作为第一个寻找头文件的目录</td>
</tr>
</tbody></table>
<p>修改程序在，通过System.loadLibrary(“jnites”)方法来加载动态链接库jnitest.so</p>
<p>可以使用java.library.path系统属性指定库的路径</p>
<h3><span id="c调用java">C调用Java</span></h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F; foo.c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &quot;org_example_Foo.h&quot;</span><br><span class="line"></span><br><span class="line">JNIEXPORT void JNICALL Java_org_example_Foo_bar__Ljava_lang_String_2Ljava_lang_Object_2</span><br><span class="line">  (JNIEnv *env, jobject thisObject, jstring str, jobject obj) &#123;</span><br><span class="line">  jclass cls &#x3D; (*env)-&gt;GetObjectClass(env, thisObject);</span><br><span class="line">  jfieldID fieldID &#x3D; (*env)-&gt;GetFieldID(env, cls, &quot;j&quot;, &quot;I&quot;);</span><br><span class="line">  if((*env)-&gt;ExceptionOccurred(env)) &#123;</span><br><span class="line">    printf(&quot;Exception!\n&quot;);</span><br><span class="line">    (*env)-&gt;ExceptionClear(env);</span><br><span class="line">  &#125;</span><br><span class="line">  fieldID &#x3D; (*env)-&gt;GetFieldID(env, cls, &quot;i&quot;, &quot;I&quot;);</span><br><span class="line">  jint value &#x3D; (*env)-&gt;GetIntField(env, thisObject, fieldID);</span><br><span class="line">  &#x2F;&#x2F; we should put an exception guard here as well.</span><br><span class="line">  printf(&quot;Hello, World 0x%x\n&quot;, value);</span><br><span class="line">  return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2><span id="jni-fuse">JNI-FUSE</span></h2><p>FUSE(Filesystem in user space)，顾名思义，是用户空间文件系统。</p>
<h3><span id="从mount挂在说起">从mount挂在说起</span></h3><p>Linux使用mount命令查看系统挂在了哪些文件系统</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@node25 home]# mount</span><br><span class="line">sysfs on &#x2F;sys type sysfs (rw,nosuid,nodev,noexec,relatime,seclabel)</span><br><span class="line">proc on &#x2F;proc type proc (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">devtmpfs on &#x2F;dev type devtmpfs (rw,nosuid,seclabel,size&#x3D;2001012k,nr_inodes&#x3D;500253,mode&#x3D;755)</span><br><span class="line">securityfs on &#x2F;sys&#x2F;kernel&#x2F;security type securityfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">tmpfs on &#x2F;dev&#x2F;shm type tmpfs (rw,nosuid,nodev,seclabel)</span><br><span class="line">devpts on &#x2F;dev&#x2F;pts type devpts (rw,nosuid,noexec,relatime,seclabel,gid&#x3D;5,mode&#x3D;620,ptmxmode&#x3D;000)</span><br><span class="line">tmpfs on &#x2F;run type tmpfs (rw,nosuid,nodev,seclabel,mode&#x3D;755)</span><br><span class="line">tmpfs on &#x2F;sys&#x2F;fs&#x2F;cgroup type tmpfs (ro,nosuid,nodev,noexec,seclabel,mode&#x3D;755)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;systemd type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,xattr,release_agent&#x3D;&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;systemd-cgroups-agent,name&#x3D;systemd)</span><br><span class="line">pstore on &#x2F;sys&#x2F;fs&#x2F;pstore type pstore (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,net_prio,net_cls)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,hugetlb)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,memory)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;pids type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,pids)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;devices type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,devices)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;blkio type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,blkio)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;freezer type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,freezer)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,cpuacct,cpu)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,cpuset)</span><br><span class="line">cgroup on &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,perf_event)</span><br><span class="line">configfs on &#x2F;sys&#x2F;kernel&#x2F;config type configfs (rw,relatime)</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root on &#x2F; type xfs (rw,relatime,seclabel,attr2,inode64,noquota)</span><br><span class="line">selinuxfs on &#x2F;sys&#x2F;fs&#x2F;selinux type selinuxfs (rw,relatime)</span><br><span class="line">systemd-1 on &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;binfmt_misc type autofs (rw,relatime,fd&#x3D;22,pgrp&#x3D;1,timeout&#x3D;0,minproto&#x3D;5,maxproto&#x3D;5,direct,pipe_ino&#x3D;25095)</span><br><span class="line">hugetlbfs on &#x2F;dev&#x2F;hugepages type hugetlbfs (rw,relatime,seclabel)</span><br><span class="line">mqueue on &#x2F;dev&#x2F;mqueue type mqueue (rw,relatime,seclabel)</span><br><span class="line">debugfs on &#x2F;sys&#x2F;kernel&#x2F;debug type debugfs (rw,relatime)</span><br><span class="line">&#x2F;dev&#x2F;sda1 on &#x2F;boot type xfs (rw,relatime,seclabel,attr2,inode64,noquota)</span><br><span class="line">tmpfs on &#x2F;run&#x2F;user&#x2F;0 type tmpfs (rw,nosuid,nodev,relatime,seclabel,size&#x3D;402636k,mode&#x3D;700)</span><br><span class="line">[root@node25 home]#</span><br></pre></td></tr></table></figure>



<p>sysfs on /sys type sysfs (ro,nosuid,nodev,noexec,relatime)</p>
<ul>
<li><code>sysfs</code>：文件系统<strong>名称</strong>；</li>
<li><code>/sys</code> ：文件系统目录<strong>挂载点</strong>；</li>
<li><code>sysfs</code>：文件系统<strong>类型</strong></li>
<li><code>(ro,nosuid,nodev,noexec,relatime)</code>：挂载参数</li>
</ul>
<p>挂在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t ext4 &#x2F;dev&#x2F;sdb1 &#x2F;mnt&#x2F;</span><br></pre></td></tr></table></figure>

<p>卸载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount &#x2F;mnt</span><br></pre></td></tr></table></figure>



<p>df命令也可以查看</p>
<ul>
<li>-T 参数能够让你看到所有的文件系统实例的类型；</li>
<li>-h 参数能够以更符合人类的友好的形式展示数据；</li>
<li>-a 参数展示所有的文件系统，包括 0 Blocks 的文件系统（默认是会过滤掉的）；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@node25 home]# df -Tha</span><br><span class="line">Filesystem              Type        Size  Used Avail Use% Mounted on</span><br><span class="line">rootfs                  -              -     -     -    - &#x2F;</span><br><span class="line">sysfs                   sysfs          0     0     0    - &#x2F;sys</span><br><span class="line">proc                    proc           0     0     0    - &#x2F;proc</span><br><span class="line">devtmpfs                devtmpfs    2.0G     0  2.0G   0% &#x2F;dev</span><br><span class="line">securityfs              securityfs     0     0     0    - &#x2F;sys&#x2F;kernel&#x2F;security</span><br><span class="line">tmpfs                   tmpfs       2.0G     0  2.0G   0% &#x2F;dev&#x2F;shm</span><br><span class="line">devpts                  devpts         0     0     0    - &#x2F;dev&#x2F;pts</span><br><span class="line">tmpfs                   tmpfs       2.0G   12M  2.0G   1% &#x2F;run</span><br><span class="line">tmpfs                   tmpfs       2.0G     0  2.0G   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;systemd</span><br><span class="line">pstore                  pstore         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;pstore</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;net_cls,net_prio</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;hugetlb</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;memory</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;pids</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;devices</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;blkio</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;freezer</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu,cpuacct</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuset</span><br><span class="line">cgroup                  cgroup         0     0     0    - &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;perf_event</span><br><span class="line">configfs                configfs       0     0     0    - &#x2F;sys&#x2F;kernel&#x2F;config</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root xfs          17G   15G  2.2G  88% &#x2F;</span><br><span class="line">selinuxfs               selinuxfs      0     0     0    - &#x2F;sys&#x2F;fs&#x2F;selinux</span><br><span class="line">systemd-1               autofs         0     0     0    - &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;binfmt_misc</span><br><span class="line">hugetlbfs               hugetlbfs      0     0     0    - &#x2F;dev&#x2F;hugepages</span><br><span class="line">mqueue                  mqueue         0     0     0    - &#x2F;dev&#x2F;mqueue</span><br><span class="line">debugfs                 debugfs        0     0     0    - &#x2F;sys&#x2F;kernel&#x2F;debug</span><br><span class="line">&#x2F;dev&#x2F;sda1               xfs        1014M  133M  882M  14% &#x2F;boot</span><br><span class="line">tmpfs                   tmpfs       394M     0  394M   0% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line">[root@node25 home]#</span><br></pre></td></tr></table></figure>



<p>文件系统挂载可以通过 <code>mount</code> 命令直接挂载，但是 <code>mount</code> 命令挂载并没有持久化，关机重启就没了。<strong>所以想要关机重启之后，还能自动挂载到指定目录，那么就要把挂载规则写到 <code>/etc/fstab</code> 文件中</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node25 home]# cat &#x2F;etc&#x2F;fstab </span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># &#x2F;etc&#x2F;fstab</span><br><span class="line"># Created by anaconda on Thu Apr  2 21:53:10 2020</span><br><span class="line">#</span><br><span class="line"># Accessible filesystems, by reference, are maintained under &#39;&#x2F;dev&#x2F;disk&#39;</span><br><span class="line"># See man pages fstab(5), findfs(8), mount(8) and&#x2F;or blkid(8) for more info</span><br><span class="line">#</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root &#x2F;                       xfs     defaults        0 0</span><br><span class="line">UUID&#x3D;cb5a58dc-1df2-4de4-8b27-68adee337a72 &#x2F;boot                   xfs     defaults        0 0</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-swap swap                    swap    defaults        0 0</span><br><span class="line">[root@node25 home]#</span><br></pre></td></tr></table></figure>

<p>&lt;设备标识&gt;    &lt;挂载目录&gt;     &lt;文件系统类型&gt;  &lt;挂载参数&gt;       &lt;dump选项&gt; &lt;fsck选项&gt;</p>
<p>从左到右参数拆解：</p>
<ul>
<li><strong>设备标识</strong>：能够标识到唯一的文件系统所在的设备，这里可以是设备路径，也可以是 LABEL，或者 UUID；</li>
<li><strong>挂载目录</strong>：文件系统挂载的目录点；</li>
<li><strong>文件系统类型</strong>：比如 ext4，ext2，xfs 之类的；</li>
<li><strong>挂载参数</strong>：可以填 defaults，也可以精细化配置，比如只读还是可写（rw/ro），同步刷盘还是异步（async/sync），等等；</li>
<li><strong>dump选项</strong>：让你能控制文件系统备份的频率，0 表示不备份；</li>
<li><strong>fsck选项</strong>：让你控制是否开机用 fsck 自检，0 表示不要；</li>
</ul>
<p><strong>查看内核支持的文件系统</strong></p>
<p>ls /lib/modules/${kernel_version}/kernel/fs/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[root@node25 home]# ls &#x2F;lib&#x2F;modules&#x2F;3.10.0-957.el7.x86_64&#x2F;kernel&#x2F;fs</span><br><span class="line">binfmt_misc.ko.xz  btrfs  cachefiles  ceph  cifs  cramfs  dlm  exofs  ext4  fat  fscache  fuse  gfs2  isofs  jbd2  lockd  mbcache.ko.xz  nfs  nfs_common  nfsd  nls  overlayfs  pstore  squashfs  udf  xfs</span><br><span class="line">[root@node25 home]# ls &#x2F;lib&#x2F;modules&#x2F;3.10.0-957.el7.x86_64&#x2F;kernel&#x2F;fs&#x2F;ext4</span><br><span class="line">ext4.ko.xz</span><br><span class="line">[root@node25 home]#</span><br><span class="line">[root@node25 home]# lsmod </span><br><span class="line">Module                  Size  Used by</span><br><span class="line">binfmt_misc            17468  1 </span><br><span class="line">vmw_vsock_vmci_transport    30577  1 </span><br><span class="line">vsock                  36526  2 vmw_vsock_vmci_transport</span><br><span class="line">iosf_mbi               15582  0 </span><br><span class="line">crc32_pclmul           13133  0 </span><br><span class="line">snd_seq_midi           13565  0 </span><br><span class="line">ppdev                  17671  0 </span><br><span class="line">ghash_clmulni_intel    13273  0 </span><br><span class="line">snd_seq_midi_event     14899  1 snd_seq_midi</span><br><span class="line">aesni_intel           189414  0 </span><br><span class="line">lrw                    13286  1 aesni_intel</span><br><span class="line">gf128mul               15139  1 lrw</span><br><span class="line">glue_helper            13990  1 aesni_intel</span><br><span class="line">ablk_helper            13597  1 aesni_intel</span><br><span class="line">cryptd                 21190  3 ghash_clmulni_intel,aesni_intel,ablk_helper</span><br><span class="line">vmw_balloon            18094  0 </span><br><span class="line">joydev                 17389  0 </span><br><span class="line">pcspkr                 12718  0 </span><br><span class="line">snd_ens1371            25076  0 </span><br><span class="line">snd_rawmidi            31294  2 snd_ens1371,snd_seq_midi</span><br><span class="line">snd_ac97_codec        130556  1 snd_ens1371</span><br><span class="line">ac97_bus               12730  1 snd_ac97_codec</span><br><span class="line">snd_seq                62663  2 snd_seq_midi_event,snd_seq_midi</span><br><span class="line">snd_seq_device         14356  3 snd_seq,snd_rawmidi,snd_seq_midi</span><br><span class="line">snd_pcm               105708  2 snd_ac97_codec,snd_ens1371</span><br><span class="line">snd_timer              29912  2 snd_pcm,snd_seq</span><br><span class="line">snd                    83815  7 snd_ac97_codec,snd_timer,snd_pcm,snd_seq,snd_rawmidi,snd_ens1371,snd_seq_device</span><br><span class="line">soundcore              15047  1 snd</span><br><span class="line">sg                     40721  0 </span><br><span class="line">parport_pc             28205  0 </span><br><span class="line">parport                46395  2 ppdev,parport_pc</span><br><span class="line">i2c_piix4              22401  0 </span><br><span class="line">vmw_vmci               67127  1 vmw_vsock_vmci_transport</span><br><span class="line">ip_tables              27126  0 </span><br><span class="line">xfs                   997127  2 </span><br><span class="line">libcrc32c              12644  1 xfs</span><br><span class="line">sr_mod                 22416  0 </span><br><span class="line">cdrom                  42556  1 sr_mod</span><br><span class="line">sd_mod                 46281  3 </span><br><span class="line">crc_t10dif             12912  1 sd_mod</span><br><span class="line">crct10dif_generic      12647  0 </span><br><span class="line">crct10dif_pclmul       14307  1 </span><br><span class="line">crct10dif_common       12595  3 crct10dif_pclmul,crct10dif_generic,crc_t10dif</span><br><span class="line">crc32c_intel           22094  1 </span><br><span class="line">serio_raw              13434  0 </span><br><span class="line">ata_generic            12923  0 </span><br><span class="line">pata_acpi              13053  0 </span><br><span class="line">vmwgfx                276430  1 </span><br><span class="line">drm_kms_helper        179394  1 vmwgfx</span><br><span class="line">syscopyarea            12529  1 drm_kms_helper</span><br><span class="line">sysfillrect            12701  1 drm_kms_helper</span><br><span class="line">sysimgblt              12640  1 drm_kms_helper</span><br><span class="line">fb_sys_fops            12703  1 drm_kms_helper</span><br><span class="line">ttm                   114635  1 vmwgfx</span><br><span class="line">drm                   429744  4 ttm,drm_kms_helper,vmwgfx</span><br><span class="line">ata_piix               35052  0 </span><br><span class="line">libata                243133  3 pata_acpi,ata_generic,ata_piix</span><br><span class="line">e1000                 137586  0 </span><br><span class="line">mptspi                 22628  2 </span><br><span class="line">scsi_transport_spi     30732  1 mptspi</span><br><span class="line">mptscsih               40150  1 mptspi</span><br><span class="line">nfit                   55016  0 </span><br><span class="line">mptbase               106036  2 mptspi,mptscsih</span><br><span class="line">drm_panel_orientation_quirks    12957  1 drm</span><br><span class="line">libnvdimm             147731  1 nfit</span><br><span class="line">dm_mirror              22289  0 </span><br><span class="line">dm_region_hash         20813  1 dm_mirror</span><br><span class="line">dm_log                 18411  2 dm_region_hash,dm_mirror</span><br><span class="line">dm_mod                124407  8 dm_log,dm_mirror</span><br><span class="line">[root@node25 home]#</span><br></pre></td></tr></table></figure>

<p><strong>ko</strong> 其实是 <strong>kernel object</strong> 的缩写，这类文件存在的意义其实和用户态的 .so 库类似，都是为了模块化的编程实践。内核把核心主干框架之外的功能拆解成模块，需要的时候就加载 ko 模块，不需要的时候卸载即可。<strong>这样带来的好处就是方便开发和使用，保持内核的核心代码极度精炼。</strong></p>
<p>如果想看内核已经加载的内核模块，可以调用 <code>lsmod</code> 看到。</p>
<h3><span id="文件系统">文件系统</span></h3><hr>
<p>内核文件系统</p>
<p>内核文件系统位于 vfs 之下，块存储模块之上的一个位置。对外呈现文件存储实现，对下管理裸块设备。</p>
<p>用户态（用户空间）文件系统</p>
<h3><span id="fuse">FUSE</span></h3><hr>
<p><strong>FUSE 是一个用来实现用户态文件系统的框架</strong>，这套 FUSE 框架包含 3 个组件：</p>
<ol>
<li><strong>内核模块 <code>fuse.ko</code></strong> ：用来接收 vfs 传递下来的 IO 请求，并且把这个 IO 封装之后通过管道发送到用户态；</li>
<li><strong>用户态 lib 库 <code>libfuse</code></strong> ：解析内核态转发出来的协议包，拆解成常规的 IO 请求；</li>
<li><strong>mount 工具 <code>fusermount</code></strong> ；</li>
</ol>
<h4><span id="请求">请求</span></h4><hr>
<p>FUSE 请求包分为两部分：</p>
<ol>
<li><code>Header</code> ：这个是所有请求共用的，比如 <code>open</code> 请求，<code>read</code> 请求，<code>write</code> 请求，<code>getxattr</code> 请求，头部都至少有这个结构体，<code>Header</code> 结构体能描述整个 FUSE 请求，其中字段能区分请求类型；</li>
<li><code>Payload</code> ：这个东西是每个 IO 类型会是不同的，比如 <code>read</code> 请求就没这个，<code>write</code> 请求就有这个，因为 <code>write</code> 请求是携带数据的；</li>
</ol>
<p>Header</p>
<p><strong>type</strong> inHeader <strong>struct</strong> {<br> Len  <strong>uint32</strong><br> Opcode <strong>uint32</strong><br> Unique <strong>uint64</strong><br> Nodeid <strong>uint64</strong><br> Uid  <strong>uint32</strong><br> Gid  <strong>uint32</strong><br> Pid  <strong>uint32</strong><br> _   <strong>uint32</strong><br>}</p>
<ul>
<li>Len: 是整个请求的字节数长度（<code>Header</code> + <code>Payload</code>）</li>
<li>Opcode: 请求的类型，比如区分 open、read、write 等等；</li>
<li>Unique: 请求唯一标识（和响应中要对应）</li>
<li>Nodeid: 请求针对的文件 nodeid，目标文件或者文件夹的 nodeid；</li>
<li>Uid: 文件/文件夹操作的进程的用户ID</li>
<li>Gid: 文件/文件夹操作的进程的用户组ID</li>
<li>Pid: 文件/文件夹操作的进程的进程ID</li>
</ul>
<h4><span id="响应">响应</span></h4><hr>
<p>FUSE 响应包也分为两部分：</p>
<ul>
<li><code>Header</code> ：这个结构体也是在数据头部的，所有 IO 类型的响应都至少有这个结构体。该结构体用于描述整个响应请求；</li>
<li><code>Payload</code> ：每个请求的类型可能不同，比如 <code>read</code> 请求就会有这个，因为要携带 <code>read</code> 出来的用户数据，<code>write</code> 请求就不会有；</li>
</ul>
<p><strong>type</strong> outHeader <strong>struct</strong> {<br> Len  <strong>uint32</strong><br> Error <strong>int32</strong><br> Unique <strong>uint64</strong><br>}</p>
<ul>
<li>Len: 整个响应的字节数长度（ <code>Header</code> + <code>Payload</code> ）；</li>
<li>Error: 响应错误码，成功返回 0，其他对应着系统的错误代码，负数；</li>
<li>Unique: 对应者请求的唯一标识，和请求对应；</li>
</ul>
<h4><span id="devfuse">/dev/fuse</span></h4><hr>
<p><strong><code>/dev/fuse</code> ，这个虚设备文件就是内核模块和用户程序的桥梁</strong></p>
<p>用户的 io 通过正常的系统调用进来，走到内核文件系统 fuse ，fuse 文件系统把这个 io 请求封装起来，打包成特定的格式，通过 <code>/dev/fuse</code> 这个管道传递到用户态。在此之前有守护进程监听这个管道，看到有消息出来之后，立马读出来，然后利用 <code>libfuse</code> 库解析协议，之后就是用户文件系统的代码逻辑了。</p>
<h4><span id="使用">使用</span></h4><hr>
<p>判断 Linux 内核是否支持 fuse</p>
<p>modprobe fuse</p>
<p>挂载 fuse 内核文件系统，便于管理</p>
<p>mount -t fusectl none /sys/fs/fuse/connections</p>
<p>通过挂载内核 fuse 文件系统，可以看到所有实现的用户文件系统</p>
<p>ls -l /sys/fs/fuse/connections/</p>
<p>挂载用户文件系统</p>
<p>fusermount -o fsname=helloworld,subtype=hellofs – /mnt/myfs/</p>
<p>实现了 FUSE 的用户态文件系统有非常多的例子，比如，GlusterFS，SSHFS，CephFS，Lustre，GmailFS，EncFS，S3FS、、、等等</p>
<h3><span id="java开发fuse文件系统">Java开发Fuse文件系统</span></h3><hr>
<h2><span id="alluxio-jni-fuse">Alluxio JNI Fuse</span></h2><p>学习Alluxio的源码，了解Alluxio的JNI-FUSE实现。</p>
<p>Alluxio FUSE首先需要主动通过JNR-FUSE或JNI-FUSE调用libfuse的fuse_main_real方法，注册挂载点和每个fuse operation回调函数，然后Alluxio FUSE会打开<strong>/dev/fuse</strong>，返回文件描述符<strong>fd</strong>，等待读取来自<strong>FUS</strong>E设备的请求。fd在进程内共享，在进程间不共享，因此FUSE支持<strong>multi-thread</strong>模式，也支持多个FUSE服务程序，创建多个相互隔离的挂载点。</p>
<p>同时，JNI-FUSE模块的输出文件jar内包含着linux和macosx的libjnifuse共享库，使用 JNI-FUSE 时，无需指定 java.library.path 参数，对 libjnifuse 文件透明。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">          &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;maven-antrun-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;executions&gt;</span><br><span class="line">              &lt;execution&gt;</span><br><span class="line">                &lt;id&gt;native_fuse_compile&lt;&#x2F;id&gt;</span><br><span class="line">                &lt;phase&gt;compile&lt;&#x2F;phase&gt;</span><br><span class="line">                &lt;goals&gt;&lt;goal&gt;run&lt;&#x2F;goal&gt;&lt;&#x2F;goals&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                  &lt;target&gt;</span><br><span class="line">                    &lt;mkdir dir&#x3D;&quot;$&#123;project.build.directory&#125;&#x2F;native&quot; &#x2F;&gt;</span><br><span class="line">                    &lt;exec executable&#x3D;&quot;make&quot; failonerror&#x3D;&quot;true&quot; dir&#x3D;&quot;$&#123;project.build.directory&#125;&#x2F;native&quot;&gt;</span><br><span class="line">                      &lt;arg line&#x3D;&quot;-f $&#123;project.basedir&#125;&#x2F;src&#x2F;main&#x2F;native&#x2F;libjnifuse&#x2F;Makefile&quot; &#x2F;&gt;</span><br><span class="line">                    &lt;&#x2F;exec&gt;</span><br><span class="line">                  &lt;&#x2F;target&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">              &lt;&#x2F;execution&gt;</span><br><span class="line">            &lt;&#x2F;executions&gt;</span><br><span class="line">          &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">      &lt;&#x2F;build&gt;</span><br></pre></td></tr></table></figure>



<p>MakeFile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># The Alluxio Open Foundation licenses this work under the Apache License, version 2.0</span><br><span class="line"># (the &quot;License&quot;). You may not use this work except in compliance with the License, which is</span><br><span class="line"># available at www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line">#</span><br><span class="line"># This software is distributed on an &quot;AS IS&quot; basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,</span><br><span class="line"># either express or implied, as more fully set forth in the License.</span><br><span class="line">#</span><br><span class="line"># See the NOTICE file distributed with this work for information regarding copyright ownership.</span><br><span class="line"></span><br><span class="line">CXX :&#x3D; g++</span><br><span class="line">UNAME :&#x3D; $(shell uname)</span><br><span class="line">INCDIR &#x3D; -I &#x2F;usr&#x2F;include -I $(JAVA_HOME)&#x2F;include -I .&#x2F;</span><br><span class="line">FUSE_LIBS &#x3D; $(shell pkg-config fuse --libs)</span><br><span class="line">FUSE_CXXFLAGS &#x3D; $(shell pkg-config fuse --cflags)</span><br><span class="line"></span><br><span class="line"># Linux</span><br><span class="line">ifeq ($(UNAME), Linux)</span><br><span class="line">	INCDIR +&#x3D; -I $(JAVA_HOME)&#x2F;include&#x2F;linux</span><br><span class="line">	TARGET_LIB :&#x3D; libjnifuse.so</span><br><span class="line">endif</span><br><span class="line"># MacOS</span><br><span class="line">ifeq ($(UNAME), Darwin)</span><br><span class="line">	INCDIR +&#x3D; -I $(JAVA_HOME)&#x2F;include&#x2F;darwin</span><br><span class="line">	TARGET_LIB :&#x3D; libjnifuse.dylib</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">CXXFLAGS &#x3D; -std&#x3D;c++11 -Wall -fPIC -D_FILE_OFFSET_BITS&#x3D;64 $&#123;INCDIR&#125; $&#123;FUSE_CXXFLAGS&#125;</span><br><span class="line">LDFLAGS &#x3D; -shared $&#123;FUSE_LIBS&#125;</span><br><span class="line">OUTPUT_DIR ?&#x3D; .</span><br><span class="line">SRC_DIR ?&#x3D; ..&#x2F;..&#x2F;src&#x2F;main&#x2F;native&#x2F;libjnifuse</span><br><span class="line">OBJS&#x3D; $(addprefix $(OUTPUT_DIR)&#x2F;, $(patsubst %.cc,%.o,$(notdir $(wildcard $(SRC_DIR)&#x2F;*.cc))))</span><br><span class="line"></span><br><span class="line">$&#123;TARGET_LIB&#125;: $&#123;OBJS&#125;</span><br><span class="line">	$&#123;CXX&#125; $&#123;CXXFLAGS&#125; -o $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;TARGET_LIB&#125; $&#123;OBJS&#125; $&#123;LDFLAGS&#125;</span><br><span class="line"></span><br><span class="line">install: $&#123;TARGET_LIB&#125;</span><br><span class="line">	sudo mv $&#123;TARGET_LIB&#125; &#x2F;usr&#x2F;lib&#x2F;</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	rm -rf $&#123;OBJS&#125; $&#123;OUTPUT_DIR&#125;&#x2F;$&#123;TARGET_LIB&#125;</span><br><span class="line"></span><br><span class="line">$&#123;OUTPUT_DIR&#125;&#x2F;%.o: $&#123;SRC_DIR&#125;&#x2F;%.cc</span><br><span class="line">	$&#123;CXX&#125; $&#123;CXXFLAGS&#125; -o $@ -c $&lt;</span><br></pre></td></tr></table></figure>







<p>当一个应用程序，比如mkdir调用 syc_mkdir 想要在FUSE挂载点之下创建文件夹时，内核态VFS发现这个挂载点对应的是FUSE类型，则构造一个<strong>FUSE_MKDIR</strong>的 fuse_req，投递到<strong>pending</strong>队列里。</p>
<p>libfuse启动的读取到fuse设备的请求后，会执行<strong>fuse_lib_mkdir</strong>操作，这个操作会回调到mount时给定的回调函数里，再由JNI-FUSE转而回调到<strong>AlluxioJNIFuseFilesystem</strong>中的mkdir方法，最后，mkdir方法体中会通知Alluxio的master创建文件夹，当完成操作后，会回复ok给fuse设备，这样fuse_mkdir则会返回给调用者，文件夹创建成功。</p>
<p>首先，AlluxioFuse会通过调用native函数<strong>fuse_main_real</strong>, 进行文件系统挂载。Native 代码会调用libfuse中的fuse_main_real方法，向kernel注册挂载点以及回调函数指针。</p>
<p>此时，如果一个mkdir操作发生在 这个FUSE挂载点，则AlluxioFuse会收到这个通知，相应的挂载函数，<strong>jnifuse_oper_mkdir</strong>指向的<strong>mkdir_wrapper</strong>会被调用。最后这个mkdir 请求会反向调用JAVA代码中相应的FS实现函数mkdir，执行真正的实现逻辑。</p>
<p>alluxio.jnifuse.FuseFileSystem</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0</span></span><br><span class="line"><span class="comment"> * (the "License"). You may not use this work except in compliance with the License, which is</span></span><br><span class="line"><span class="comment"> * available at www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This software is distributed on an "AS IS" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,</span></span><br><span class="line"><span class="comment"> * either express or implied, as more fully set forth in the License.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * See the NOTICE file distributed with this work for information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> alluxio.jnifuse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> alluxio.jnifuse.struct.FileStat;</span><br><span class="line"><span class="keyword">import</span> alluxio.jnifuse.struct.FuseContext;</span><br><span class="line"><span class="keyword">import</span> alluxio.jnifuse.struct.FuseFileInfo;</span><br><span class="line"><span class="keyword">import</span> alluxio.jnifuse.struct.Statvfs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadLocalRandom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FuseFileSystem</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">getattr</span><span class="params">(String path, FileStat stat)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"getattr"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">mkdir</span><span class="params">(String path, <span class="keyword">long</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"mkdir"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">unlink</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"unlink"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">rmdir</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"rmdir"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">symlink</span><span class="params">(String oldpath, String newpath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"symlink"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">rename</span><span class="params">(String oldpath, String newpath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"rename"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">link</span><span class="params">(String oldpath, String newpath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"link"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">chmod</span><span class="params">(String path, <span class="keyword">long</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"chmod"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">chown</span><span class="params">(String path, <span class="keyword">long</span> uid, <span class="keyword">long</span> gid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"chown"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">truncate</span><span class="params">(String path, <span class="keyword">long</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"truncate"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">open</span><span class="params">(String path, FuseFileInfo fi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"open"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(String path, ByteBuffer buf, <span class="keyword">long</span> size, <span class="keyword">long</span> offset, FuseFileInfo fi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"read"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(String path, ByteBuffer buf, <span class="keyword">long</span> size, <span class="keyword">long</span> offset, FuseFileInfo fi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"write"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">statfs</span><span class="params">(String path, Statvfs stbuf)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"statfs"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">flush</span><span class="params">(String path, FuseFileInfo fi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"flush"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">release</span><span class="params">(String path, FuseFileInfo fi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"release"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">opendir</span><span class="params">(String path, FuseFileInfo fi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"opendir"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">readdir</span><span class="params">(String path, <span class="keyword">long</span> bufaddr, FuseFillDir filter, <span class="keyword">long</span> offset, FuseFileInfo fi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"readdir"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">releasedir</span><span class="params">(String path, FuseFileInfo fi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"releasedir"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">create</span><span class="params">(String path, <span class="keyword">long</span> mode, FuseFileInfo fi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"create"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> FuseContext <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> get real context</span></span><br><span class="line">    <span class="keyword">return</span> FuseContext.of(ByteBuffer.allocate(<span class="number">32</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> String <span class="title">getFileSystemName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"fusefs"</span> + ThreadLocalRandom.current().nextInt();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>alluxio.jnifuse.AbstractFuseFileSystem</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractFuseFileSystem implements FuseFileSystem &#123;</span><br><span class="line">  static &#123;</span><br><span class="line">    System.loadLibrary(&quot;jnifuse&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>alluxio-integration-fuse子项目对应JNI实现</p>
<img src="/images/alluxio-jni-fuse.png" width="74%" height="75%">





<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package alluxio.jnifuse;</span><br><span class="line"></span><br><span class="line">import java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line">public class LibFuse &#123;</span><br><span class="line"></span><br><span class="line">  public native int fuse_main_real(AbstractFuseFileSystem fs, int argc, String[] argv);</span><br><span class="line"></span><br><span class="line">  public native ByteBuffer fuse_get_context();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>alluxio.fuse.AlluxioJniFuseFileSystem</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public int create(String path, long mode, FuseFileInfo fi) &#123;</span><br><span class="line">  return AlluxioFuseUtils.call(LOG, () -&gt; createInternal(path, mode, fi),</span><br><span class="line">      &quot;create&quot;, &quot;path&#x3D;%s,mode&#x3D;%o&quot;, path, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>alluxio.fuse.AlluxioFuseUtils</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">call</span><span class="params">(Logger logger, FuseCallable callable, String methodName,</span></span></span><br><span class="line"><span class="function"><span class="params">    String description, Object... args)</span> </span>&#123;</span><br><span class="line">  String debugDesc = logger.isDebugEnabled() ? String.format(description, args) : <span class="keyword">null</span>;</span><br><span class="line">  logger.debug(<span class="string">"Enter: &#123;&#125;(&#123;&#125;)"</span>, methodName, debugDesc);</span><br><span class="line">  <span class="keyword">long</span> startMs = System.currentTimeMillis();</span><br><span class="line">  <span class="keyword">int</span> ret = callable.call();</span><br><span class="line">  <span class="keyword">long</span> durationMs = System.currentTimeMillis() - startMs;</span><br><span class="line">  logger.debug(<span class="string">"Exit (&#123;&#125;): &#123;&#125;(&#123;&#125;) in &#123;&#125; ms"</span>, ret, methodName, debugDesc, durationMs);</span><br><span class="line">  <span class="keyword">if</span> (durationMs &gt;= THRESHOLD) &#123;</span><br><span class="line">    logger.warn(<span class="string">"&#123;&#125;(&#123;&#125;) returned &#123;&#125; in &#123;&#125; ms (&gt;=&#123;&#125; ms)"</span>, methodName,</span><br><span class="line">        String.format(description, args), ret, durationMs, THRESHOLD);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createInternal</span><span class="params">(String path, <span class="keyword">long</span> mode, FuseFileInfo fi)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> AlluxioURI uri = mPathResolverCache.getUnchecked(path);</span><br><span class="line">  <span class="keyword">if</span> (uri.getName().length() &gt; MAX_NAME_LENGTH) &#123;</span><br><span class="line">    LOG.error(<span class="string">"Failed to create &#123;&#125;: file name longer than &#123;&#125; characters"</span>,</span><br><span class="line">        path, MAX_NAME_LENGTH);</span><br><span class="line">    <span class="keyword">return</span> -ErrorCodes.ENAMETOOLONG();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    FileOutStream os = mFileSystem.createFile(uri,</span><br><span class="line">        CreateFilePOptions.newBuilder()</span><br><span class="line">            .setMode(<span class="keyword">new</span> Mode((<span class="keyword">short</span>) mode).toProto())</span><br><span class="line">            .build());</span><br><span class="line">    <span class="keyword">long</span> fid = mNextOpenFileId.getAndIncrement();</span><br><span class="line">    mCreateFileEntries.put(fid, os);</span><br><span class="line">    fi.fh.set(fid);</span><br><span class="line">    setUserGroupIfNeeded(uri);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    LOG.error(<span class="string">"Failed to create &#123;&#125;: "</span>, path, e);</span><br><span class="line">    <span class="keyword">return</span> -ErrorCodes.EIO();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public interface FuseCallable &#123;</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * The RPC implementation.</span><br><span class="line">   *</span><br><span class="line">   * @return the return value from the RPC</span><br><span class="line">   *&#x2F;</span><br><span class="line">  int call();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>alluxio-fuse.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#96;$ .&#x2F;bin&#x2F;alluxio-fuse.sh mount mount_point [alluxio_path]&#96;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mount_fuse() &#123;</span><br><span class="line">  local mount_point&#x3D;$1</span><br><span class="line">  local alluxio_root&#x3D;$2</span><br><span class="line">  local full_mount_option&#x3D;&quot;&quot;</span><br><span class="line">  if [[ ! -z &quot;$&#123;mount_option&#125;&quot; ]]; then</span><br><span class="line">    full_mount_option&#x3D;&quot;big_writes,$&#123;mount_option&#125;&quot;</span><br><span class="line">  else</span><br><span class="line">    full_mount_option&#x3D;&quot;big_writes&quot;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ $&#123;NO_DAEMON&#125; -eq &quot;1&quot; ]]; then</span><br><span class="line">    ALLUXIO_FUSE_JAVA_OPTS+&#x3D;&quot; -Dalluxio.logger.type&#x3D;FUSE_LOGGER,Console&quot;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  local cmd&#x3D;&quot;$&#123;JAVA&#125; -cp $&#123;CLASSPATH&#125; $&#123;JAVA_OPTS&#125; $&#123;ALLUXIO_FUSE_JAVA_OPTS&#125; \</span><br><span class="line">    alluxio.fuse.AlluxioFuse \</span><br><span class="line">    -o $&#123;full_mount_option&#125; \</span><br><span class="line">    -m $&#123;mount_point&#125; \</span><br><span class="line">    -r $&#123;alluxio_root&#125;&quot;</span><br><span class="line">  echo &quot;Starting AlluxioFuse process: mounting alluxio path \&quot;$&#123;alluxio_root&#125;\&quot; to local mount point \&quot;$&#123;mount_point&#125;\&quot; with options&#x3D;\&quot;$&#123;full_mount_option&#125;\&quot;&quot;</span><br><span class="line">  if [[ $&#123;NO_DAEMON&#125; -eq &quot;1&quot; ]]; then</span><br><span class="line">    exec $&#123;cmd&#125;</span><br><span class="line">  else</span><br><span class="line">    (nohup $&#123;cmd&#125; &gt; $&#123;ALLUXIO_LOGS_DIR&#125;&#x2F;fuse.out 2&gt;&amp;1) &amp;</span><br><span class="line">    # sleep: workaround to let the bg java process exit on errors, if any</span><br><span class="line">    sleep 2s</span><br><span class="line">    if kill -0 $! &gt; &#x2F;dev&#x2F;null 2&gt;&amp;1 ; then</span><br><span class="line">      echo &quot;Successfully mounted Alluxio path \&quot;$&#123;alluxio_root&#125;\&quot; to $&#123;mount_point&#125;.&quot;</span><br><span class="line">      echo &quot;See $&#123;ALLUXIO_LOGS_DIR&#125;&#x2F;fuse.log for logging messages&quot;</span><br><span class="line">      return 0</span><br><span class="line">    else</span><br><span class="line">      echo &quot;Failed to mount Alluxio path \&quot;$&#123;alluxio_root&#125;\&quot; to $&#123;mount_point&#125;.&quot;</span><br><span class="line">      echo &quot;See $&#123;ALLUXIO_LOGS_DIR&#125;&#x2F;fuse.out for more details&quot;</span><br><span class="line">      return 1</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>alluxio.fuse.AlluxioFuse</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">"Alluxio version: &#123;&#125;-&#123;&#125;"</span>, RuntimeConstants.VERSION, ProjectConstants.REVISION);</span><br><span class="line">    AlluxioConfiguration conf = InstancedConfiguration.defaults();</span><br><span class="line">    FileSystemContext fsContext = FileSystemContext.create(conf);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      InetSocketAddress confMasterAddress =</span><br><span class="line">          fsContext.getMasterClientContext().getConfMasterInquireClient().getPrimaryRpcAddress();</span><br><span class="line">      RetryUtils.retry(<span class="string">"load cluster default configuration with master "</span> + confMasterAddress,</span><br><span class="line">          () -&gt; fsContext.getClientContext().loadConfIfNotLoaded(confMasterAddress),</span><br><span class="line">          RetryUtils.defaultClientRetry(</span><br><span class="line">              conf.getDuration(PropertyKey.USER_RPC_RETRY_MAX_DURATION),</span><br><span class="line">              conf.getDuration(PropertyKey.USER_RPC_RETRY_BASE_SLEEP_MS),</span><br><span class="line">              conf.getDuration(PropertyKey.USER_RPC_RETRY_MAX_SLEEP_MS)));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      LOG.warn(<span class="string">"Failed to load cluster default configuration for Fuse process. "</span></span><br><span class="line">          + <span class="string">"Proceed with local configuration for FUSE: &#123;&#125;"</span>, e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    conf = fsContext.getClusterConf();</span><br><span class="line">    <span class="keyword">final</span> AlluxioFuseOptions opts = parseOptions(args, conf);</span><br><span class="line">    <span class="keyword">if</span> (opts == <span class="keyword">null</span>) &#123;</span><br><span class="line">      System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> (<span class="keyword">final</span> FileSystem fs = FileSystem.Factory.create(fsContext)) &#123;</span><br><span class="line">      <span class="keyword">final</span> List&lt;String&gt; fuseOpts = opts.getFuseOpts();</span><br><span class="line">      <span class="keyword">if</span> (conf.getBoolean(PropertyKey.FUSE_JNIFUSE_ENABLED)) &#123;</span><br><span class="line">        <span class="keyword">final</span> AlluxioJniFuseFileSystem fuseFs = <span class="keyword">new</span> AlluxioJniFuseFileSystem(fs, opts, conf);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          LOG.info(<span class="string">"Mounting AlluxioJniFuseFileSystem: mount point=\"&#123;&#125;\", OPTIONS=\"&#123;&#125;\""</span>,</span><br><span class="line">              opts.getMountPoint(), fuseOpts.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">          fuseFs.mount(<span class="keyword">true</span>, opts.isDebug(), fuseOpts.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FuseException e) &#123;</span><br><span class="line">          LOG.error(<span class="string">"Failed to mount &#123;&#125;"</span>, opts.getMountPoint(), e);</span><br><span class="line">          <span class="comment">// only try to umount file system when exception occurred.</span></span><br><span class="line">          <span class="comment">// jni-fuse registers JVM shutdown hook to ensure fs.umount()</span></span><br><span class="line">          <span class="comment">// will be executed when this process is exiting.</span></span><br><span class="line">          fuseFs.umount();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Force direct_io in JNR-FUSE: writes and reads bypass the kernel page</span></span><br><span class="line">        <span class="comment">// cache and go directly to alluxio. This avoids extra memory copies</span></span><br><span class="line">        <span class="comment">// in the write path.</span></span><br><span class="line">        <span class="comment">// TODO(binfan): support kernel_cache (issues#10840)</span></span><br><span class="line">        fuseOpts.add(<span class="string">"-odirect_io"</span>);</span><br><span class="line">        <span class="keyword">final</span> AlluxioFuseFileSystem fuseFs = <span class="keyword">new</span> AlluxioFuseFileSystem(fs, opts, conf);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          fuseFs.mount(Paths.get(opts.getMountPoint()), <span class="keyword">true</span>, opts.isDebug(),</span><br><span class="line">              fuseOpts.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ru.serce.jnrfuse.FuseException e) &#123;</span><br><span class="line">          LOG.error(<span class="string">"Failed to mount &#123;&#125;"</span>, opts.getMountPoint(), e);</span><br><span class="line">          <span class="comment">// only try to umount file system when exception occurred.</span></span><br><span class="line">          <span class="comment">// jnr-fuse registers JVM shutdown hook to ensure fs.umount()</span></span><br><span class="line">          <span class="comment">// will be executed when this process is exiting.</span></span><br><span class="line">          fuseFs.umount();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      LOG.error(<span class="string">"Failed to mount Alluxio file system"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AlluxioJniFuseFileSystem</span><br></pre></td></tr></table></figure>



<p>alluxio.jnifuse.AbstractFuseFileSystem#mount</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mount</span><span class="params">(<span class="keyword">boolean</span> blocking, <span class="keyword">boolean</span> debug, String[] fuseOpts)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!mounted.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> FuseException(<span class="string">"Fuse File System already mounted!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.info(<span class="string">"Mounting &#123;&#125;: blocking=&#123;&#125;, debug=&#123;&#125;, fuseOpts=\"&#123;&#125;\""</span>,</span><br><span class="line">      mountPoint, blocking, debug, Arrays.toString(fuseOpts));</span><br><span class="line">  String[] arg;</span><br><span class="line">  String mountPointStr = mountPoint.toString();</span><br><span class="line">  <span class="keyword">if</span> (mountPointStr.endsWith(<span class="string">"\\"</span>)) &#123;</span><br><span class="line">    mountPointStr = mountPointStr.substring(<span class="number">0</span>, mountPointStr.length() - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!debug) &#123;</span><br><span class="line">    arg = <span class="keyword">new</span> String[] &#123;getFileSystemName(), <span class="string">"-f"</span>, mountPointStr&#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    arg = <span class="keyword">new</span> String[] &#123;getFileSystemName(), <span class="string">"-f"</span>, <span class="string">"-d"</span>, mountPointStr&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (fuseOpts.length != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> argLen = arg.length;</span><br><span class="line">    arg = Arrays.copyOf(arg, argLen + fuseOpts.length);</span><br><span class="line">    System.arraycopy(fuseOpts, <span class="number">0</span>, arg, argLen, fuseOpts.length);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> String[] args = arg;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (SecurityUtils.canHandleShutdownHooks()) &#123;</span><br><span class="line">      Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="keyword">this</span>::umount));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    <span class="keyword">if</span> (blocking) &#123;</span><br><span class="line">      res = execMount(args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        res = CompletableFuture.supplyAsync(() -&gt; execMount(args)).get(MOUNT_TIMEOUT_MS,</span><br><span class="line">            TimeUnit.MILLISECONDS);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">        <span class="comment">// ok</span></span><br><span class="line">        res = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (res != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> FuseException(<span class="string">"Unable to mount FS, return code = "</span> + res);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    mounted.set(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> FuseException(<span class="string">"Unable to mount FS"</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private int execMount(String[] arg) &#123;</span><br><span class="line">  return libFuse.fuse_main_real(this, arg.length, arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>alluxio.jnifuse.LibFuse#fuse_main_real</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/07/02/Prometheus%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/02/Prometheus%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">Prometheus</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2021-07-02T00:00:00+08:00">2021-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-17 09:38:39" itemprop="dateModified" datetime="2022-01-17T09:38:39+08:00">2022-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Prometheus/" itemprop="url" rel="index"><span itemprop="name">Prometheus</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->

<ul>
<li><a href="#prometheus-下载">Prometheus 下载</a><ul>
<li><a href="#下载">下载</a></li>
<li><a href="#配置">配置</a></li>
<li><a href="#存储">存储</a></li>
<li><a href="#启动">启动</a></li>
<li><a href="#问题">问题</a></li>
<li><a href="#配置监控目标node-exporter">配置监控目标—Node Exporter</a></li>
<li><a href="#可视化">可视化</a></li>
<li><a href="#告警">告警</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

<hr>
<h2><span id="prometheus-下载">Prometheus 下载</span></h2><h3><span id="下载">下载</span></h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;prometheus&#x2F;releases&#x2F;download&#x2F;v2.28.1&#x2F;prometheus-2.28.1.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;home&#x2F;lining</span><br><span class="line"></span><br><span class="line">-rw-r--r--.  1 root   root    71109475 Jul  1 07:25 prometheus-2.28.1.linux-amd64.tar.gz</span><br><span class="line">-rw-r--r--.  1 root   root    23629386 Jul  1 07:25 alertmanager-0.22.2.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tar -zxvf prometheus-2.28.1.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">cd &#x2F;home&#x2F;lining&#x2F;prometheus-2.28.1.linux-amd64</span><br><span class="line"></span><br><span class="line">drwxr-xr-x. 2 lining lining       38 Jul  2  2021 console_libraries</span><br><span class="line">drwxr-xr-x. 2 lining lining      173 Jul  2  2021 consoles</span><br><span class="line">-rw-r--r--. 1 lining lining    11357 Jul  2  2021 LICENSE</span><br><span class="line">-rw-r--r--. 1 lining lining     3646 Jul  2  2021 NOTICE</span><br><span class="line">-rwxr-xr-x. 1 lining lining 98503354 Jul  1  2021 prometheus</span><br><span class="line">-rw-r--r--. 1 lining lining      926 Jul  2  2021 prometheus.yml</span><br><span class="line">-rwxr-xr-x. 1 lining lining 87509137 Jul  1  2021 promtool</span><br></pre></td></tr></table></figure>



<h3><span id="配置">配置</span></h3><hr>
<p>vi prometheus.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#39;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label &#96;job&#x3D;&lt;job_name&gt;&#96; to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &#39;prometheus&#39;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &#39;&#x2F;metrics&#39;</span><br><span class="line">    # scheme defaults to &#39;http&#39;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#39;192.168.67.4:9090&#39;]</span><br></pre></td></tr></table></figure>



<p>Alerting rules</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: example</span><br><span class="line">  rules:</span><br><span class="line"></span><br><span class="line">  # Alert for any instance that is unreachable for &gt;5 minutes.</span><br><span class="line">  - alert: InstanceDown</span><br><span class="line">    expr: up &#x3D;&#x3D; 0</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; down&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125; of job &#123;&#123; $labels.job &#125;&#125; has been down for more than 5 minutes.&quot;</span><br><span class="line"></span><br><span class="line">  # Alert for any instance that has a median request latency &gt;1s.</span><br><span class="line">  - alert: APIHighRequestLatency</span><br><span class="line">    expr: api_http_request_latencies_second&#123;quantile&#x3D;&quot;0.5&quot;&#125; &gt; 1</span><br><span class="line">    for: 10m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;High request latency on &#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125; has a median request latency above 1s (current value: &#123;&#123; $value &#125;&#125;s)&quot;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: example</span><br><span class="line">  rules:</span><br><span class="line">  - alert: HighRequestLatency</span><br><span class="line">    expr: job:request_latency_seconds:mean5m&#123;job&#x3D;&quot;myjob&quot;&#125; &gt; 0.5</span><br><span class="line">    for: 10m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: High request latency</span><br></pre></td></tr></table></figure>



















<h3><span id="存储">存储</span></h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">By default, Prometheus stores its database in .&#x2F;data (flag --storage.tsdb.path).</span><br></pre></td></tr></table></figure>



<h3><span id="启动">启动</span></h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;prometheus --config.file&#x3D;prometheus.yml</span><br></pre></td></tr></table></figure>



<p>访问  <a href="http://192.168.67.4:9090/" target="_blank" rel="noopener">http://192.168.67.4:9090/</a></p>
<p><a href="http://192.168.67.4:9090/graph" target="_blank" rel="noopener">http://192.168.67.4:9090/graph</a></p>
<p>输入prometheus_target_interval_length_seconds指标（表示prometheus抓取的时间间隔）查询对应的度量值</p>
<p>或者使用表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">prometheus_target_interval_length_seconds&#123;quantile&#x3D;&quot;0.99&quot;&#125;</span><br><span class="line"></span><br><span class="line">count(prometheus_target_interval_length_seconds)</span><br><span class="line"></span><br><span class="line">rate(prometheus_tsdb_head_chunks_created_total[1m])</span><br></pre></td></tr></table></figure>





<p><a href="http://192.168.67.4:9090/metrics" target="_blank" rel="noopener">http://192.168.67.4:9090/metrics</a></p>
<h3><span id="问题">问题</span></h3><hr>
<p>服务器与客户端时间差问题</p>
<p>Error fetching server time: Detected 99408.81999993324 seconds time difference between your browser and the server. Prometheus relies on accurate time and time drift might cause unexpected query results.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -sf &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;Asia&#x2F;Shanghai &#x2F;etc&#x2F;localtime</span><br><span class="line">sudo hwclock -w</span><br><span class="line">date -s 2021-07-02</span><br><span class="line">date -s 17:55:55</span><br><span class="line">或者使用NTP同步</span><br><span class="line">ntpdate time3.aliyun.com</span><br></pre></td></tr></table></figure>



<h3><span id="配置监控目标node-exporter">配置监控目标—Node Exporter</span></h3><hr>
<p>下载</p>
<p><a href="https://github.com/prometheus/haproxy_exporter" target="_blank" rel="noopener">haproxy_exporter</a></p>
<p><a href="https://github.com/prometheus/memcached_exporter" target="_blank" rel="noopener">memcached_exporter</a></p>
<p><a href="https://github.com/prometheus/mysqld_exporter" target="_blank" rel="noopener">mysqld_exporter</a></p>
<p><a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noopener">node_exporter</a></p>
<p><a href="https://github.com/prometheus/graphite_exporter" target="_blank" rel="noopener">graphite_exporter</a></p>
<p><a href="https://github.com/prometheus/consul_exporter" target="_blank" rel="noopener">consul_exporter</a></p>
<p><a href="https://github.com/prometheus/blackbox_exporter" target="_blank" rel="noopener">blackbox_exporter</a></p>
<p><a href="https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz" target="_blank" rel="noopener">https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz</a></p>
<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">cd &#x2F;home&#x2F;lining&#x2F;node_exporter-1.1.2.linux-amd64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.&#x2F;node_exporter --web.listen-address 192.168.67.4:8080</span><br><span class="line">.&#x2F;node_exporter --web.listen-address 192.168.67.4:8081</span><br><span class="line">.&#x2F;node_exporter --web.listen-address 192.168.67.4:8082</span><br></pre></td></tr></table></figure>



<p>访问</p>
<p><a href="http://192.168.67.4:8080/metrics" target="_blank" rel="noopener">http://192.168.67.4:8080/metrics</a></p>
<p><a href="http://192.168.67.4:8081/metrics" target="_blank" rel="noopener">http://192.168.67.4:8081/metrics</a></p>
<p><a href="http://192.168.67.4:8082/metrics" target="_blank" rel="noopener">http://192.168.67.4:8082/metrics</a></p>
<p>curl -XGET <a href="http://192.168.67.4:8080/metrics" target="_blank" rel="noopener">http://192.168.67.4:8080/metrics</a> | grep -i node_cpu</p>
<p>Content-Type: text/plain; version=0.0.4; charset=utf-8</p>
<p>node_cpu_seconds_total{cpu=”0”,mode=”idle”} 9767.04<br>node_cpu_seconds_total{cpu=”0”,mode=”iowait”} 6.37<br>node_cpu_seconds_total{cpu=”0”,mode=”irq”} 0<br>node_cpu_seconds_total{cpu=”0”,mode=”nice”} 0.05<br>node_cpu_seconds_total{cpu=”0”,mode=”softirq”} 0.47<br>node_cpu_seconds_total{cpu=”0”,mode=”steal”} 0<br>node_cpu_seconds_total{cpu=”0”,mode=”system”} 22.67<br>node_cpu_seconds_total{cpu=”0”,mode=”user”} 24.64</p>
<p>node_cpu_guest_seconds_total{cpu=”0”,mode=”nice”} 0<br>node_cpu_guest_seconds_total{cpu=”0”,mode=”user”} 0</p>
<p>空闲CPU使用时间 = node_cpu_seconds_total{<strong>mode=“idle”</strong>}</p>
<p>CPU总共使用时间 = node_cpu_seconds_total</p>
<p>空闲CPU一分钟内的增量：<strong>increase</strong>(node_cpu_seconds_total{mode=“idle”}<strong>[1m]</strong>)</p>
<p>全部CPU一分钟内的增量：<strong>increase</strong>(node_cpu_seconds_total<strong>[1m]</strong>)</p>
<p>集群所有主机空闲CPU一分钟内的增量：<strong>sum</strong>(increase(node_cpu_seconds_total{mode=“idle”}[1m]))</p>
<p>集群所有主机CPU全部使用情况一分钟内的增量：<strong>sum</strong>(increase(node_cpu_seconds_total[1m]))</p>
<p>集群所有节点空闲CPU使用增量：sum(increase(node_cpu_seconds_total{mode=“idle”}[1m])) by(instance)</p>
<p>集群所有节点全部状态CPU使用增量：sum(increase(node_cpu_seconds_total[1m]))by(instance)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">100 - (avg by (instance) (irate(node_cpu&#123;instance&#x3D;&quot;xxx&quot;, mode&#x3D;&quot;idle&quot;&#125;[5m])) * 100)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">avg by (instance, mode) (irate(node_cpu&#123;instance&#x3D;&quot;xxx&quot;&#125;[5m])) * 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">node_load1&#123;instance&#x3D;&quot;xxx&quot;&#125; &#x2F;&#x2F; 1分钟负载</span><br><span class="line">node_load5&#123;instance&#x3D;&quot;xxx&quot;&#125; &#x2F;&#x2F; 5分钟负载</span><br><span class="line">node_load15&#123;instance&#x3D;&quot;xxx&quot;&#125; &#x2F;&#x2F; 15分钟负载</span><br><span class="line"></span><br><span class="line">100 - ((node_memory_MemFree&#123;instance&#x3D;&quot;xxx&quot;&#125;+node_memory_Cached&#123;instance&#x3D;&quot;xxx&quot;&#125;+node_memory_Buffers&#123;instance&#x3D;&quot;xxx&quot;&#125;)&#x2F;node_memory_MemTotal) * 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">100 - node_filesystem_free&#123;instance&#x3D;&quot;xxx&quot;,fstype!~&quot;rootfs|selinuxfs|autofs|rpc_pipefs|tmpfs|udev|none|devpts|sysfs|debugfs|fuse.*&quot;&#125; &#x2F; node_filesystem_size&#123;instance&#x3D;&quot;xxx&quot;,fstype!~&quot;rootfs|selinuxfs|autofs|rpc_pipefs|tmpfs|udev|none|devpts|sysfs|debugfs|fuse.*&quot;&#125; * 100</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 上线带宽</span><br><span class="line">sum by (instance) (irate(node_network_receive_bytes&#123;instance&#x3D;&quot;xxx&quot;device!~&quot;bond.*?|lo&quot;&#125;[5m])&#x2F;128)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 下行带宽</span><br><span class="line">sum by (instance) (irate(node_network_transmit_bytes&#123;instance&#x3D;&quot;xxx&quot;,device!~&quot;bond.*?|lo&quot;&#125;[5m])&#x2F;128)</span><br></pre></td></tr></table></figure>









<p>配置</p>
<p>使用规则文件</p>
<p>prometheus.rules.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: cpu-node</span><br><span class="line">  rules:</span><br><span class="line">  - record: job_instance_mode:node_cpu_seconds:avg_rate5m</span><br><span class="line">    expr: avg by (job, instance, mode) (rate(node_cpu_seconds_total[5m]))</span><br></pre></td></tr></table></figure>

<p>包含规则文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # By default, scrape targets every 15 seconds.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds.</span><br><span class="line"></span><br><span class="line">  # Attach these extra labels to all timeseries collected by this Prometheus instance.</span><br><span class="line">  external_labels:</span><br><span class="line">    monitor: &#39;codelab-monitor&#39;</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &#39;prometheus.rules.yml&#39;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#39;prometheus&#39;</span><br><span class="line"></span><br><span class="line">    # Override the global default and scrape targets from this job every 5 seconds.</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#39;192.168.67.4:9090&#39;]</span><br><span class="line"></span><br><span class="line">  - job_name:       &#39;node&#39;</span><br><span class="line"></span><br><span class="line">    # Override the global default and scrape targets from this job every 5 seconds.</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#39;192.168.67.4:8080&#39;, &#39;192.168.67.4:8081&#39;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &#39;production&#39;</span><br><span class="line"></span><br><span class="line">      - targets: [&#39;192.168.67.4:8082&#39;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &#39;canary&#39;</span><br></pre></td></tr></table></figure>



<p>测试</p>
<p>node_cpu_seconds_total</p>
<p>job_instance_mode:node_cpu_seconds:avg_rate5m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;idle&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;iowait&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;irq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;nice&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;softirq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;steal&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;system&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;user&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;idle&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;iowait&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;irq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;nice&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;softirq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;steal&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;system&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;user&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;idle&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;iowait&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;irq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;nice&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;softirq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;steal&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;system&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;user&quot;&#125;</span><br></pre></td></tr></table></figure>



<h3><span id="可视化">可视化</span></h3><hr>
<p>下载</p>
<p><a href="https://grafana.com/grafana/download" target="_blank" rel="noopener">https://grafana.com/grafana/download</a></p>
<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;dl.grafana.com&#x2F;oss&#x2F;release&#x2F;grafana-8.0.4.linux-amd64.tar.gz</span><br><span class="line">tar -zxvf grafana-8.0.4.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">wget https:&#x2F;&#x2F;dl.grafana.com&#x2F;oss&#x2F;release&#x2F;grafana-8.0.4-1.x86_64.rpm</span><br><span class="line">sudo yum install grafana-8.0.4-1.x86_64.rpm</span><br></pre></td></tr></table></figure>



<p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;home&#x2F;lining&#x2F;grafana-8.0.4</span><br><span class="line"></span><br><span class="line">bin&#x2F;grafana-server</span><br></pre></td></tr></table></figure>

<p>访问<a href="http://192.168.67.4:3000" target="_blank" rel="noopener">http://192.168.67.4:3000</a>  admin/admin</p>
<p>修改密码：    DataFusion@2019</p>
<p><a href="https://grafana.com/docs/grafana/latest/datasources/?pg=graf-resources&amp;plcmt=add-a-data-source" target="_blank" rel="noopener">https://grafana.com/docs/grafana/latest/datasources/?pg=graf-resources&amp;plcmt=add-a-data-source</a></p>
<p>配置数据源</p>
<ol>
<li>Click on the “cogwheel” in the sidebar to open the Configuration menu.</li>
<li>Click on “Data Sources”.</li>
<li>Click on “Add data source”.</li>
<li>Select “Prometheus” as the type.</li>
<li>Set the appropriate Prometheus server URL (for example, <code>http://localhost:9090/</code>)</li>
<li>Adjust other data source settings as desired (for example, choosing the right Access method).</li>
<li>Click “Save &amp; Test” to save the new data source.</li>
</ol>
<p>Configuration - Data Sources - Add data source - Prometheus - <a href="http://192.168.67.4:9090" target="_blank" rel="noopener">http://192.168.67.4:9090</a> - Save &amp; Test</p>
<p>创建图表</p>
<ol>
<li>Click the graph title, then click “Edit”.</li>
<li>Under the “Metrics” tab, select your Prometheus data source (bottom right).</li>
<li>Enter any Prometheus expression into the “Query” field, while using the “Metric” field to lookup metrics via autocompletion.</li>
<li>To format the legend names of time series, use the “Legend format” input. For example, to show only the <code>method</code> and <code>status</code> labels of a returned query result, separated by a dash, you could use the legend format string <code> - </code>.</li>
<li>Tune other graph settings until you have a working graph.</li>
</ol>
<p>Add DashBoard - Add empty panel - ProQL Query - node_cpu_seconds_total</p>
<p>预定义图表</p>
<p>Add panel from the panel library</p>
<p>Example Prometheus 2.0 stats</p>
<p>可以编辑图标学习配置</p>
<p>Memory Profile</p>
<p>sum(process_resident_memory_bytes{job=”prometheus”})   该指标对应线条的标识 p8s process resident mem</p>
<p>process_virtual_memory_bytes{job=”prometheus”}</p>
<h3><span id="告警">告警</span></h3><hr>
<p>The <a href="https://github.com/prometheus/alertmanager" target="_blank" rel="noopener">Alertmanager</a> handles alerts sent by client applications such as the Prometheus server. It takes care of deduplicating, grouping, and routing them to the correct receiver integration such as email, PagerDuty, or OpsGenie. It also takes care of silencing and inhibition of alerts.</p>
<p>Alerting rules in Prometheus servers send alerts to an Alertmanager. The <a href="https://prometheus.io/docs/alerting/latest/alertmanager/" target="_blank" rel="noopener">Alertmanager</a> then manages those alerts</p>
<ul>
<li>Setup and <a href="https://prometheus.io/docs/alerting/latest/configuration/" target="_blank" rel="noopener">configure</a> the Alertmanager</li>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alertmanager_config" target="_blank" rel="noopener">Configure Prometheus</a> to talk to the Alertmanager</li>
<li>Create <a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" target="_blank" rel="noopener">alerting rules</a> in Prometheus</li>
</ul>
<p>下载</p>
<p><a href="https://github.com/prometheus/alertmanager" target="_blank" rel="noopener">alertmanager</a></p>
<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf alertmanager-0.22.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>



<p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;alertmanager --config.file&#x3D;alertmanager.yml</span><br></pre></td></tr></table></figure>





<p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  # The default SMTP From header field.</span><br><span class="line">  [ smtp_from: &lt;tmpl_string&gt; ]</span><br><span class="line">  # The default SMTP smarthost used for sending emails, including port number.</span><br><span class="line">  # Port number usually is 25, or 587 for SMTP over TLS (sometimes referred to as STARTTLS).</span><br><span class="line">  # Example: smtp.example.org:587</span><br><span class="line">  [ smtp_smarthost: &lt;string&gt; ]</span><br><span class="line">  # The default hostname to identify to the SMTP server.</span><br><span class="line">  [ smtp_hello: &lt;string&gt; | default &#x3D; &quot;localhost&quot; ]</span><br><span class="line">  # SMTP Auth using CRAM-MD5, LOGIN and PLAIN. If empty, Alertmanager doesn&#39;t authenticate to the SMTP server.</span><br><span class="line">  [ smtp_auth_username: &lt;string&gt; ]</span><br><span class="line">  # SMTP Auth using LOGIN and PLAIN.</span><br><span class="line">  [ smtp_auth_password: &lt;secret&gt; ]</span><br><span class="line">  # SMTP Auth using PLAIN.</span><br><span class="line">  [ smtp_auth_identity: &lt;string&gt; ]</span><br><span class="line">  # SMTP Auth using CRAM-MD5.</span><br><span class="line">  [ smtp_auth_secret: &lt;secret&gt; ]</span><br><span class="line">  # The default SMTP TLS requirement.</span><br><span class="line">  # Note that Go does not support unencrypted connections to remote SMTP endpoints.</span><br><span class="line">  [ smtp_require_tls: &lt;bool&gt; | default &#x3D; true ]</span><br><span class="line"></span><br><span class="line">  # The API URL to use for Slack notifications.</span><br><span class="line">  [ slack_api_url: &lt;secret&gt; ]</span><br><span class="line">  [ slack_api_url_file: &lt;filepath&gt; ]</span><br><span class="line">  [ victorops_api_key: &lt;secret&gt; ]</span><br><span class="line">  [ victorops_api_url: &lt;string&gt; | default &#x3D; &quot;https:&#x2F;&#x2F;alert.victorops.com&#x2F;integrations&#x2F;generic&#x2F;20131114&#x2F;alert&#x2F;&quot; ]</span><br><span class="line">  [ pagerduty_url: &lt;string&gt; | default &#x3D; &quot;https:&#x2F;&#x2F;events.pagerduty.com&#x2F;v2&#x2F;enqueue&quot; ]</span><br><span class="line">  [ opsgenie_api_key: &lt;secret&gt; ]</span><br><span class="line">  [ opsgenie_api_url: &lt;string&gt; | default &#x3D; &quot;https:&#x2F;&#x2F;api.opsgenie.com&#x2F;&quot; ]</span><br><span class="line">  [ wechat_api_url: &lt;string&gt; | default &#x3D; &quot;https:&#x2F;&#x2F;qyapi.weixin.qq.com&#x2F;cgi-bin&#x2F;&quot; ]</span><br><span class="line">  [ wechat_api_secret: &lt;secret&gt; ]</span><br><span class="line">  [ wechat_api_corp_id: &lt;string&gt; ]</span><br><span class="line"></span><br><span class="line">  # The default HTTP client configuration</span><br><span class="line">  [ http_config: &lt;http_config&gt; ]</span><br><span class="line"></span><br><span class="line">  # ResolveTimeout is the default value used by alertmanager if the alert does</span><br><span class="line">  # not include EndsAt, after this time passes it can declare the alert as resolved if it has not been updated.</span><br><span class="line">  # This has no impact on alerts from Prometheus, as they always include EndsAt.</span><br><span class="line">  [ resolve_timeout: &lt;duration&gt; | default &#x3D; 5m ]</span><br><span class="line"></span><br><span class="line"># Files from which custom notification template definitions are read.</span><br><span class="line"># The last component may use a wildcard matcher, e.g. &#39;templates&#x2F;*.tmpl&#39;.</span><br><span class="line">templates:</span><br><span class="line">  [ - &lt;filepath&gt; ... ]</span><br><span class="line"></span><br><span class="line"># The root node of the routing tree.</span><br><span class="line">route: &lt;route&gt;</span><br><span class="line"></span><br><span class="line"># A list of notification receivers.</span><br><span class="line">receivers:</span><br><span class="line">  - &lt;receiver&gt; ...</span><br><span class="line"></span><br><span class="line"># A list of inhibition rules.</span><br><span class="line">inhibit_rules:</span><br><span class="line">  [ - &lt;inhibit_rule&gt; ... ]</span><br><span class="line"></span><br><span class="line"># A list of mute time intervals for muting routes.</span><br><span class="line">mute_time_intervals:</span><br><span class="line">  [ - &lt;mute_time_interval&gt; ... ]</span><br></pre></td></tr></table></figure>



<p>Prometheus creates and sends alerts to the Alertmanager which then sends notifications out to different receivers based on their labels. A receiver can be one of many integrations including: Slack, PagerDuty, email, or a custom integration via the generic webhook interface.</p>
<p>Prometheus服务器根据报警规则将警报发送给Alertmanager，然后Alertmanager将静默（silencing）、抑制（inhibition）、分组聚合（aggregation）等消息通过Email、钉钉等发送通知。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line">  smtp_smarthost: &#39;smtp.163.com:25&#39;</span><br><span class="line">  smtp_from: &#39;liningwonder@163.com&#39;</span><br><span class="line">  smtp_auth_username: &#39;liningwonder@163.com&#39;</span><br><span class="line">  smtp_auth_password: &#39;VNYEAZYHEBQGGRNA&#39;</span><br><span class="line">  smtp_require_tls: false</span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  group_by: [&#39;alertname&#39;] &#x2F;&#x2F;与配置的规则一致</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 1h</span><br><span class="line">  receiver: email-receiver</span><br><span class="line">receivers:</span><br><span class="line">- name: &#39;email-receiver&#39;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &#39;lining@unionpaysmart.com&#39;</span><br><span class="line">    send_resolved: true</span><br><span class="line"></span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: &#39;critical&#39;</span><br><span class="line">    target_match:</span><br><span class="line">      severity: &#39;warning&#39;</span><br><span class="line">    equal: [&#39;alertname&#39;, &#39;dev&#39;, &#39;instance&#39;]</span><br></pre></td></tr></table></figure>



<p>配置rules</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets: [&quot;192.168.67.4:9093&quot;]</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span><br><span class="line">rule_files:</span><br><span class="line">    - &#39;prometheus.rules.yml&#39;</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#39;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label &#96;job&#x3D;&lt;job_name&gt;&#96; to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &#39;prometheus&#39;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &#39;&#x2F;metrics&#39;</span><br><span class="line">    # scheme defaults to &#39;http&#39;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">     - targets: [&#39;192.168.67.4:9090&#39;]</span><br><span class="line"></span><br><span class="line">  - job_name:       &#39;node&#39;</span><br><span class="line"></span><br><span class="line">    # Override the global default and scrape targets from this job every 5 seconds.</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#39;192.168.67.4:8080&#39;, &#39;192.168.67.4:8081&#39;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &#39;production&#39;</span><br><span class="line"></span><br><span class="line">      - targets: [&#39;192.168.67.3:8082&#39;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &#39;canary&#39;</span><br></pre></td></tr></table></figure>



<p>prometheus.rules.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: cpu-node</span><br><span class="line">  rules:</span><br><span class="line">  - record: job_instance_mode:node_cpu_seconds:avg_rate5m</span><br><span class="line">    expr: avg by (job, instance, mode) (rate(node_cpu_seconds_total[5m]))</span><br><span class="line">- name: alertname</span><br><span class="line">  rules:</span><br><span class="line">  - alert: NodeCpuUsage</span><br><span class="line">    expr: (rate(node_cpu_seconds_total[5m]))) &gt; 1</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      service_name: test</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      description: &quot;&#123;&#123;$labels.instance&#125;&#125;: CPU usage is above 99% (current value is: &#123;&#123; $value &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>





<p>待测试</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/06/25/redmine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/25/redmine/" class="post-title-link" itemprop="url">Redmine项目管理工具</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-25 00:00:00" itemprop="dateCreated datePublished" datetime="2021-06-25T00:00:00+08:00">2021-06-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-17 09:38:39" itemprop="dateModified" datetime="2022-01-17T09:38:39+08:00">2022-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redmine/" itemprop="url" rel="index"><span itemprop="name">Redmine</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->

<ul>
<li><a href="#1-安装rvm">1. 安装RVM</a></li>
<li><a href="#2-安装ruby">2. 安装Ruby</a></li>
<li><a href="#3-安装mysql">3. 安装MySQL</a></li>
<li><a href="#4-安装redmine">4. 安装Redmine</a></li>
<li><a href="#5-使用手册">5. 使用手册</a></li>
<li><a href="#6-gitlab集成等待ing">6. Gitlab集成（等待ing）</a></li>
</ul>
<!-- tocstop -->

<hr>
<h4><span id="1-安装rvm">1. 安装RVM</span></h4><p>Redmine基于Ruby on Rails 框架开发，为了方便管理Ruby版本，我们需要安装RVM.<br>RVM官网地址：<a href="http://rvm.io/" target="_blank" rel="noopener">http://rvm.io/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://get.rvm.io | bash -s stable</span><br><span class="line">curl -sSL https://rvm.io/mpapis.asc | gpg2 --import -</span><br><span class="line">curl -sSL https://rvm.io/pkuczynski.asc | gpg2 --import -</span><br><span class="line"><span class="built_in">source</span> /etc/profile.d/rvm.sh</span><br><span class="line">rvm reload</span><br><span class="line">rvm requirements run</span><br></pre></td></tr></table></figure>

<h4><span id="2-安装ruby">2. 安装Ruby</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rvm list known</span><br><span class="line">rvm install 2.7.2</span><br><span class="line">rvm list</span><br><span class="line">ruby -v</span><br><span class="line">gem -v</span><br></pre></td></tr></table></figure>

<p>设置Gem镜像源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gem <span class="built_in">source</span> -l</span><br><span class="line">gem <span class="built_in">source</span> –remove https://rubygems.org/</span><br><span class="line">gem sources --add https://gems.ruby-china.com/</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem sources --add https:&#x2F;&#x2F;gems.ruby-china.com&#x2F; --remove https:&#x2F;&#x2F;rubygems.org&#x2F;</span><br><span class="line">gem sources -l</span><br></pre></td></tr></table></figure>

<h4><span id="3-安装mysql">3. 安装MySQL</span></h4><p>前往MySQL官网下载mysql80-community-release-el7-3.noarch.rpm<br>地址：<a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">https://dev.mysql.com/downloads/mysql/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">yum repolist enabled | grep mysql</span><br><span class="line">yum install mysql-community-server</span><br><span class="line">systemctl start mysqld</span><br><span class="line">systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line">systemctl status mysqld</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">grep <span class="string">'temporary password'</span> /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'Lining@1234'</span>;</span><br><span class="line">use mysql;</span><br><span class="line">UPDATE user <span class="built_in">set</span> host = <span class="string">'%'</span> <span class="built_in">where</span> user = <span class="string">'root'</span>;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p>初始化Redmine数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE redmine CHARACTER SET utf8mb4;</span><br><span class="line">CREATE USER <span class="string">'redmine'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'Lining@1234'</span>;</span><br><span class="line">use mysql;</span><br><span class="line">UPDATE user <span class="built_in">set</span> host = <span class="string">'%'</span> <span class="built_in">where</span> user = <span class="string">'redmine'</span>;</span><br><span class="line">GRANT ALL PRIVILEGES ON redmine.* TO <span class="string">'redmine'</span>@<span class="string">'localhost'</span>;</span><br><span class="line"><span class="built_in">exit</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line">GRANT ALL PRIVILEGES ON redmine.* TO <span class="string">'redmine'</span>@<span class="string">'%'</span>;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<h4><span id="4-安装redmine">4. 安装Redmine</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install mysql-devel libcurl-devel ImageMagick ImageMagick-devel</span><br><span class="line">curl -LO http://www.redmine.org/releases/redmine-4.2.3.tar.gz</span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">wget http://www.redmine.org/releases/redmine-4.2.3.tar.gz</span><br><span class="line"><span class="built_in">cd</span> /home</span><br><span class="line">tar -zxvf redmine-4.2.3.tar.gz</span><br></pre></td></tr></table></figure>

<p>数据库配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/redmine-4.2.3</span><br><span class="line"><span class="built_in">cd</span> config</span><br><span class="line">cp database.yml.example  database.yml</span><br><span class="line">vi database.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">production:</span><br><span class="line">  adapter: mysql2</span><br><span class="line">  database: redmine</span><br><span class="line">  host: localhost</span><br><span class="line">  port: 3307</span><br><span class="line">  username: redmine</span><br><span class="line">  password: my_password</span><br></pre></td></tr></table></figure>

<p>By The Way - 使用mailx发送邮件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mailx</span><br><span class="line">vi /etc/mail.rc</span><br><span class="line"><span class="built_in">set</span> from=liningwonder@163.com</span><br><span class="line"><span class="built_in">set</span> smtp=smtp.163.com</span><br><span class="line"><span class="built_in">set</span> smtp-auth-user=liningwonder@163.com</span><br><span class="line"><span class="built_in">set</span> smtp-auth-password=客户端密码</span><br><span class="line"><span class="built_in">set</span> smtp-auth=login</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'test mail'</span> | mail -s <span class="string">'mail test'</span> lining@unionpaysmart.com</span><br></pre></td></tr></table></figure>

<p>Redmine邮箱配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/redmine-4.2.3</span><br><span class="line"><span class="built_in">cd</span> config</span><br><span class="line">cp configuration.yml.example configuration.yml</span><br><span class="line">vi configuration.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">default:</span><br><span class="line">  <span class="comment"># Outgoing emails configuration</span></span><br><span class="line">  <span class="comment"># See the examples below and the Rails guide for more configuration options:</span></span><br><span class="line">  <span class="comment"># http://guides.rubyonrails.org/action_mailer_basics.html#action-mailer-configuration</span></span><br><span class="line">  email_delivery:</span><br><span class="line">    delivery_method: :smtp</span><br><span class="line">    smtp_settings:</span><br><span class="line">      address: smtp.163.com</span><br><span class="line">      port: 25</span><br><span class="line">      domain: smtp.163.com</span><br><span class="line">      authentication: :login</span><br><span class="line">      user_name: liningwonder@163.com</span><br><span class="line">      password: 客户端密码</span><br><span class="line">      enable_starttls_auto: <span class="literal">true</span></span><br><span class="line">      openssl_verify_mode: <span class="string">'none'</span></span><br></pre></td></tr></table></figure>

<p>Redmine依赖安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/redmine-4.2.3</span><br><span class="line">bundle install --without development <span class="built_in">test</span></span><br><span class="line">bundle <span class="built_in">exec</span> rake generate_secret_token</span><br><span class="line">bundle <span class="built_in">exec</span> rake db:migrate RAILS_ENV=production</span><br><span class="line">bundle <span class="built_in">exec</span> rake redmine:load_default_data RAILS_ENV=production</span><br></pre></td></tr></table></figure>

<p>Redmine目录权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/redmine-4.2.3</span><br><span class="line">mkdir -p tmp tmp/pdf public/plugin_assets</span><br><span class="line">sudo chown -R redmine:redmine files <span class="built_in">log</span> tmp public/plugin_assets</span><br><span class="line">sudo chmod -R 755 files <span class="built_in">log</span> tmp public/plugin_assets</span><br></pre></td></tr></table></figure>

<p>启动测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bundle <span class="built_in">exec</span> rails server webrick -e production</span><br></pre></td></tr></table></figure>

<p>访问配置<br><a href="http://localhost:3000/">http://localhost:3000/</a></p>
<p>admin/admin</p>
<p>初次登陆修改密码<br>l13885346951n</p>
<p>邮箱配置<br>管理-配置-邮件通知-发件人邮箱</p>
<h4><span id="5-使用手册">5. 使用手册</span></h4><h4><span id="6-gitlab集成等待ing">6. Gitlab集成（等待ing）</span></h4>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/05/23/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/23/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">数据挖掘入门</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-23 00:00:00" itemprop="dateCreated datePublished" datetime="2021-05-23T00:00:00+08:00">2021-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-08 16:01:57" itemprop="dateModified" datetime="2021-07-08T16:01:57+08:00">2021-07-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98/" itemprop="url" rel="index"><span itemprop="name">数据挖掘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->

<ul>
<li><a href="#数据挖掘流程">数据挖掘流程</a></li>
<li><a href="#十大算法">十大算法</a><ul>
<li><a href="#分类算法">分类算法</a></li>
<li><a href="#聚类算法">聚类算法</a></li>
<li><a href="#关联分析">关联分析</a></li>
<li><a href="#连接分析">连接分析</a></li>
<li><a href="#预测">预测</a></li>
</ul>
</li>
<li><a href="#数学知识">数学知识</a></li>
<li><a href="#编程语言">编程语言</a></li>
<li><a href="#商业智能-bi-数据仓库-dw-数据挖掘-dm">商业智能 BI、数据仓库 DW、数据挖掘 DM</a></li>
<li><a href="#用户画像-精细化运营">用户画像 - 精细化运营</a><ul>
<li><a href="#用户唯一标识是整个用户画像的核心">用户唯一标识是整个用户画像的核心。</a></li>
<li><a href="#其次给用户打标签">其次，给用户打标签。</a></li>
</ul>
</li>
<li><a href="#决策树分类和回归">决策树（分类和回归）</a><ul>
<li><a href="#构造和剪枝">构造和剪枝</a></li>
<li><a href="#纯度和信息熵-信息熵越大纯度越低">纯度和信息熵- 信息熵越大，纯度越低</a></li>
<li><a href="#id3-算法">ID3 算法</a></li>
<li><a href="#c45-算法">C4.5 算法</a></li>
<li><a href="#cart算法">CART算法</a><ul>
<li><a href="#分类">分类</a></li>
<li><a href="#回归">回归</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#朴素贝叶斯">朴素贝叶斯</a></li>
<li><a href="#支持向量机">支持向量机</a></li>
<li><a href="#knn">KNN</a></li>
</ul>
<!-- tocstop -->

<hr>
<h2><span id="数据挖掘流程">数据挖掘流程</span></h2><ul>
<li>商业理解</li>
</ul>
<ul>
<li>数据理解</li>
</ul>
<ul>
<li>数据准备</li>
</ul>
<p>​       数据预处理中，我们会对数据进行几个处理步骤：数据清洗，数据集成，以及数据变换。</p>
<p>​       数据清洗：主要是为了去除重复数据，去噪声（即干扰数据）以及填充缺失值。</p>
<p>​       数据集成：是将多个数据源中的数据存放在一个统一的数据存储中。</p>
<p>​       数据变换：就是将数据转换成适合数据挖掘的形式。比如，通过归一化将属性数据按照比例缩放，这样就可以将数值落入一个特定的区间内，比如 0~1 之间。</p>
<ul>
<li>模型建立</li>
</ul>
<ul>
<li>模型评估</li>
</ul>
<ul>
<li>上线发布</li>
</ul>
<h2><span id="十大算法">十大算法</span></h2><h3><span id="分类算法">分类算法</span></h3><hr>
<p>就是通过训练集得到一个分类模型，然后用这个模型可以对其他数据进行分类。</p>
<ul>
<li>C4.5 算法</li>
</ul>
<p>​       C4.5 是决策树的算法，</p>
<ul>
<li>朴素贝叶斯（Naive Bayes）</li>
</ul>
<p>​       朴素贝叶斯模型是基于概率论的原理</p>
<ul>
<li>支持向量机（SVM - Support Vector Machine）</li>
</ul>
<p>​       VM 在训练中建立了一个超平面的分类模型</p>
<ul>
<li>K 最近邻算法(KNN - K-Nearest Neighbor)</li>
</ul>
<p>​       就是每个样本都可以用它最接近的 K 个邻居来代表</p>
<ul>
<li>Adaboost</li>
</ul>
<p>​       Adaboost 在训练中建立了一个联合的分类模型</p>
<ul>
<li>CART - Classification and Regression Trees</li>
</ul>
<p>​       CART 代表分类和回归树</p>
<h3><span id="聚类算法">聚类算法</span></h3><hr>
<p>聚类就是将数据自动聚类成几个类别，聚到一起的相似度大，不在一起的差异性大</p>
<ul>
<li>K-Means</li>
</ul>
<p>K-Means 算法是一个聚类算法</p>
<ul>
<li>最大似然估计</li>
</ul>
<p>EM 算法也叫最大期望算法，EM 算法经常用于聚类和机器学习领域中。</p>
<h3><span id="关联分析">关联分析</span></h3><hr>
<p>就是发现数据中的关联规则，它被广泛应用在购物篮分析，或事务数据分析中。</p>
<ul>
<li>Apriori </li>
</ul>
<p>Apriori 是一种挖掘关联规则（association rules）的算法，它通过挖掘频繁项集（frequent item sets）来揭示物品之间的关联关系，被广泛应用到商业挖掘和网络安全等领域中。常用于推荐系统。</p>
<h3><span id="连接分析">连接分析</span></h3><hr>
<ul>
<li>PageRank</li>
</ul>
<h3><span id="预测">预测</span></h3><hr>
<h2><span id="数学知识">数学知识</span></h2><p>概率论与数理统计、线性代数、图论、最优化方法</p>
<h2><span id="编程语言">编程语言</span></h2><p>毫无疑问选择Python，并了解相关得库NumPy、Pandas</p>
<h2><span id="商业智能-bi-数据仓库-dw-数据挖掘-dm">商业智能 BI、数据仓库 DW、数据挖掘 DM</span></h2><p> 三者之间的关系开头中的百货商店利用数据预测用户购物行为属于商业智能，他们积累的顾客的消费行为习惯会存储在数据仓库中，通过对个体进行消费行为分析总结出来的规律属于数据挖掘。</p>
<h2><span id="用户画像-精细化运营">用户画像 - 精细化运营</span></h2><h3><span id="用户唯一标识是整个用户画像的核心">用户唯一标识是整个用户画像的核心。</span></h3><hr>
<p>设计唯一标识可以从这些项中选择：用户名、注册手机号、联系人手机号、邮箱、设备号、CookieID 等，且后续数据仓库需要做ID-Mapping来关联这些ID.</p>
<h3><span id="其次给用户打标签">其次，给用户打标签。</span></h3><hr>
<p>可以说，用户画像是现实世界中的用户的数学建模，我们正是将海量数据进行标签化，来得到精准的用户画像，从而为企业更精准地解决问题。以用户消费行为分析为例，从这 4 个维度来进行标签划分。</p>
<p>用户标签：它包括了性别、年龄、地域、收入、学历、职业等。这些包括了用户的基础属性。</p>
<p>消费标签：消费习惯、购买意向、是否对促销敏感。这些统计分析用户的消费习惯。</p>
<p>行为标签：时间段、频次、时长、访问路径。这些是通过分析用户行为，来得到他们使用 App 的习惯。</p>
<p>内容分析：对用户平时浏览的内容，尤其是停留时间长、浏览次数多的内容进行分析，分析出用户对哪些内容感兴趣，比如，金融、娱乐、教育、体育、时尚、科技等。</p>
<p>最后，当你有了用户画像，可以为企业带来什么业务价值呢？我们可以从用户生命周期的三个阶段来划分业务价值，包括：获客、粘客和留客。</p>
<p>获客：如何进行拉新，通过更精准的营销获取客户。</p>
<p>粘客：个性化推荐，搜索排序，场景运营等。</p>
<p>留客：流失率预测，分析关键节点降低流失率。 留存率</p>
<p>如果按照数据流处理的阶段来划分用户画像建模的过程，可以分为数据层、算法层和业务层。你会发现在不同的层，都需要打上不同的标签。数据层指的是用户消费行为里的标签。我们可以打上“事实标签”，作为数据客观的记录。算法层指的是透过这些行为算出的用户建模。我们可以打上“模型标签”，作为用户画像的分类标识。业务层指的是获客、粘客、留客的手段。我们可以打上“预测标签”，作为业务关联的结果。</p>
<p>所以这个标签化的流程，就是通过数据层的“事实标签”，在算法层进行计算，打上“模型标签”的分类结果，最后指导业务层，得出“预测标签”。</p>
<p>以美团外卖为例：</p>
<p>用户标签：性别、年龄、家乡、居住地、收货地址、婚姻、宝宝信息、通过何种渠道进行的注册。</p>
<p>消费标签：餐饮口味、消费均价、团购等级、预定使用等级、排队使用等级、外卖等级。</p>
<p>行为标签：点外卖时间段、使用频次、平均点餐用时、访问路径。</p>
<p>内容分析：基于用户平时浏览的内容进行统计，包括餐饮口味、优惠敏感度等。</p>
<h2><span id="决策树分类和回归">决策树（分类和回归）</span></h2><p>决策树基本上就是把我们以前的经验总结出来。我给你准备了一个打篮球的训练集。如果我们要出门打篮球，一般会根据“天气”、“温度”、“湿度”、“刮风”这几个条件来判断，最后得到结果：去打篮球？还是不去？</p>
<h3><span id="构造和剪枝">构造和剪枝</span></h3><hr>
<p>构造</p>
<p>构造的过程就是选择什么属性作为节点的过程。节点之间存在父子关系。比如根节点会有子节点，子节点会有子子节点，但是到了叶节点就停止了，叶节点不存在子节点。那么在构造过程中，你要解决三个重要的问题：选择哪个属性作为根节点；选择哪些属性作为子节点；什么时候停止并得到目标状态，即叶节点。</p>
<p>剪枝</p>
<p>剪枝就是给决策树瘦身，这一步想实现的目标就是，不需要太多的判断，同样可以得到不错的结果。之所以这么做，是为了防止“过拟合”（Overfitting）现象的发生。</p>
<p>“过拟合”这个概念你一定要理解，它指的就是模型的训练结果“太好了”，以至于在实际应用的过程中，会存在“死板”的情况，导致分类错误。造成过拟合的原因之一就是因为训练集中样本量较小。如果决策树选择的属性过多，构造出来的决策树一定能够“完美”地把训练集中的样本分类，但是这样就会把训练集中一些数据的特点当成所有数据的特点，但这个特点不一定是全部数据的特点，这就使得这个决策树在真实的数据分类中出现错误，也就是模型的“泛化能力”差。</p>
<p>欠拟合，和过拟合就好比是下面这张图中的第一个和第三个情况一样，训练的结果“太好“，反而在实际应用过程中会导致分类错误。</p>
<p>预剪枝</p>
<p>预剪枝是在决策树构造时就进行剪枝。方法是在构造的过程中对节点进行评估，如果对某个节点进行划分，在验证集中不能带来准确性的提升，那么对这个节点进行划分就没有意义，这时就会把当前节点作为叶节点，不对其进行划分。</p>
<p>后剪枝</p>
<p>后剪枝就是在生成决策树之后再进行剪枝，通常会从决策树的叶节点开始，逐层向上对每个节点进行评估。如果剪掉这个节点子树，与保留该节点子树在分类准确性上差别不大，或者剪掉该节点子树，能在验证集中带来准确性的提升，那么就可以把该节点子树进行剪枝。方法是：用这个节点子树的叶子节点来替代该节点，类标记为这个节点子树中最频繁的那个类。</p>
<h3><span id="纯度和信息熵-信息熵越大纯度越低">纯度和信息熵- 信息熵越大，纯度越低</span></h3><hr>
<p>D3 算法，基于信息增益做判断；</p>
<p>C4.5 算法，基于信息增益率做判断；</p>
<p>CART 算法，分类树是基于基尼系数做判断。回归树是基于偏差做判断。</p>
<p>我在这里举个例子，假设有 3 个集合：集合 1：6 次都去打篮球；集合 2：4 次去打篮球，2 次不去打篮球；集合 3：3 次去打篮球，3 次不去打篮球。按照纯度指标来说，集合 1&gt; 集合 2&gt; 集合 3。因为集合 1 的分歧最小，集合 3 的分歧最大。</p>
<p>为了衡量这种信息的不确定性，信息学之父香农引入了信息熵的概念。当不确定性越大时，它所包含的信息量也就越大，信息熵也就越高。概率大，出现机会多，不确定性小；反之不确定性就大。</p>
<img src="/images/s.webp" width="74%" height="75%">



<p>在集合 1 中，有 6 次决策，其中打篮球是 5 次，不打篮球是 1 次。那么假设：类别 1 为“打篮球”，即次数为 5；类别 2 为“不打篮球”，即次数为 1。那么节点划分为类别 1 的概率是 5/6，为类别 2 的概率是 1/6，带入上述信息熵公式可以计算得出</p>
<p>从上面的计算结果中可以看出，信息熵越大，纯度越低。当集合中的所有样本均匀混合时，信息熵最大，纯度最低。</p>
<p>我们在构造决策树的时候，会基于纯度来构建。而经典的 “不纯度”的指标有三种，分别是信息增益（ID3 算法）、信息增益率（C4.5 算法）以及基尼指数（Cart 算法）。</p>
<h3><span id="id3-算法">ID3 算法</span></h3><hr>
<p>ID3 算法计算的是信息增益，信息增益指的就是划分可以带来纯度的提高，信息熵的下降。</p>
<p>它的计算公式，是父亲节点的信息熵减去所有子节点的信息熵。</p>
<img src="/images/sa.webp" width="74%" height="75%">

<p>在计算的过程中，我们会计算每个子节点的归一化信息熵，即按照每个子节点在父节点中出现的概率，来计算这些子节点的信息熵。于是我们通过 ID3 算法得到了一棵决策树。ID3 的算法规则相对简单，可解释性强。同样也存在缺陷，比如我们会发现 ID3 算法倾向于选择取值比较多的属性。这样，如果我们把“编号”作为一个属性（一般情况下不会这么做，这里只是举个例子），那么“编号”将会被选为最优属性 。但实际上“编号”是无关属性的，它对“打篮球”的分类并没有太大作用。</p>
<h3><span id="c45-算法">C4.5 算法</span></h3><hr>
<p>在 ID3 算法上进行改进的 C4.5 算法.</p>
<p>因为 ID3 在计算的时候，倾向于选择取值多的属性。为了避免这个问题，C4.5 采用信息增益率的方式来选择属性。</p>
<p>信息增益率 = 信息增益 / 属性熵.</p>
<p>1.采用信息增益率</p>
<p>采用信息增益率因为 ID3 在计算的时候，倾向于选择取值多的属性。为了避免这个问题，C4.5 采用信息增益率的方式来选择属性。信息增益率 = 信息增益 / 属性熵，具体的计算公式这里省略。当属性有很多值的时候，相当于被划分成了许多份，虽然信息增益变大了，但是对于 C4.5 来说，属性熵也会变大，所以整体的信息增益率并不大。</p>
<p>2.采用悲观剪枝</p>
<p>​        ID3 构造决策树的时候，容易产生过拟合的情况。在 C4.5 中，会在决策树构造之后采用悲观剪枝（PEP），这样可以提升决策树的泛        化能力。悲观剪枝是后剪枝技术中的一种，通过递归估算每个内部节点的分类错误率，比较剪枝前后这个节点的分类错误率来决定是否对其进行剪枝。这种剪枝方法不再需要一个单独的测试数据集。</p>
<p>3.离散化处理连续属性</p>
<p>C4.5 可以处理连续属性的情况，对连续的属性进行离散化的处理。比如打篮球存在的“湿度”属性，不按照“高、中”划分，而是按照湿度值进行计算，那么湿度取什么值都有可能。该怎么选择这个阈值呢，C4.5 选择具有最高信息增益的划分所对应的阈值。</p>
<p>4.处理缺失值</p>
<p>C4.5 在 ID3 的基础上，用信息增益率代替了信息增益，解决了噪声敏感的问题，并且可以对构造树进行剪枝、处理连续数值以及数值缺失等情况，但是由于 C4.5 需要对数据集进行多次扫描，算法效率相对较低。</p>
<h3><span id="cart算法">CART算法</span></h3><hr>
<p>CART 算法，英文全称叫做 Classification And Regression Tree，中文叫做分类回归树。ID3 和 C4.5 算法可以生成二叉树或多叉树，而 CART 只支持二叉树。同时 CART 决策树比较特殊，既可以作分类树，又可以作回归树。</p>
<p>我用下面的训练数据举个例子，你能看到不同职业的人，他们的年龄不同，学习时间也不同。如果我构造了一棵决策树，想要基于数据判断这个人的职业身份，这个就属于分类树，因为是从几个分类中来做选择。如果是给定了数据，想要预测这个人的年龄，那就属于回归树。</p>
<h4><span id="分类">分类</span></h4><p>分类树可以处理离散数据，也就是数据种类有限的数据，它输出的是样本的类别，</p>
<h4><span id="回归">回归</span></h4><p>而回归树可以对连续型的数值进行预测，也就是数据在某个区间内都有取值的可能，它输出的是一个数值。</p>
<p>实际上 CART 分类树与 C4.5 算法类似，只是属性选择的指标采用的是基尼系数。</p>
<p>基尼系数本身反应了样本的不确定度。当基尼系数越小的时候，说明样本之间的差异性小，不确定程度低。分类的过程本身是一个不确定度降低的过程，即纯度的提升过程。所以 CART 算法在构造分类树的时候，会选择基尼系数最小的属性作为属性的划分。</p>
<p>CART 分类树实际上是基于基尼系数来做属性划分的。在 Python 的 sklearn 中，如果我们想要创建 CART 分类树，可以直接使用 DecisionTreeClassifier 这个类。创建这个类的时候，默认情况下 criterion 这个参数等于 gini，也就是按照基尼系数来选择属性划分，即默认采用的是 CART 分类树。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># encoding&#x3D;utf-8</span><br><span class="line">from sklearn.model_selection import train_test_split</span><br><span class="line">from sklearn.metrics import accuracy_score</span><br><span class="line">from sklearn.tree import DecisionTreeClassifier</span><br><span class="line">from sklearn.datasets import load_iris</span><br><span class="line"># 准备数据集</span><br><span class="line">iris&#x3D;load_iris()</span><br><span class="line"># 获取特征集和分类标识</span><br><span class="line">features &#x3D; iris.data</span><br><span class="line">labels &#x3D; iris.target</span><br><span class="line"># 随机抽取33%的数据作为测试集，其余为训练集</span><br><span class="line">train_features, test_features, train_labels, test_labels &#x3D; train_test_split(features, labels, test_size&#x3D;0.33, random_state&#x3D;0)</span><br><span class="line"># 创建CART分类树</span><br><span class="line">clf &#x3D; DecisionTreeClassifier(criterion&#x3D;&#39;gini&#39;)</span><br><span class="line"># 拟合构造CART分类树</span><br><span class="line">clf &#x3D; clf.fit(train_features, train_labels)</span><br><span class="line"># 用CART分类树做预测</span><br><span class="line">test_predict &#x3D; clf.predict(test_features)</span><br><span class="line"># 预测结果与测试集结果作比对</span><br><span class="line">score &#x3D; accuracy_score(test_labels, test_predict)</span><br><span class="line">print(&quot;CART分类树准确率 %.4lf&quot; % score)</span><br></pre></td></tr></table></figure>



<p>CART 决策树的剪枝主要采用的是 CCP 方法，它是一种后剪枝的方法，英文全称叫做 cost-complexity prune，中文叫做代价复杂度。这种剪枝方式用到一个指标叫做节点的表面误差率增益值，以此作为剪枝前后误差的定义。用公式表示则是：</p>
<p>到目前为止，sklearn 中只实现了 ID3 与 CART 决策树，所以我们暂时只能使用这两种决策树，在构造 DecisionTreeClassifier 类时，其中有一个参数是 criterion，意为标准。它决定了构造的分类树是采用 ID3 分类树，还是 CART 分类树，对应的取值分别是 entropy 或者 gini：entropy: 基于信息熵，也就是 ID3 算法，实际结果与 C4.5 相差不大；gini：默认参数，基于基尼系数。CART 算法是基于基尼系数做属性划分的，所以 criterion=gini 时，实际上执行的是 CART 算法。</p>
<p>基于决策树还诞生了很多数据挖掘算法，比如随机森林（Random forest）。</p>
<h2><span id="朴素贝叶斯">朴素贝叶斯</span></h2><p>先验概率</p>
<p>通过经验来判断事情发生的概率，比如说“贝叶死”的发病率是万分之一，就是先验概率。再比如南方的梅雨季是 6-7 月，就是通过往年的气候总结出来的经验，这个时候下雨的概率就比其他时间高出很多。</p>
<p>后验概率</p>
<p>后验概率就是发生结果之后，推测原因的概率。比如说某人查出来了患有“贝叶死”，那么患病的原因可能是 A、B 或 C。患有“贝叶死”是因为原因 A 的概率就是后验概率。它是属于条件概率的一种。</p>
<p>条件概率</p>
<p>事件 A 在另外一个事件 B 已经发生条件下的发生概率，表示为 P(A|B)，读作“在 B 发生的条件下 A 发生的概率”。比如原因 A 的条件下，患有“贝叶死”的概率，就是条件概率。</p>
<p>似然函数</p>
<p>实际上贝叶斯原理就是求解后验概率</p>
<p>朴素贝叶斯</p>
<p>它是一种简单但极为强大的预测建模算法。之所以称为朴素贝叶斯，是因为它假设每个输入变量是独立的。这是一个强硬的假设，实际情况并不一定，但是这项技术对于绝大部分的复杂问题仍然非常有效。</p>
<p>为了训练朴素贝叶斯模型，我们需要先给出训练数据，以及这些数据对应的分类。那么上面这两个概率，也就是类别概率和条件概率。他们都可以从给出的训练数据中计算出来。一旦计算出来，概率模型就可以使用贝叶斯原理对新数据进行预测。</p>
<p>朴素贝叶斯分类是常用的贝叶斯分类方法。我们日常生活中看到一个陌生人，要做的第一件事情就是判断 TA 的性别，判断性别的过程就是一个分类的过程。根据以往的经验，我们通常会从身高、体重、鞋码、头发长短、服饰、声音等角度进行判断。这里的“经验”就是一个训练好的关于性别判断的模型，其训练数据是日常中遇到的各式各样的人，以及这些人实际的性别数据。朴素贝叶斯分类常用于文本分类，尤其是对于英文等语言来说，分类效果很好。它常用于垃圾文本过滤、情感预测、推荐系统等。</p>
<p>朴素贝叶斯分类最适合的场景就是文本分类、情感分析和垃圾邮件识别。其中情感分析和垃圾邮件识别都是通过文本来进行判断。从这里你能看出来，这三个场景本质上都是文本分类，这也是朴素贝叶斯最擅长的地方。所以朴素贝叶斯也常用于自然语言处理 NLP 的工具。</p>
<p>sklearn 的全称叫 Scikit-learn，它给我们提供了 3 个朴素贝叶斯分类算法，分别是高斯朴素贝叶斯（GaussianNB）、多项式朴素贝叶斯（MultinomialNB）和伯努利朴素贝叶斯（BernoulliNB）。</p>
<p>高斯朴素贝叶斯：特征变量是连续变量，符合高斯分布，比如说人的身高，物体的长度。</p>
<p>多项式朴素贝叶斯：特征变量是离散变量，符合多项分布，在文档分类中特征变量体现在一个单词出现的次数，或者是单词的 TF-IDF 值等。</p>
<p>伯努利朴素贝叶斯：特征变量是布尔变量，符合 0/1 分布，在文档分类中特征是单词是否出现。</p>
<p>词的 TF-IDF 值</p>
<p>TF-IDF 实际上是两个词组 Term Frequency 和 Inverse Document Frequency 的总称，两者缩写为 TF 和 IDF，分别代表了词频和逆向文档频率。词频 TF 计算了一个单词在文档中出现的次数，它认为一个单词的重要性和它在文档中出现的次数呈正比。逆向文档频率 IDF，是指一个单词在文档中的区分度。它认为一个单词出现在的文档数越少，就越能通过这个单词把该文档和其他文档区分开。IDF 越大就代表该单词的区分度越大。所以 TF-IDF 实际上是词频 TF 和逆向文档频率 IDF 的乘积。这样我们倾向于找到 TF 和 IDF 取值都高的单词作为区分，即这个单词在一个文档中出现的次数多，同时又很少出现在其他文档中。这样的单词适合用于分类。</p>
<p>TF-IDF=TF*IDF</p>
<h2><span id="支持向量机">支持向量机</span></h2><p>SVM 的英文叫 Support Vector Machine，中文名为支持向量机。它是常见的一种分类方法，在机器学习中，SVM 是有监督的学习模型。什么是有监督的学习模型呢？它指的是我们需要事先对数据打上分类标签，这样机器就知道这个数据属于哪个分类。同样无监督学习，就是数据没有被打上分类标签，这可能是因为我们不具备先验的知识，或者打标签的成本很高。所以我们需要机器代我们部分完成这个工作，比如将数据进行聚类，方便后续人工对每个类进行分析。SVM 作为有监督的学习模型，通常可以帮我们模式识别、分类以及回归分析。</p>
<p>在这里，二维平面变成了三维空间。原来的曲线变成了一个平面。这个平面，我们就叫做超平面。</p>
<p>用 SVM 计算的过程就是帮我们找到那个超平面的过程，这个超平面就是我们的 SVM 分类器。</p>
<p>实际上，我们的分类环境不是在二维平面中的，而是在多维空间中</p>
<p>SVM 就是帮我们找到一个超平面，这个超平面能将不同的样本划分开，同时使得样本集中的点到这个分类超平面的最小距离（即分类间隔，支持向量）最大化。</p>
<p>假如数据是完全的线性可分的，那么学习到的模型可以称为硬间隔支持向量机。换个说法，硬间隔指的就是完全分类准确，不能存在分类错误的情况。软间隔，就是允许一定量的样本分类错误。</p>
<p>另外还存在一种情况，就是非线性支持向量机。比如下面的样本集就是个非线性的数据。图中的两类数据，分别分布为两个圆圈的形状。那么这种情况下，不论是多高级的分类器，只要映射函数是线性的，就没法处理，SVM 也处理不了。这时，我们需要引入一个新的概念：核函数。它可以将样本从原始空间映射到一个更高维的特质空间中，使得样本在新的空间中线性可分。这样我们就可以使用原来的推导来进行计算，只是所有的推导是在新的空间，而不是在原来的空间中进行。所以在非线性 SVM 中，核函数的选择就是影响 SVM 最大的变量。最常用的核函数有线性核、多项式核、高斯核、拉普拉斯核、sigmoid 核，或者是这些核函数的组合。这些函数的区别在于映射方式的不同。通过这些核函数，我们就可以把样本空间投射到新的高维空间中。</p>
<p>SVM 本身是一个二值分类器，最初是为二分类问题设计的，也就是回答 Yes 或者是 No。而实际上我们要解决的问题，可能是多分类的情况，比如对文本进行分类，或者对图像进行识别。针对这种情况，我们可以将多个二分类器组合起来形成一个多分类器，常见的方法有“一对多法”和“一对一法”两种。</p>
<p>SVM 是有监督的学习模型，我们需要事先对数据打上分类标签，通过求解最大分类间隔来求解二分类问题。如果要求解多分类问题，可以将多个二分类器组合起来形成一个多分类器。</p>
<p>在 Python 的 sklearn 工具包中有 SVM 算法，首先需要引用工具包：</p>
<p>SVM 既可以做回归，也可以做分类器。当用 SVM 做回归的时候，我们可以使用 SVR 或 LinearSVR。SVR 的英文是 Support Vector Regression。这篇文章只讲分类，这里只是简单地提一下。当做分类器的时候，我们使用的是 SVC 或者 LinearSVC。SVC 的英文是 Support Vector Classification。</p>
<p>我们首先使用 SVC 的构造函数：model = svm.SVC(kernel=‘rbf’, C=1.0, gamma=‘auto’)，这里有三个重要的参数 kernel、C 和 gamma。kernel 代表核函数的选择，它有四种选择，只不过默认是 rbf，即高斯核函数。linear：线性核函数poly：多项式核函数rbf：高斯核函数（默认）sigmoid：sigmoid 核函数</p>
<p>线性核函数，是在数据线性可分的情况下使用的，运算速度快，效果好。不足在于它不能处理线性不可分的数据。多项式核函数可以将数据从低维空间映射到高维空间，但参数比较多，计算量大。高斯核函数同样可以将样本映射到高维空间，但相比于多项式核函数来说所需的参数比较少，通常性能不错，所以是默认使用的核函数。了解深度学习的同学应该知道 sigmoid 经常用在神经网络的映射中。因此当选用 sigmoid 核函数时，SVM 实现的是多层神经网络。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from sklearn import svm</span><br><span class="line"></span><br><span class="line"># 加载数据集，你需要把数据放到目录中</span><br><span class="line">data &#x3D; pd.read_csv(&quot;.&#x2F;data.csv&quot;)</span><br><span class="line"># 数据探索</span><br><span class="line"># 因为数据集中列比较多，我们需要把dataframe中的列全部显示出来</span><br><span class="line">pd.set_option(&#39;display.max_columns&#39;, None)</span><br><span class="line">print(data.columns)</span><br><span class="line">print(data.head(5))</span><br><span class="line">print(data.describe())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 将特征字段分成3组</span><br><span class="line">features_mean&#x3D; list(data.columns[2:12])</span><br><span class="line">features_se&#x3D; list(data.columns[12:22])</span><br><span class="line">features_worst&#x3D;list(data.columns[22:32])</span><br><span class="line"># 数据清洗</span><br><span class="line"># ID列没有用，删除该列</span><br><span class="line">data.drop(&quot;id&quot;,axis&#x3D;1,inplace&#x3D;True)</span><br><span class="line"># 将B良性替换为0，M恶性替换为1</span><br><span class="line">data[&#39;diagnosis&#39;]&#x3D;data[&#39;diagnosis&#39;].map(&#123;&#39;M&#39;:1,&#39;B&#39;:0&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 特征选择</span><br><span class="line">features_remain &#x3D; [&#39;radius_mean&#39;,&#39;texture_mean&#39;, &#39;smoothness_mean&#39;,&#39;compactness_mean&#39;,&#39;symmetry_mean&#39;, &#39;fractal_dimension_mean&#39;] </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 抽取30%的数据作为测试集，其余作为训练集</span><br><span class="line">train, test &#x3D; train_test_split(data, test_size &#x3D; 0.3)# in this our main data is splitted into train and test</span><br><span class="line"># 抽取特征选择的数值作为训练和测试数据</span><br><span class="line">train_X &#x3D; train[features_remain]</span><br><span class="line">train_y&#x3D;train[&#39;diagnosis&#39;]</span><br><span class="line">test_X&#x3D; test[features_remain]</span><br><span class="line">test_y &#x3D;test[&#39;diagnosis&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 采用Z-Score规范化数据，保证每个特征维度的数据均值为0，方差为1</span><br><span class="line">ss &#x3D; StandardScaler()</span><br><span class="line">train_X &#x3D; ss.fit_transform(train_X)</span><br><span class="line">test_X &#x3D; ss.transform(test_X)</span><br></pre></td></tr></table></figure>



<h2><span id="knn">KNN</span></h2><p>KNN中K 值的选择还是很重要的，如果 K 值比较小，就相当于未分类物体与它的邻居非常接近才行。这样产生的一个问题就是，如果邻居点是个噪声点，那么未分类物体的分类也会产生误差，这样 KNN 分类就会产生过拟合。如果 K 值比较大，相当于距离过远的点也会对未知物体的分类产生影响，虽然这种情况的好处是鲁棒性强，但是不足也很明显，会产生欠拟合情况，也就是没有把未分类物体真正分类出来。所以 K 值应该是个实践出来的结果，并不是我们事先而定的。在工程上，我们一般采用交叉验证的方式选取 K 值。交叉验证的思路就是，把样本集中的大部分样本作为训练集，剩余的小部分样本用于预测，来验证分类模型的准确性。所以在 KNN 算法中，我们一般会把 K 值选取在较小的范围内，同时在验证集上准确率最高的那一个最终确定作为 K 值。</p>
<p>在 KNN 算法中，还有一个重要的计算就是关于距离的度量。两个样本点之间的距离代表了这两个样本之间的相似度。距离越大，差异性越大；距离越小，相似度越大。</p>
<p>关于距离的计算方式有下面五种方式：欧氏距离；曼哈顿距离；闵可夫斯基距离；切比雪夫距离；余弦距离。</p>
<p>其实从上文你也能看出来，KNN 的计算过程是大量计算样本点之间的距离。为了减少计算距离次数，提升 KNN 的搜索效率，人们提出了 KD 树（K-Dimensional 的缩写）。KD 树是对数据点在 K 维空间中划分的一种数据结构。在 KD 树的构造中，每个节点都是 k 维数值点的二叉树。既然是二叉树，就可以采用二叉树的增删改查操作，这样就大大提升了搜索效率。在这里，我们不需要对 KD 树的数学原理了解太多，你只需要知道它是一个二叉树的数据结构，方便存储 K 维空间的数据就可以了。而且在 sklearn 中，我们直接可以调用 KD 树，很方便。</p>
<p>KNN 不仅可以做分类，还可以做回归。首先讲下什么是回归。在开头电影这个案例中，如果想要对未知电影进行类型划分，这是一个分类问题。首先看一下要分类的未知电影，离它最近的 K 部电影大多数属于哪个分类，这部电影就属于哪个分类。</p>
<p>同样 KNN 也可以用于推荐算法，虽然现在很多推荐系统的算法会使用 TD-IDF、协同过滤、Apriori 算法，不过针对数据量不大的情况下，采用 KNN 作为推荐算法也是可行的</p>
<p>在 Python 的 sklearn 工具包中有 KNN 算法。KNN 既可以做分类器，也可以做回归。如果是做分类，你需要引用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from sklearn.neighbors import KNeighborsClassifier</span><br></pre></td></tr></table></figure>

<p>从名字上你也能看出来 Classifier 对应的是分类，Regressor 对应的是回归。一般来说如果一个算法有 Classifier 类，都能找到相应的 Regressor 类。比如在决策树分类中，你可以使用 DecisionTreeClassifier，也可以使用决策树来做回归 DecisionTreeRegressor。好了，我们看下如何在 sklearn 中创建 KNN 分类器。这里，我们使用构造函数 KNeighborsClassifier(n_neighbors=5, weights=‘uniform’, algorithm=‘auto’, leaf_size=30)，这里有几个比较主要的参数，我分别来讲解下：1.n_neighbors：即 KNN 中的 K 值，代表的是邻居的数量。K 值如果比较小，会造成过拟合。如果 K 值比较大，无法将未知物体分类出来。一般我们使用默认值 5。2.weights：是用来确定邻居的权重，有三种方式：weights=uniform，代表所有邻居的权重相同；weights=distance，代表权重是距离的倒数，即与距离成反比；自定义函数，你可以自定义不同距离所对应的权重。大部分情况下不需要自己定义函数。手写数字数据集是个非常有名的用于图像识别的数据集。数字识别的过程就是将这些图片与分类结果 0-9 一一对应起来。完整的手写数字数据集 MNIST 里面包括了 60000 个训练样本，以及 10000 个测试样本。如果你学习深度学习的话，MNIST 基本上是你接触的第一个数据集。今天我们用 sklearn 自带的手写数字数据集做 KNN 分类，你可以把这个数据集理解成一个简版的 MNIST 数据集，它只包括了 1797 幅数字图像，每幅图像大小是 8<em>8 像素。好了，我们先来规划下整个 KNN 分类的流程：整个训练过程基本上都会包括三个阶段：数据加载：我们可以直接从 sklearn 中加载自带的手写数字数据集；准备阶段：在这个阶段中，我们需要对数据集有个初步的了解，比如样本的个数、图像长什么样、识别结果是怎样的。你可以通过可视化的方式来查看图像的呈现。通过数据规范化可以让数据都在同一个数量级的维度。另外，因为训练集是图像，每幅图像是个 8</em>8 的矩阵，我们不需要对它进行特征选择，将全部的图像数据作为特征值矩阵即可；分类阶段：通过训练可以得到分类器，然后用测试集进行准确率的计算。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/04/25/%E5%A4%A7%E8%AF%9D%E5%AE%89%E5%85%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/%E5%A4%A7%E8%AF%9D%E5%AE%89%E5%85%A8/" class="post-title-link" itemprop="url">IDaaS</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-25 00:00:00" itemprop="dateCreated datePublished" datetime="2021-04-25T00:00:00+08:00">2021-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-17 13:52:46" itemprop="dateModified" datetime="2022-01-17T13:52:46+08:00">2022-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IDaas/" itemprop="url" rel="index"><span itemprop="name">IDaas</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->

<ul>
<li><a href="#idaas">IDaaS</a><ul>
<li><a href="#5a级系统">5A级系统</a><ul>
<li><a href="#account">Account</a></li>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#authorization">Authorization</a></li>
<li><a href="#application">Application</a></li>
<li><a href="#audit">Audit</a></li>
</ul>
</li>
<li><a href="#授权协议与框架">授权协议与框架</a><ul>
<li><a href="#oauth-20">OAuth 2.0</a><ul>
<li><a href="#角色">角色</a></li>
<li><a href="#授权流程">授权流程</a></li>
<li><a href="#授权模式-authorization-grant">授权模式 - Authorization Grant</a><ul>
<li><a href="#授权码模式">授权码模式</a></li>
<li><a href="#隐式模式">隐式模式</a></li>
<li><a href="#密码模式">密码模式</a></li>
<li><a href="#客户端凭证模式">客户端凭证模式</a></li>
</ul>
</li>
<li><a href="#access-token-refresh-token">Access Token &amp; Refresh Token</a></li>
</ul>
</li>
<li><a href="#oidc-openid-connect">OIDC - OpenID Connect</a><ul>
<li><a href="#specifications">Specifications</a></li>
<li><a href="#libraries-products-and-tools">Libraries, Products, and Tools</a></li>
<li><a href="#open-banking-fapi">Open Banking &amp; FAPI</a></li>
</ul>
</li>
<li><a href="#spring-authorization-server">Spring Authorization Server</a><ul>
<li><a href="#spring-security">Spring Security</a></li>
<li><a href="#spring-security-oauth">Spring Security OAuth.</a></li>
<li><a href="#the-oauth-21-authorization-framework">The OAuth 2.1 Authorization Framework</a></li>
</ul>
</li>
<li><a href="#kerberos">Kerberos</a><ul>
<li><a href="#基本概念">基本概念</a><ul>
<li><a href="#主体-principal">主体 - principal</a></li>
<li><a href="#域-relam">域 - relam</a></li>
<li><a href="#密钥分发中心-kdc">密钥分发中心 -  KDC</a></li>
<li><a href="#认证流程">认证流程</a></li>
<li><a href="#使用">使用</a></li>
<li><a href="#kerberos配置">Kerberos配置</a></li>
<li><a href="#管理操作">管理操作</a></li>
<li><a href="#高级抽象">高级抽象</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#活动目录-ad">活动目录 - AD</a><ul>
<li><a href="#基本概念-1">基本概念</a></li>
<li><a href="#openldap">OpenLDAP</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

<hr>
<h2><span id="idaas">IDaaS</span></h2><h3><span id="5a级系统">5A级系统</span></h3><p>身份及服务(Identify as a Service，IDaaS)实际上就是一个基于 SaaS 模式的 IAM 解决方案,是以Sass提供集统一账户管理（Account）、统一身份认证（Authentication）、统一授权管理（Authorization）、统一应用管理（Application）、统一审计管理（Audit）五项能力于一体的统一身份平台。</p>
<h4><span id="account">Account</span></h4><p>账户管理</p>
<h4><span id="authentication">Authentication</span></h4><p>认证管理</p>
<h4><span id="authorization">Authorization</span></h4><p>授权管理</p>
<h4><span id="application">Application</span></h4><p>应用管理</p>
<h4><span id="audit">Audit</span></h4><p>审计管理</p>
<h3><span id="授权协议与框架">授权协议与框架</span></h3><h4><span id="oauth-20">OAuth 2.0</span></h4><p>OAuth 2.0是一种授权框架。官方地址：<a href="https://datatracker.ietf.org/doc/html/rfc6749" target="_blank" rel="noopener">https://datatracker.ietf.org/doc/html/rfc6749</a></p>
<h5><span id="角色">角色</span></h5><p>在OAuth 2.0中有以下4种角色：<br>   资源拥有者-resource owner 能够授予对受保护资源访问权限的实体<br>      An entity capable of granting access to a protected resource.<br>      When the resource owner is a person, it is referred to as an<br>      end-user.</p>
<p>   资源服务器-resource server 存储受保护资源的服务器<br>      The server hosting the protected resources, capable of accepting<br>      and responding to protected resource requests using access tokens.</p>
<p>   客户端-client 服务器向客户端（即应用）颁发访问令牌来验证资源所有者并获得授权<br>      An application making protected resource requests on behalf of the<br>      resource owner and with its authorization.  The term “client” does<br>      not imply any particular implementation characteristics (e.g.,<br>      whether the application executes on a server, a desktop, or other<br>      devices).</p>
<p>   授权服务器-authorization server<br>      The server issuing access tokens to the client after successfully<br>      authenticating the resource owner and obtaining authorization.</p>
<h5><span id="授权流程">授权流程</span></h5><p>OAuth 2.0的授权流程如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+--------+                               +---------------+</span><br><span class="line">    |        |--(A)- Authorization Request -&gt;|   Resource    |</span><br><span class="line">    |        |                               |     Owner     |</span><br><span class="line">    |        |&lt;-(B)-- Authorization Grant ---|               |</span><br><span class="line">    |        |                               +---------------+</span><br><span class="line">    |        |</span><br><span class="line">    |        |                               +---------------+</span><br><span class="line">    |        |--(C)-- Authorization Grant --&gt;| Authorization |</span><br><span class="line">    | Client |                               |     Server    |</span><br><span class="line">    |        |&lt;-(D)----- Access Token -------|               |</span><br><span class="line">    |        |                               +---------------+</span><br><span class="line">    |        |</span><br><span class="line">    |        |                               +---------------+</span><br><span class="line">    |        |--(E)----- Access Token ------&gt;|    Resource   |</span><br><span class="line">    |        |                               |     Server    |</span><br><span class="line">    |        |&lt;-(F)--- Protected Resource ---|               |</span><br><span class="line">    +--------+                               +---------------+</span><br></pre></td></tr></table></figure>



<h5><span id="授权模式-authorization-grant">授权模式 - Authorization Grant</span></h5><h6><span id="授权码模式">授权码模式</span></h6><p>Authorization Code<br>适用于具有完整前后端的传统 Web 应用以及移动或桌面端应用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">     | Resource |</span><br><span class="line">     |   Owner  |</span><br><span class="line">     |          |</span><br><span class="line">     +----------+</span><br><span class="line">          ^</span><br><span class="line">          |</span><br><span class="line">         (B)</span><br><span class="line">     +----|-----+          Client Identifier      +---------------+</span><br><span class="line">     |         -+----(A)-- &amp; Redirection URI ----&gt;|               |</span><br><span class="line">     |  User-   |                                 | Authorization |</span><br><span class="line">     |  Agent  -+----(B)-- User authenticates ---&gt;|     Server    |</span><br><span class="line">     |          |                                 |               |</span><br><span class="line">     |         -+----(C)-- Authorization Code ---&lt;|               |</span><br><span class="line">     +-|----|---+                                 +---------------+</span><br><span class="line">       |    |                                         ^      v</span><br><span class="line">      (A)  (C)                                        |      |</span><br><span class="line">       |    |                                         |      |</span><br><span class="line">       ^    v                                         |      |</span><br><span class="line">     +---------+                                      |      |</span><br><span class="line">     |         |&gt;---(D)-- Authorization Code ---------&#39;      |</span><br><span class="line">     |  Client |          &amp; Redirection URI                  |</span><br><span class="line">     |         |                                             |</span><br><span class="line">     |         |&lt;---(E)----- Access Token -------------------&#39;</span><br><span class="line">     +---------+       (w&#x2F; Optional Refresh Token)</span><br></pre></td></tr></table></figure>


<p>先看授权码模式，也叫 code 换 token 模式，我们以 Stack Overflow 使用 GitHub 登录为例（在这个过程中 Stack Overflow 是客户端，GitHub 是资源服务器，提供邮箱头像等资源信息，同时 GitHub 也是授权服务器，会颁发 token 给客户端）</p>
<p>第一步，点击登录后需要跳转到授权服务器地址，即 GitHub 的地址，并且必须在 URL 上携带 client_id 和 redirect_uri 以及 scope 等信息。<br><a href="https://github.com/login/oauth/authorize" target="_blank" rel="noopener">https://github.com/login/oauth/authorize</a>?<br>  client_id=01b478c0264a1fbd7183&amp;<br>  redirect_uri=<a href="https://stackauth.com/auth/oauth2/github&amp;" target="_blank" rel="noopener">https://stackauth.com/auth/oauth2/github&amp;</a><br>  response_type=code&amp;<br>  scope=user:email&amp;<br>  state=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</p>
<p>client_id 可以让 GitHub 知道是哪个客户端在请求资源，这里的 01b478c0264a1fbd7183 就是 Stack Overflow 在 GitHub 中注册的客户端 ID<br>redirect_uri 是授权成功或失败后的回调地址<br>response_type=code 表示使用授权码模式授权<br>scope 表示应用正在请求哪些权限<br>state 是一个随机字符串用来防止 CSRF 攻击</p>
<p>第二步，授权服务器会检查是否登录，未登录，则要求当前用户登录。然后当我们点击授权按钮后，这时授权服务器即 GitHub 会将浏览器重定向到第一步的 redirect_uri 参数指定的网址。并且跳转时，会携带一个授权码 code 参数（由 GitHub 后台生成的）以及 state 参数。<br><a href="https://stackauth.com/auth/oauth2/github" target="_blank" rel="noopener">https://stackauth.com/auth/oauth2/github</a>?<br>  code=1efc47a278d10a04f88e&amp;<br>  state=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</p>
<p>第三步，由于浏览器触发请求了 redirect_uri ，所以 Stack Overflow 网站后台可以接收到请求并拿到授权码 code 和 state ，这时就可以将 state 和第一步生成的 state 对比以防止 CSRF 和其他相关攻击。</p>
<p>第四步，Stack Overflow 可以拿着 client_id 、 client_secret 、 code 跟 GitHub 交换令牌，GitHub 收到请求以后就会校验 code 并颁发访问令牌（code 是有过期时间的，并且是一次性的）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;token HTTP&#x2F;1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">grant_type&#x3D;authorization_code&amp;code&#x3D;SplxlOBeZQQYbYS6WxSbIA</span><br><span class="line">&amp;redirect_uri&#x3D;https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Cache-Control: no-store</span><br><span class="line">Pragma: no-cache</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,</span><br><span class="line">  &quot;token_type&quot;:&quot;example&quot;,</span><br><span class="line">  &quot;expires_in&quot;:3600,</span><br><span class="line">  &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;,</span><br><span class="line">  &quot;example_parameter&quot;:&quot;example_value&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Request</span><br><span class="line">POST https:&#x2F;&#x2F;github.com&#x2F;login&#x2F;oauth&#x2F;access_token?</span><br><span class="line">  code&#x3D;1efc47a278d10a04f88e&amp;</span><br><span class="line">  client_id&#x3D;01b478c0264a1fbd7183&amp;</span><br><span class="line">  client_secret&#x3D;xxxxxx</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Response</span><br><span class="line">Accept: application&#x2F;json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;access_token&quot;:&quot;gho_16C7e42F292c6912E7710c838347Ae178B4a&quot;,</span><br><span class="line">  &quot;scope&quot;:&quot;user:email&quot;,</span><br><span class="line">  &quot;token_type&quot;:&quot;bearer&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第五步，Stack Overflow 使用 GitHub 颁发的访问令牌跟 GitHub 获取到所需的资源（用户邮箱地址），然后就走自己的业务流程了，一般就是重定向回首页。</p>
<h6><span id="隐式模式">隐式模式</span></h6><p>Implicit<br>适用于没有后端的基于浏览器（JavaScript）的纯前端应用。</p>
<pre><code>+----------+
| Resource |
|  Owner   |
|          |
+----------+
     ^
     |
    (B)
+----|-----+          Client Identifier     +---------------+
|         -+----(A)-- &amp; Redirection URI ---&gt;|               |
|  User-   |                                | Authorization |
|  Agent  -|----(B)-- User authenticates --&gt;|     Server    |
|          |                                |               |
|          |&lt;---(C)--- Redirection URI ----&lt;|               |
|          |          with Access Token     +---------------+
|          |            in Fragment
|          |                                +---------------+
|          |----(D)--- Redirection URI ----&gt;|   Web-Hosted  |
|          |          without Fragment      |     Client    |
|          |                                |    Resource   |
|     (F)  |&lt;---(E)------- Script ---------&lt;|               |
|          |                                +---------------+
+-|--------+
  |    |
 (A)  (G) Access Token
  |    |
  ^    v
+---------+
|         |
|  Client |
|         |
+---------+</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> GET &#x2F;authorize?response_type&#x3D;token&amp;client_id&#x3D;s6BhdRkqt3&amp;state&#x3D;xyz</span><br><span class="line">     &amp;redirect_uri&#x3D;https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP&#x2F;1.1</span><br><span class="line"> Host: server.example.com</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">HTTP&#x2F;1.1 302 Found</span><br><span class="line">Location: http:&#x2F;&#x2F;example.com&#x2F;cb#access_token&#x3D;2YotnFZFEjr1zCsicMWpAA</span><br><span class="line">          &amp;state&#x3D;xyz&amp;token_type&#x3D;example&amp;expires_in&#x3D;3600</span><br><span class="line"></span><br><span class="line">#或者</span><br><span class="line">HTTP&#x2F;1.1 302 Found</span><br><span class="line">Location: https:&#x2F;&#x2F;client.example.com&#x2F;cb#error&#x3D;access_denied&amp;state&#x3D;xyz</span><br></pre></td></tr></table></figure>



<h6><span id="密码模式">密码模式</span></h6><p>Resource Owner Password Credentials<br>适用于资源服务器和客户端之间高度信任的情况下，例如自家应用使用自家的资源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">     | Resource |</span><br><span class="line">     |  Owner   |</span><br><span class="line">     |          |</span><br><span class="line">     +----------+</span><br><span class="line">          v</span><br><span class="line">          |    Resource Owner</span><br><span class="line">         (A) Password Credentials</span><br><span class="line">          |</span><br><span class="line">          v</span><br><span class="line">     +---------+                                  +---------------+</span><br><span class="line">     |         |&gt;--(B)---- Resource Owner -------&gt;|               |</span><br><span class="line">     |         |         Password Credentials     | Authorization |</span><br><span class="line">     | Client  |                                  |     Server    |</span><br><span class="line">     |         |&lt;--(C)---- Access Token ---------&lt;|               |</span><br><span class="line">     |         |    (w&#x2F; Optional Refresh Token)   |               |</span><br><span class="line">     +---------+                                  +---------------+</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;token HTTP&#x2F;1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">grant_type&#x3D;password&amp;username&#x3D;johndoe&amp;password&#x3D;A3ddj3w</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Cache-Control: no-store</span><br><span class="line">Pragma: no-cache</span><br><span class="line">&#123;</span><br><span class="line">  &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,</span><br><span class="line">  &quot;token_type&quot;:&quot;example&quot;,</span><br><span class="line">  &quot;expires_in&quot;:3600,</span><br><span class="line">  &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;,</span><br><span class="line">  &quot;example_parameter&quot;:&quot;example_value&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h6><span id="客户端凭证模式">客户端凭证模式</span></h6><p>Client Credentials<br>适用于没有前端参与，纯后端交互的情况，期间没有用户的参与，客户端自己就是资源所有者。</p>
<pre><code>+---------+                                  +---------------+
|         |                                  |               |
|         |&gt;--(A)- Client Authentication ---&gt;| Authorization |
| Client  |                                  |     Server    |
|         |&lt;--(B)---- Access Token ---------&lt;|               |
|         |                                  |               |
+---------+                                  +---------------+</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;token HTTP&#x2F;1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">grant_type&#x3D;client_credentials</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Cache-Control: no-store</span><br><span class="line">Pragma: no-cache</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,</span><br><span class="line">  &quot;token_type&quot;:&quot;example&quot;,</span><br><span class="line">  &quot;expires_in&quot;:3600,</span><br><span class="line">  &quot;example_parameter&quot;:&quot;example_value&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>第一步，A 应用直接使用 client_id 和 client_secret 向 B 申请资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;b.com&#x2F;oauth&#x2F;token?</span><br><span class="line">grant_type&#x3D;client_credentials&amp;</span><br><span class="line">scope&#x3D;photo&amp;</span><br><span class="line">client_id&#x3D;xxx&amp;</span><br><span class="line">client_secret&#x3D;xxx</span><br></pre></td></tr></table></figure>
<p>第二步，B 作为授权服务器验证 A 客户端的 client_id 和 client_secret 是否合法，然后颁发访问令牌。</p>
<p>第三步，A 客户端携带访问令牌向 B 资源服务器获取 photo 资源。</p>
<h5><span id="access-token-amp-refresh-token">Access Token &amp; Refresh Token</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">+--------+                                           +---------------+</span><br><span class="line"> |        |--(A)------- Authorization Grant ---------&gt;|               |</span><br><span class="line"> |        |                                           |               |</span><br><span class="line"> |        |&lt;-(B)----------- Access Token -------------|               |</span><br><span class="line"> |        |               &amp; Refresh Token             |               |</span><br><span class="line"> |        |                                           |               |</span><br><span class="line"> |        |                            +----------+   |               |</span><br><span class="line"> |        |--(C)---- Access Token ----&gt;|          |   |               |</span><br><span class="line"> |        |                            |          |   |               |</span><br><span class="line"> |        |&lt;-(D)- Protected Resource --| Resource |   | Authorization |</span><br><span class="line"> | Client |                            |  Server  |   |     Server    |</span><br><span class="line"> |        |--(E)---- Access Token ----&gt;|          |   |               |</span><br><span class="line"> |        |                            |          |   |               |</span><br><span class="line"> |        |&lt;-(F)- Invalid Token Error -|          |   |               |</span><br><span class="line"> |        |                            +----------+   |               |</span><br><span class="line"> |        |                                           |               |</span><br><span class="line"> |        |--(G)----------- Refresh Token -----------&gt;|               |</span><br><span class="line"> |        |                                           |               |</span><br><span class="line"> |        |&lt;-(H)----------- Access Token -------------|               |</span><br><span class="line"> +--------+           &amp; Optional Refresh Token        +---------------+</span><br></pre></td></tr></table></figure>




<h4><span id="oidc-openid-connect">OIDC - OpenID Connect</span></h4><p>OIDC是一个基于 OAuth 2.0 的认证 + 授权框架，官网：<a href="https://openid.net/connect/" target="_blank" rel="noopener">https://openid.net/connect/</a></p>
<p>(Identity, Authentication) + OAuth 2.0 = OpenID Connect</p>
<p>OIDC 协议定义的名词和 OAuth 2.0 协议定义的稍微有些出入：</p>
<p>OpenID Provider ，简称 OP ：相当于 OAuth 2.0 中的授权服务器，除了负责颁发 Access Token ，还会颁发 ID Token 。例如 IDaaS 就是一个 OP 。</p>
<p>Relying Party ，简称 RP ：代指 OAuth 2.0 中的客户端。</p>
<p>End User ，简称 EU ：即用户。</p>
<h5><span id="specifications">Specifications</span></h5><p><a href="https://openid.net/developers/specs/" target="_blank" rel="noopener">https://openid.net/developers/specs/</a></p>
<h5><span id="libraries-products-and-tools">Libraries, Products, and Tools</span></h5><p><a href="https://openid.net/developers/libraries/" target="_blank" rel="noopener">https://openid.net/developers/libraries/</a></p>
<h5><span id="open-banking-amp-fapi">Open Banking &amp; FAPI</span></h5><p><a href="https://fapi.openid.net/" target="_blank" rel="noopener">https://fapi.openid.net/</a><br>Financial-grade API (FAPI) 金融级API</p>
<p>Open Banking</p>
<h4><span id="spring-authorization-server">Spring Authorization Server</span></h4><h5><span id="spring-security">Spring Security</span></h5><h5><span id="spring-security-oauth">Spring Security OAuth.</span></h5><h5><span id="the-oauth-21-authorization-framework">The OAuth 2.1 Authorization Framework</span></h5><p><a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-01" target="_blank" rel="noopener">https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-01</a></p>
<p>OAuth 2.1只有两种授权模式：</p>
<p>Authorization Code</p>
<p>An authorization code is a temporary credential used to obtain an access token.  Instead of the client requesting authorization directly from the resource owner, the client directs the resource owner to an authorization server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">   +----------+</span><br><span class="line">   | Resource |</span><br><span class="line">   |   Owner  |</span><br><span class="line">   |          |</span><br><span class="line">   +----------+</span><br><span class="line">        ^</span><br><span class="line">        |</span><br><span class="line">       (2)</span><br><span class="line">   +----|-----+          Client Identifier      +---------------+</span><br><span class="line">   |         -+----(1)-- &amp; Redirect URI    ----&gt;|               |</span><br><span class="line">   |  User-   |                                 | Authorization |</span><br><span class="line">   |  Agent  -+----(2)-- User authenticates ---&gt;|     Server    |</span><br><span class="line">   |          |                                 |               |</span><br><span class="line">   |         -+----(3)-- Authorization Code ---&lt;|               |</span><br><span class="line">   +-|----|---+                                 +---------------+</span><br><span class="line">     |    |                                         ^      v</span><br><span class="line">    (1)  (3)                                        |      |</span><br><span class="line">     |    |                                         |      |</span><br><span class="line">     ^    v                                         |      |</span><br><span class="line">   +---------+                                      |      |</span><br><span class="line">   |         |&gt;---(4)-- Authorization Code ---------&#39;      |</span><br><span class="line">   |  Client |          &amp; Redirect URI                     |</span><br><span class="line">   |         |                                             |</span><br><span class="line">   |         |&lt;---(5)----- Access Token -------------------&#39;</span><br><span class="line">   +---------+       (w&#x2F; Optional Refresh Token)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Client Credentials</span><br></pre></td></tr></table></figure>





<h4><span id="kerberos">Kerberos</span></h4><h5><span id="基本概念">基本概念</span></h5><h6><span id="主体-principal">主体 - principal</span></h6><p>用户主体 - user principal name - UPN      </p>
<p><a href="mailto:alice@EXAMPLE.COM">alice@EXAMPLE.COM</a></p>
<p>bob/admin@EXAMPLE.COM</p>
<p>服务主体 - service principal name - SPN</p>
<p>hdfs/node1.example.com@EXAMPLE.COM</p>
<h6><span id="域-relam">域 - relam</span></h6><p>即身份认证管理的区域。域和域之间可以建立单项或双向信任。</p>
<h6><span id="密钥分发中心-kdc">密钥分发中心 -  KDC</span></h6><p>key distribution center</p>
<p>KDC = kerberos数据库 + 认证服务（authentication service - AS） + 票据授予服务（ticket-granting service - TGS）</p>
<p> kerberos数据库用于存储主体以及域相关的信息</p>
<p>AS : 认证客户端，并发放票据授予票据 TGT（加密的）</p>
<p>TGS: 验证TGT，并发放服务票据</p>
<h6><span id="认证流程">认证流程</span></h6><p><a href="mailto:alice@EXAMPLE.COM">alice@EXAMPLE.COM</a> 向域EXAMPLE.COM所在的AS发起请求</p>
<p>AS响应并发放一个加密的TGT</p>
<p><a href="mailto:alice@EXAMPLE.COM">alice@EXAMPLE.COM</a>收到加密的TGT后，使用密码解密</p>
<p><a href="mailto:alice@EXAMPLE.COM">alice@EXAMPLE.COM</a>向TGS请求hdfs/node1.example.com@EXAMPLE.COM的服务票据，并提供自己的TGT</p>
<p>TGS验证TGT，然后发放服务票据</p>
<p><a href="mailto:alice@EXAMPLE.COM">alice@EXAMPLE.COM</a>携带服务票据向<a href="mailto:node1.example.com@EXAMPLE.COM">node1.example.com@EXAMPLE.COM</a>请求服务hdfs/node1.example.com@EXAMPLE.COM</p>
<h6><span id="使用">使用</span></h6><p>登录kerberos客户端所在的机器</p>
<p>（1）使用用户名和密码</p>
<p>kinit alice/admin@EXAMPLE.COM</p>
<p>输入密码：</p>
<p>（2）使用keytab文件（非交互式）</p>
<p>kinit -kt alice.keytab alice/admin@EXAMPLE.COM</p>
<p>（3）查看证书</p>
<p>klist</p>
<p>（4）销毁证书</p>
<p>kdestroy</p>
<h6><span id="kerberos配置">Kerberos配置</span></h6><p>服务端配置：/var/kerberos/krb5kdc/kdc.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[kdcdefaults]</span><br><span class="line">kdc_ports &#x3D; 88</span><br><span class="line">kdc_tcp_ports &#x3D; 88</span><br><span class="line"></span><br><span class="line">[realms]</span><br><span class="line">EXAMPLE.COM &#x3D; &#123;</span><br><span class="line">  acl_file &#x3D; &#x2F;var&#x2F;kerberos&#x2F;krb5kdc&#x2F;kadm5.acl</span><br><span class="line">  dict_file &#x3D; &#x2F;usr&#x2F;share&#x2F;dict&#x2F;words</span><br><span class="line">  supported_enctypes &#x3D; aes256-cts:normal</span><br><span class="line">  max_renewable_file &#x3D; 7d</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kadm5.acl 用于控制哪些用户具有管理kerberos的权限</p>
<p>kadmin.local 标识允许KDC所在服务器的root用户修改kerberos</p>
<p>kadmin 标识可以远程修改的用户</p>
<p>kadm5.acl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*&#x2F;admin@EXAMPLE.COM *</span><br><span class="line">cloudera-scm@EXAMPLE.COM * hdfs&#x2F;*@EXAMPLE.COM</span><br><span class="line">cloudera-scm@EXAMPLE.COM * mapred&#x2F;*@EXAMPLE.COM</span><br></pre></td></tr></table></figure>

<p>客户端配置：</p>
<p>/etc/krb5.conf</p>
<h6><span id="管理操作">管理操作</span></h6><p>使用kadmin登录</p>
<p>新增 ：addprinc <a href="mailto:alice@EXAMPLE.COM">alice@EXAMPLE.COM</a></p>
<p>enter password:</p>
<p>读：getprinc <a href="mailto:alice@EXAMPLE.COM">alice@EXAMPLE.COM</a></p>
<p>删：delprinc <a href="mailto:alice@EXAMPLE.COM">alice@EXAMPLE.COM</a></p>
<p>列：listprincs</p>
<h6><span id="高级抽象">高级抽象</span></h6><p>kerberos主体映射为用户名</p>
<p>hadoop将kerberos主体名映射为本地用户名</p>
<p>krb5.conf   auth_to_local</p>
<p>core-site.xml hadoop.security.auth_to_local</p>
<p>hadoop.security.group.mapping映射组名</p>
<p>JniBasesUnixGroupsMapping</p>
<p>LdapGroupsMapping  </p>
<p>映射回缓存，时间为300秒</p>
<p>LDAP AD</p>
<p>用户代理</p>
<p>hadoop.proxyuser.<proxy>.hosts</proxy></p>
<h3><span id="活动目录-ad">活动目录 - AD</span></h3><p>Active Directory - AD</p>
<p>活动目录域服务  Active Directory Dimain Services - AD DS</p>
<h4><span id="基本概念">基本概念</span></h4><p>命名空间 Namespace</p>
<p>对象：AD DS中的资源以独享形式存在，对象具有属性。用户对象，计算机对象</p>
<p>容器：属性或者对象的集合</p>
<p>组织单位：Organization Units, OU 是一个比较特殊的容器</p>
<p>域树：最上层的式根域，根域下面的称为子域，子域的域名包含父域的域名</p>
<p>域控制器</p>
<p>LDAP是一种用来查询和更新AD DS数据库的目录通讯协议</p>
<p>AD DS是用LDAP名称路径来表示对象再AD DS数据库中的位置</p>
<p>LDAP名称路径包含：</p>
<p>DN - Distinguished Name </p>
<p>CN=李宁,OU=技术部,OU=事业部,DC=sayms,DC=local</p>
<p>DC  Domain Compoment</p>
<p>OU Organization Units</p>
<p>CN Common Name</p>
<p>RDN Relative Distinguished Name</p>
<p>GUID 系统回自动为每一个对象指定一个GUID</p>
<p>UPN</p>
<p><a href="mailto:lining@sayms.local">lining@sayms.local</a></p>
<p>Windows Active Directory</p>
<p>Linux OpenLDAP</p>
<h4><span id="openldap">OpenLDAP</span></h4><p><a href="https://www.openldap.org/" target="_blank" rel="noopener">https://www.openldap.org/</a></p>
<p>安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#yum install openldap openldap-servers openldap-clients –y</span><br><span class="line"></span><br><span class="line">yum -y install openldap openldap-servers openldap-clients openldap-devel compat-openldap</span><br><span class="line"></span><br><span class="line">cp &#x2F;usr&#x2F;share&#x2F;openldap-servers&#x2F;DB_CONFIG.example &#x2F;var&#x2F;lib&#x2F;ldap&#x2F;DB_CONFIG</span><br><span class="line"></span><br><span class="line">cd &#x2F;etc&#x2F;openldap</span><br><span class="line"></span><br><span class="line">      &#x2F;etc&#x2F;openldap&#x2F;slapd.conf：OpenLDAP的主配置文件，记录根域信息，管理员名称，密码，日志，权限等</span><br><span class="line">      &#x2F;etc&#x2F;openldap&#x2F;slapd.d&#x2F;*：这下面是&#x2F;etc&#x2F;openldap&#x2F;slapd.conf配置信息生成的文件，每修改一次配置信息，这里的东西就要重新生成</span><br><span class="line">      &#x2F;etc&#x2F;openldap&#x2F;schema&#x2F;*：OpenLDAP的schema存放的地方</span><br><span class="line">      &#x2F;var&#x2F;lib&#x2F;ldap&#x2F;*：OpenLDAP的数据文件</span><br><span class="line">      &#x2F;usr&#x2F;share&#x2F;openldap-servers&#x2F;slapd.conf.obsolete 模板配置文件</span><br><span class="line">      &#x2F;usr&#x2F;share&#x2F;openldap-servers&#x2F;DB_CONFIG.example 模板数据库配置文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      OpenLDAP监听的端口：</span><br><span class="line">      默认监听端口：389（明文数据传输）</span><br><span class="line">      加密监听端口：636（密文数据传输）      </span><br><span class="line"></span><br><span class="line">cp &#x2F;usr&#x2F;share&#x2F;openldap-servers&#x2F;DB_CONFIG.example &#x2F;var&#x2F;lib&#x2F;ldap&#x2F;DB_CONFIG</span><br><span class="line">#cp &#x2F;usr&#x2F;share&#x2F;openldap-servers&#x2F;slapd.conf.obsolete &#x2F;etc&#x2F;openldap&#x2F;slapd.conf      </span><br><span class="line"></span><br><span class="line">cd &#x2F;etc&#x2F;openldap</span><br><span class="line">touch slapd.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chown -R ldap:ldap &#x2F;etc&#x2F;openldap</span><br><span class="line"></span><br><span class="line">chown -R ldap:ldap &#x2F;var&#x2F;lib&#x2F;ldap</span><br><span class="line"></span><br><span class="line">slappasswd</span><br><span class="line"></span><br><span class="line">123456</span><br><span class="line"></span><br><span class="line">123456</span><br><span class="line"></span><br><span class="line">&#123;SSHA&#125;p3SNf5+zpykzBFEMB1qBd5wfXJRS+ylN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># LDAP Defaults</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># See ldap.conf(5) for details</span><br><span class="line"># This file should be world readable but not world writable.</span><br><span class="line"></span><br><span class="line">#BASE    dc&#x3D;example,dc&#x3D;com</span><br><span class="line">#URI    ldap:&#x2F;&#x2F;ldap.example.com ldap:&#x2F;&#x2F;ldap-master.example.com:666</span><br><span class="line"></span><br><span class="line">#SIZELIMIT    12</span><br><span class="line">#TIMELIMIT    15</span><br><span class="line">#DEREF        never</span><br><span class="line"></span><br><span class="line">TLS_CACERTDIR    &#x2F;etc&#x2F;openldap&#x2F;certs</span><br><span class="line"></span><br><span class="line"># Turning this off breaks GSSAPI used with krb5 when rdns &#x3D; false</span><br><span class="line">SASL_NOCANON    on</span><br></pre></td></tr></table></figure>

<p><a href="https://www.openldap.org/software/download/OpenLDAP/openldap-release/" target="_blank" rel="noopener">https://www.openldap.org/software/download/OpenLDAP/openldap-release/</a></p>
<p><a href="https://www.oracle.com/webapps/redirect/signon?nexturl=https://download.oracle.com/otn/berkeley-db/db-4.6.21.tar.gz" target="_blank" rel="noopener">https://www.oracle.com/webapps/redirect/signon?nexturl=https://download.oracle.com/otn/berkeley-db/db-4.6.21.tar.gz</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"># $OpenLDAP: pkg&#x2F;ldap&#x2F;tests&#x2F;data&#x2F;regressions&#x2F;its4184&#x2F;slapd.conf,v 1.2.2.2 2010&#x2F;04&#x2F;19 19:14:30 quanah Exp $</span><br><span class="line">#</span><br><span class="line"># ITS 4184 slapd.conf</span><br><span class="line"></span><br><span class="line">include        @SCHEMADIR@&#x2F;core.schema</span><br><span class="line">include         @SCHEMADIR@&#x2F;cosine.schema</span><br><span class="line">include         @SCHEMADIR@&#x2F;nis.schema</span><br><span class="line">include         @SCHEMADIR@&#x2F;misc.schema</span><br><span class="line"></span><br><span class="line">pidfile        @TESTDIR@&#x2F;slapd.pid</span><br><span class="line">argsfile    @TESTDIR@&#x2F;slapd.args</span><br><span class="line"></span><br><span class="line">#mod#modulepath    ..&#x2F;servers&#x2F;slapd&#x2F;back-@BACKEND@&#x2F;</span><br><span class="line">#mod#moduleload    back_@BACKEND@.la</span><br><span class="line"></span><br><span class="line">loglevel    0</span><br><span class="line"></span><br><span class="line"># ACL issue: with this ACL doesn&#39;t show up</span><br><span class="line">#access to * by * write</span><br><span class="line"></span><br><span class="line"># database access control definitions</span><br><span class="line">access to attrs&#x3D;userPassword</span><br><span class="line">        by self write</span><br><span class="line">    by group&#x3D;&quot;cn&#x3D;A Group,ou&#x3D;Groups,dc&#x3D;example,dc&#x3D;com&quot; write</span><br><span class="line">    by group&#x3D;&quot;cn&#x3D;Another Group,ou&#x3D;Groups,dc&#x3D;example,dc&#x3D;com&quot; write</span><br><span class="line">        by anonymous auth</span><br><span class="line"></span><br><span class="line">access to *</span><br><span class="line">        by self write</span><br><span class="line">    by group&#x3D;&quot;cn&#x3D;Another Group,ou&#x3D;Groups,dc&#x3D;example,dc&#x3D;com&quot; write</span><br><span class="line">        by * read</span><br><span class="line"></span><br><span class="line">#######################################################################</span><br><span class="line"># database definitions</span><br><span class="line">#######################################################################</span><br><span class="line"></span><br><span class="line">database    @BACKEND@</span><br><span class="line">suffix        &quot;ou&#x3D;Special,dc&#x3D;example,dc&#x3D;com&quot;</span><br><span class="line">subordinate</span><br><span class="line">rootdn          &quot;cn&#x3D;Manager,dc&#x3D;example,dc&#x3D;com&quot;</span><br><span class="line">#~null~#directory    @TESTDIR@&#x2F;db.2.a</span><br><span class="line"></span><br><span class="line"># Indices to maintain</span><br><span class="line">#bdb#index        default pres,eq</span><br><span class="line">#bdb#index        objectClass eq</span><br><span class="line">#bdb#index        sn pres,eq,sub</span><br><span class="line">#hdb#index        default pres,eq</span><br><span class="line">#hdb#index        objectClass eq</span><br><span class="line">#hdb#index        sn pres,eq,sub</span><br><span class="line"></span><br><span class="line">database    @BACKEND@</span><br><span class="line">suffix        &quot;dc&#x3D;example,dc&#x3D;com&quot;</span><br><span class="line">rootdn        &quot;cn&#x3D;Manager,dc&#x3D;example,dc&#x3D;com&quot;</span><br><span class="line">rootpw        secret</span><br><span class="line">#null#bind        on</span><br><span class="line">#~null~#directory    @TESTDIR@&#x2F;db.1.a</span><br><span class="line"></span><br><span class="line"># Indices to maintain</span><br><span class="line">#bdb#index        default pres,eq</span><br><span class="line">#bdb#index        objectClass eq</span><br><span class="line">#bdb#index        sn pres,eq,sub</span><br><span class="line">#hdb#index        default pres,eq</span><br><span class="line">#hdb#index        objectClass eq</span><br><span class="line">#hdb#index        sn pres,eq,sub</span><br></pre></td></tr></table></figure>

<p>LDAPAdmin</p>
<p><a href="http://www.ldapadmin.org/" target="_blank" rel="noopener">http://www.ldapadmin.org/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/04/25/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BD%BF%E7%94%A8Nginx%E6%90%AD%E5%BB%BA%E7%9B%B4%E6%92%AD%E7%82%B9%E6%92%AD%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BD%BF%E7%94%A8Nginx%E6%90%AD%E5%BB%BA%E7%9B%B4%E6%92%AD%E7%82%B9%E6%92%AD%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">音视频技术实战：（一）使用Nginx搭建直播点播服务器</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-25 00:00:00" itemprop="dateCreated datePublished" datetime="2021-04-25T00:00:00+08:00">2021-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-17 09:38:39" itemprop="dateModified" datetime="2022-01-17T09:38:39+08:00">2022-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">音视频技术实战</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->

<ul>
<li><a href="#直播点播服务器组件安装">直播点播服务器组件安装</a><ul>
<li><a href="#编译工具安装">编译工具安装</a></li>
<li><a href="#推流工具ffmpeg安装">推流工具FFmpeg安装</a></li>
<li><a href="#nginx-安装">Nginx 安装</a></li>
<li><a href="#配置nginx">配置Nginx</a></li>
<li><a href="#配置详解">配置详解</a></li>
<li><a href="#测试">测试</a></li>
<li><a href="#obs-studio安装">OBS Studio安装</a></li>
<li><a href="#vlc-player安装">VLC Player安装</a></li>
<li><a href="#推流">推流</a></li>
<li><a href="#点播">点播</a></li>
<li><a href="#直播">直播</a></li>
<li><a href="#直播回放录制">直播回放录制</a></li>
</ul>
</li>
<li><a href="#多频道输入输出与权限控制">多频道输入输出与权限控制</a></li>
</ul>
<!-- tocstop -->

<hr>
<h2><span id="直播点播服务器组件安装">直播点播服务器组件安装</span></h2><h3><span id="编译工具安装">编译工具安装</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc cc cl</span><br><span class="line">yum -y install pcre pcre-devel openssl openssl-devel zlib-devel gd gd-devel perl perl-ExtUtils-Embed</span><br></pre></td></tr></table></figure>

<h3><span id="推流工具ffmpeg安装">推流工具FFmpeg安装</span></h3><p>下载地址：<a href="http://www.ffmpeg.org/download.html#releases" target="_blank" rel="noopener">http://www.ffmpeg.org/download.html#releases</a></p>
<p>参考教程：<a href="https://www.jianshu.com/p/164905257240" target="_blank" rel="noopener">https://www.jianshu.com/p/164905257240</a></p>
<p>依赖工具： Yasm : <a href="http://yasm.tortall.net/Download.html" target="_blank" rel="noopener">http://yasm.tortall.net/Download.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;home&#x2F;lining</span><br><span class="line">tar -zxvf yasm-1.3.0.tar.gz</span><br><span class="line">cd yasm-1.3.0</span><br><span class="line">.&#x2F;configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">tar -xvf ffmpeg-4.4.tar.xz</span><br><span class="line">cd ffmpeg-4.4</span><br><span class="line">.&#x2F;configure &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h3><span id="nginx-安装">Nginx 安装</span></h3><p>下载nginx-rtmp-module，地址：<a href="https://github.com/arut/nginx-rtmp-module/tree/v1.2.1" target="_blank" rel="noopener">https://github.com/arut/nginx-rtmp-module/tree/v1.2.1</a></p>
<p>下载openssl，地址：<a href="https://www.openssl.org/source/" target="_blank" rel="noopener">https://www.openssl.org/source/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;home&#x2F;lining</span><br><span class="line"></span><br><span class="line">unzip nginx-rtmp-module-1.2.1.zip</span><br><span class="line"></span><br><span class="line">tar -zxvf openssl-1.1.1.tar.gz</span><br><span class="line">.&#x2F;configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tar -zxvf nginx-1.17.9.tar.gz</span><br><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx --add-module&#x3D;..&#x2F;nginx-rtmp-module --with-http_ssl_module --with-debug</span><br></pre></td></tr></table></figure>

<h3><span id="配置nginx">配置Nginx</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">######################使用root启动</span><br><span class="line">user  root;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">#error_log  logs&#x2F;error.log;</span><br><span class="line">#error_log  logs&#x2F;error.log  notice;</span><br><span class="line">#error_log  logs&#x2F;error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rtmp &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 1935;</span><br><span class="line">        chunk_size 4000;</span><br><span class="line">        application vod &#123;</span><br><span class="line">            play &#x2F;opt&#x2F;video&#x2F;vod;</span><br><span class="line">        &#125;</span><br><span class="line">        application live &#123;</span><br><span class="line">            live on;</span><br><span class="line">            allow play all;</span><br><span class="line">        &#125;</span><br><span class="line">        application hls &#123;</span><br><span class="line">            live on;</span><br><span class="line">            hls on;</span><br><span class="line">            hls_path &#x2F;tmp&#x2F;hls;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">    #                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">    #                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs&#x2F;host.access.log  main;</span><br><span class="line">        location &#x2F;stat &#123;</span><br><span class="line">            rtmp_stat all;</span><br><span class="line">            rtmp_stat_stylesheet stat.xsl;</span><br><span class="line">        &#125;</span><br><span class="line">        location &#x2F;stat.xsl &#123;</span><br><span class="line">            root &#x2F;home&#x2F;lining&#x2F;nginx-rtmp-module-1.2.1&#x2F;;</span><br><span class="line">        &#125;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        location &#x2F;hls &#123;</span><br><span class="line">            types &#123;</span><br><span class="line">                application&#x2F;vnd.apple.mpegurl m3u8;</span><br><span class="line">                video&#x2F;mp2t ts;</span><br><span class="line">            &#125;</span><br><span class="line">            root &#x2F;tmp;</span><br><span class="line">            add_header Cache-Control no-cache;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3><span id="配置详解">配置详解</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;defonds&#x2F;article&#x2F;details&#x2F;9274479&#x2F;</span><br></pre></td></tr></table></figure>





<h3><span id="测试">测试</span></h3><p>访问：<a href="http://192.168.67.20/stat" target="_blank" rel="noopener">http://192.168.67.20/stat</a></p>
<h3><span id="obs-studio安装">OBS Studio安装</span></h3><p>地址：<a href="https://obsproject.com/zh-cn/download" target="_blank" rel="noopener">https://obsproject.com/zh-cn/download</a></p>
<p>录屏黑屏问题：兼容性设置、管理员权限设置、显卡设置（程序设置-集成显卡）</p>
<p>格式设置：flv</p>
<p>直播设置：</p>
<p>输出-高级-录像-自定义-输出到URL</p>
<p>rtmp://192.168.67.20/live/test1</p>
<h3><span id="vlc-player安装">VLC Player安装</span></h3><p>地址：<a href="https://www.videolan.org/" target="_blank" rel="noopener">https://www.videolan.org/</a></p>
<p>打开串流：rtmp://192.168.67.20/live/test1</p>
<h3><span id="推流">推流</span></h3><p>常见得推流工具或者客户端，电脑端推荐OBS</p>
<p>RTMP</p>
<p>使用命令：<br>./ffmpeg -re -i /home/lining/2.flv -c copy -f flv rtmp://192.168.67.20/live/test</p>
<p>点播</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp 2.flv &#x2F;opt&#x2F;video&#x2F;vod&#x2F;2.flv</span><br></pre></td></tr></table></figure>

<p>打开串流：rtmp://192.168.67.20/vod/2.flv</p>
<h3><span id="点播">点播</span></h3><p>flv.js</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>flv.js demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-class">.mainContainer</span> &#123;</span></span><br><span class="line">    display: block;</span><br><span class="line">    width: 1024px;</span><br><span class="line">    margin-left: auto;</span><br><span class="line">    margin-right: auto;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mainContainer"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">"videoElement"</span> <span class="attr">class</span>=<span class="string">"centeredVideo"</span> <span class="attr">controls</span> <span class="attr">autoplay</span> <span class="attr">width</span>=<span class="string">"1024"</span> <span class="attr">height</span>=<span class="string">"576"</span>&gt;</span></span><br><span class="line">        Your browser is too old which doesn't support HTML5 video.</span><br><span class="line">        <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcdn.net/ajax/libs/flv.js/1.5.0/flv.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> player = <span class="built_in">document</span>.getElementById(<span class="string">'videoElement'</span>);</span></span><br><span class="line">        if (flvjs.isSupported()) &#123;</span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> flvPlayer = flvjs.createPlayer(&#123;</span></span><br><span class="line"><span class="actionscript">                type: <span class="string">'flv'</span>,</span></span><br><span class="line"><span class="actionscript">                url: <span class="string">'http://192.168.67.20/2.flv'</span></span></span><br><span class="line">            &#125;);</span><br><span class="line">            flvPlayer.attachMediaElement(videoElement);</span><br><span class="line"><span class="actionscript">            flvPlayer.load(); <span class="comment">//加载</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h3><span id="直播">直播</span></h3><p>RTMP</p>
<p>OBS :   rtmp://192.168.67.20/live/test1</p>
<p>VLC :     rtmp://192.168.67.20/live/test1</p>
<p>HLS</p>
<p>OBS:  rtmp://192.168.67.20/hls/test2</p>
<p>VLC:   <a href="http://192.168.67.20/hls/test2.m3u8" target="_blank" rel="noopener">http://192.168.67.20/hls/test2.m3u8</a></p>
<p>Web:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;使用video.js实现hls流的直播播放&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;引入 video.js 库 </span><br><span class="line">&lt;link href&#x3D;&quot;https:&#x2F;&#x2F;unpkg.com&#x2F;video.js&#x2F;dist&#x2F;video-js.min.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;unpkg.com&#x2F;video.js&#x2F;dist&#x2F;video.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;设置video标签</span><br><span class="line">&lt;video id&#x3D;&quot;my-hls-player&quot; class&#x3D;&quot;video-js&quot;&gt;</span><br><span class="line">  &lt;source src&#x3D;&quot;http:&#x2F;&#x2F;192.168.67.20&#x2F;hls&#x2F;test2.m3u8&quot; type&#x3D;&quot;application&#x2F;x-mpegURL&quot;&gt;&lt;&#x2F;source&gt;</span><br><span class="line">&lt;&#x2F;video&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">&#x2F;&#x2F;创建 HLS 播放器实例</span><br><span class="line">var player &#x3D; videojs(&#39;my-hls-player&#39;, &#123;</span><br><span class="line">  controls:true,</span><br><span class="line">  autoplay:true,</span><br><span class="line">  preload:&#39;auto&#39;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">player.ready(function()&#123;</span><br><span class="line">  console.log(&#39;my-hls-player ready...&#39;);</span><br><span class="line">&#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>



<h3><span id="直播回放录制">直播回放录制</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">application hls &#123;</span><br><span class="line">    live on;</span><br><span class="line">    hls on;</span><br><span class="line">    hls_path &#x2F;tmp&#x2F;hls;</span><br><span class="line">    on_publish http:&#x2F;&#x2F;localhost:8080&#x2F;publish;</span><br><span class="line">    on_play http:&#x2F;&#x2F;localhost:8080&#x2F;play;</span><br><span class="line">    on_done http:&#x2F;&#x2F;localhost:8080&#x2F;done;</span><br><span class="line">    recorder all &#123;</span><br><span class="line">        record all;</span><br><span class="line">        record_unique on;</span><br><span class="line">        record_path &#x2F;home&#x2F;;</span><br><span class="line">        record_suffix -%d-%b-%y-%T.flv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2><span id="多频道输入输出与权限控制">多频道输入输出与权限控制</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">rtmp &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 1935;</span><br><span class="line">        chunk_size 4000;</span><br><span class="line">        application vod &#123;</span><br><span class="line">            play &#x2F;opt&#x2F;video&#x2F;vod;</span><br><span class="line">        &#125;</span><br><span class="line">        application live &#123;</span><br><span class="line">            live on;</span><br><span class="line">            allow play all;</span><br><span class="line">            publish_notify on;</span><br><span class="line">            on_publish  后端接口地址http:&#x2F;&#x2F;192.168.67.20&#x2F;auth</span><br><span class="line">        &#125;</span><br><span class="line">        application hls &#123;</span><br><span class="line">            live on;</span><br><span class="line">            hls on;</span><br><span class="line">            hls_path &#x2F;tmp&#x2F;hls;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>推流地址：</p>
<p>rtmp://192.168.67.20/live/test?token=123</p>
<p><a href="http://192.168.67.20/auth" target="_blank" rel="noopener">http://192.168.67.20/auth</a></p>
<p>该token为专用得推流密钥，为jwt，里面应包含用户唯一信息。</p>
<p>管理平台应该设计推流密钥管理得接口口，用于管理密钥（新增、删除），可以限制个数不超过10个。</p>
<p>application/x-www-form-urlencoded MIME type</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/auth"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">auth</span><span class="params">(String token, HttpServletRequest request,HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"123"</span>.equals(token)) &#123;</span><br><span class="line">            response.setStatus(<span class="number">200</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.setStatus(<span class="number">500</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1、用户点击创建房间，</p>
<p>（1）接口返回包含（房间名字room1）的推流地址以及对应的密钥 rtmp://192.168.67.20/live/room1?token=123</p>
<p>同时后端应把该token与该房间绑定。</p>
<p>从tcurl中获取房间名称</p>
<p>requestBody:{“app”:[“hls”],”flashver”:[“FMLE/3.0 (compatible; Lavf58.29”],”swfurl”:[“”],”tcurl”:[“rtmp://192.168.67.20:1935/hls”],”pageurl”:[“”],”addr”:[“192.168.67.1”],”clientid”:[“175”],”call”:[“publish”],”name”:[“test3”],”type”:[“live”],”token”:[“123”]}</p>
<p>2、权限验证接口 on_publish  <a href="http://192.168.67.20:8080/auth" target="_blank" rel="noopener">http://192.168.67.20:8080/auth</a>          </p>
<p>​      开启推流      验证token</p>
<p>3、直播结束  on_publish_done <a href="http://192.168.67.20:8080/auth" target="_blank" rel="noopener">http://192.168.67.20:8080/auth</a></p>
<p>​      结束推流     </p>
<p>4、加入房间 on_play url</p>
<p>客户端播放    ？ 怎么拿到客户端标识？  参考官方文档</p>
<p>HTTP request receives a number of arguments. POST method is used with application/x-www-form-urlencoded MIME type. The following arguments are passed to caller:</p>
<ul>
<li>call=play</li>
<li>addr - client IP address</li>
<li>clientid - nginx client id (displayed in log and stat)</li>
<li>app - application name</li>
<li>flashVer - client flash version</li>
<li>swfUrl - client swf url</li>
<li>tcUrl - tcUrl</li>
<li>pageUrl - client page url</li>
<li>name - stream name</li>
</ul>
<p>除此之外RTMP流所带的路径参数也会上送</p>
<p>参考：requestBody:{“app”:[“hls”],”flashver”:[“FMLE/3.0 (compatible; Lavf58.29”],”swfurl”:[“”],”tcurl”:[“rtmp://192.168.67.20:1935/hls”],”pageurl”:[“”],”addr”:[“192.168.67.1”],”clientid”:[“175”],”call”:[“publish”],”name”:[“test3”],”type”:[“live”],”token”:[“123”]}</p>
<p>5、离开房间 on_play_done</p>
<p>播放结束     ？ 怎么拿到客户端标识？</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/04/12/Java%E7%90%86%E8%AE%BA%E4%B8%8E%E5%AE%9E%E6%88%98%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/12/Java%E7%90%86%E8%AE%BA%E4%B8%8E%E5%AE%9E%E6%88%98%20/" class="post-title-link" itemprop="url">Java理论与实战</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-12 00:00:00" itemprop="dateCreated datePublished" datetime="2021-04-12T00:00:00+08:00">2021-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-17 09:38:39" itemprop="dateModified" datetime="2022-01-17T09:38:39+08:00">2022-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elastic-Stack/" itemprop="url" rel="index"><span itemprop="name">Elastic Stack</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->

<ul>
<li><a href="#java理论与实战">Java理论与实战</a><ul>
<li><a href="#java技术体系">Java技术体系</a><ul>
<li><a href="#jdk">JDK</a></li>
<li><a href="#jre">JRE</a></li>
</ul>
</li>
<li><a href="#jdk安装">JDK安装</a></li>
<li><a href="#java语言基础">Java语言基础</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

<hr>
<h2><span id="java理论与实战">Java理论与实战</span></h2><h3><span id="java技术体系">Java技术体系</span></h3><hr>
<p>Java技术体系包含：Java程序设计语言、Java虚拟机（JVM）、Java类库、第三方类库、Class文件格式等。</p>
<h4><span id="jdk">JDK</span></h4><p>JDK = Java程序设计语言 + Java虚拟机（JVM）+ Java类库</p>
<h4><span id="jre">JRE</span></h4><p>JRE = Java类库API中Java SE API子集 + JVM</p>
<p>JRE为运行Java程序的最小依赖</p>
<h3><span id="jdk安装">JDK安装</span></h3><hr>
<p>二进制包下载</p>
<p>Windows</p>
<p>以Oracle JDK + JCE Policy为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#Step 1</span><br><span class="line">点击jdk-8u221-windows-x64.exe安装</span><br></pre></td></tr></table></figure>

<p>Linux</p>
<p>以Oracle JDK + JCE Policy为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdk-8u221-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>







<h3><span id="java语言基础">Java语言基础</span></h3><hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/04/12/Elasticsearch%E7%90%86%E8%AE%BA%E4%B8%8E%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/12/Elasticsearch%E7%90%86%E8%AE%BA%E4%B8%8E%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">Elasticsearch理论与实战（一）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-12 00:00:00" itemprop="dateCreated datePublished" datetime="2021-04-12T00:00:00+08:00">2021-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-17 09:38:39" itemprop="dateModified" datetime="2022-01-17T09:38:39+08:00">2022-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elastic-Stack/" itemprop="url" rel="index"><span itemprop="name">Elastic Stack</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->

<ul>
<li><a href="#elasticsearch">Elasticsearch</a><ul>
<li><a href="#elasticsearch安装与配置">Elasticsearch安装与配置</a></li>
<li><a href="#索引设置">索引设置</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

<hr>
<h2><span id="elasticsearch">Elasticsearch</span></h2><h3><span id="elasticsearch安装与配置">Elasticsearch安装与配置</span></h3><p>Elasticsearch不能使用root安装，因此需新建一个用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /bin/bash -d /home/elk -m elk</span><br><span class="line">passwd elk</span><br><span class="line">app_!QAZxsw2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看用户过期时间</span></span><br><span class="line">chage -l elk</span><br><span class="line"><span class="meta">#</span><span class="bash">TODO 设置过期时间</span></span><br><span class="line">chage -M 99999 elk</span><br></pre></td></tr></table></figure>

<p>操作系统设置</p>
<p>设置文件文件句柄限制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#查看操作系统最大的文件句柄数</span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;file-max</span><br><span class="line">3261138</span><br><span class="line"></span><br><span class="line">#查看已分配的文件句柄</span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;file-nr</span><br><span class="line">5728	0	3261138</span><br><span class="line"></span><br><span class="line">#查看当前用户的文件句柄限制</span><br><span class="line">ulimit -a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#编辑文件句柄限制(最小值)</span><br><span class="line">vim &#x2F;etc&#x2F;security&#x2F;limits.conf</span><br><span class="line"></span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sysctl vm.max_map_count</span><br><span class="line">sysctl fs.file-max</span><br><span class="line">ulimit -n</span><br><span class="line">ulimit -u</span><br><span class="line"></span><br><span class="line">sysctl -w vm.max_map_count&#x3D;524288</span><br><span class="line">sysctl -w fs.file-max&#x3D;131072</span><br><span class="line">ulimit -n 131072</span><br><span class="line">ulimit -u 8192</span><br></pre></td></tr></table></figure>

<p>设置线程数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;security&#x2F;limits.d&#x2F;90-nproc.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#线程数</span><br><span class="line">* soft nproc 4096</span><br><span class="line">或者</span><br><span class="line">#</span><br><span class="line">* soft    nproc     unlimited</span><br></pre></td></tr></table></figure>

<p>设置虚拟内存区域</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line"></span><br><span class="line">#查看当前值</span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;max_map_count </span><br><span class="line">65530</span><br><span class="line"></span><br><span class="line">vi &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">vm.max_map_count&#x3D;262144</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看当前值</span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;max_map_count </span><br><span class="line">655360</span><br></pre></td></tr></table></figure>



<p>使用elk用户安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf elasticsearch-7.12.0-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir &#x2F;home&#x2F;elk&#x2F;elasticsearch-7.12.0&#x2F;data</span><br></pre></td></tr></table></figure>

<p>单节点配置</p>
<p>/home/elk/elasticsearch-7.12.0/elasticsearch.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: up-es</span><br><span class="line">node.name: node11</span><br><span class="line">path.data: &#x2F;es&#x2F;data&#x2F;data23</span><br><span class="line">path.logs: &#x2F;es&#x2F;logs&#x2F;logs23</span><br><span class="line">network.host: 192.168.67.11</span><br><span class="line">http.port: 9200</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.67.11&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;192.168.67.11&quot;]</span><br><span class="line">bootstrap.system_call_filter: false</span><br></pre></td></tr></table></figure>

<p>集群配置</p>
<p>/home/elk/elasticsearch-7.12.0/elasticsearch.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">up-es</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node11</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/es/data/data23</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/es/logs/logs23</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">192.168</span><span class="number">.67</span><span class="number">.11</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span> <span class="string">["192.168.67.11",</span> <span class="string">"192.168.67.12"</span><span class="string">,</span> <span class="string">"192.168.67.13"</span><span class="string">]</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> <span class="string">["node11",</span> <span class="string">"node12"</span><span class="string">,</span> <span class="string">"node13"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>



<p>生产配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Elasticsearch Configuration &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">#</span><br><span class="line"># NOTE: Elasticsearch comes with reasonable defaults for most settings.</span><br><span class="line">#       Before you set out to tweak and tune the configuration, make sure you</span><br><span class="line">#       understand what are you trying to accomplish and the consequences.</span><br><span class="line">#</span><br><span class="line"># The primary way of configuring a node is via this file. This template lists</span><br><span class="line"># the most important settings you may want to configure for a production cluster.</span><br><span class="line">#</span><br><span class="line"># Please consult the documentation for further information on configuration options:</span><br><span class="line"># https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;reference&#x2F;index.html</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Cluster -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Use a descriptive name for your cluster:</span><br><span class="line">#</span><br><span class="line">cluster.name: up-es</span><br><span class="line">#</span><br><span class="line"># ------------------------------------ Node ------------------------------------</span><br><span class="line">#</span><br><span class="line"># Use a descriptive name for the node:</span><br><span class="line">#</span><br><span class="line">node.name: node11</span><br><span class="line">#</span><br><span class="line"># Add custom attributes to the node:</span><br><span class="line">#</span><br><span class="line">#node.attr.rack: r1</span><br><span class="line">#</span><br><span class="line"># ----------------------------------- Paths ------------------------------------</span><br><span class="line">#</span><br><span class="line"># Path to directory where to store the data (separate multiple locations by comma):</span><br><span class="line">#</span><br><span class="line">path.data: &#x2F;es&#x2F;data&#x2F;data21</span><br><span class="line">#</span><br><span class="line"># Path to log files:</span><br><span class="line">#</span><br><span class="line">path.logs: &#x2F;es&#x2F;logs&#x2F;logs21</span><br><span class="line">#</span><br><span class="line"># ----------------------------------- Memory -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Lock the memory on startup:</span><br><span class="line">#</span><br><span class="line">#bootstrap.memory_lock: true</span><br><span class="line">#</span><br><span class="line"># Make sure that the heap size is set to about half the memory available</span><br><span class="line"># on the system and that the owner of the process is allowed to use this</span><br><span class="line"># limit.</span><br><span class="line">#</span><br><span class="line"># Elasticsearch performs poorly when the system is swapping the memory.</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Network -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Set the bind address to a specific IP (IPv4 or IPv6):</span><br><span class="line">#</span><br><span class="line">network.host: 192.168.67.11</span><br><span class="line">#</span><br><span class="line"># Set a custom port for HTTP:</span><br><span class="line">#</span><br><span class="line">http.port: 9200</span><br><span class="line">#</span><br><span class="line"># For more information, consult the network module documentation.</span><br><span class="line">#</span><br><span class="line"># --------------------------------- Discovery ----------------------------------</span><br><span class="line">#</span><br><span class="line"># Pass an initial list of hosts to perform discovery when this node is started:</span><br><span class="line"># The default list of hosts is [&quot;127.0.0.1&quot;, &quot;[::1]&quot;]</span><br><span class="line">#</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.67.11&quot;, &quot;192.168.67.12&quot;, &quot;192.168.67.13&quot;]</span><br><span class="line">#</span><br><span class="line"># Bootstrap the cluster using an initial set of master-eligible nodes:</span><br><span class="line">#</span><br><span class="line">cluster.initial_master_nodes: [&quot;node11&quot;, &quot;node12&quot;, &quot;node13&quot;]</span><br><span class="line">#</span><br><span class="line"># For more information, consult the discovery and cluster formation module documentation.</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Gateway -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Block initial recovery after a full cluster restart until N nodes are started:</span><br><span class="line">#</span><br><span class="line">#gateway.recover_after_nodes: 3</span><br><span class="line">#</span><br><span class="line"># For more information, consult the gateway module documentation.</span><br><span class="line">#</span><br><span class="line"># ---------------------------------- Various -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Require explicit names when deleting indices:</span><br><span class="line">#</span><br><span class="line">#action.destructive_requires_name: true</span><br></pre></td></tr></table></figure>



<p>分词插件安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;home&#x2F;elk&#x2F;elasticsearch-7.12.0&#x2F;plugins</span><br><span class="line">mkdir analysis-ik</span><br><span class="line"></span><br><span class="line">&#x2F;home&#x2F;elk&#x2F;elasticsearch-7.12.0&#x2F;plugins&#x2F;analysis-ik</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">unzip elasticsearch-analysis-ik-7.12.0.zip</span><br></pre></td></tr></table></figure>

<p>Java参数设置</p>
<p>/home/elk/elasticsearch-7.12.0/config/jvm.options</p>
<p>/home/elk/elasticsearch-7.12.0/bin/elasticsearch</p>
<p>start.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Licensed to the China UnionPay License (UPL)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> lining@unionpaysmart.com</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> All rights reversed</span></span><br><span class="line"><span class="meta">#</span><span class="bash">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> shellcheck <span class="built_in">disable</span>=SC2046</span></span><br><span class="line">APP_HOME_PATH=$(cd `dirname $0`; pwd)</span><br><span class="line">cd $APP_HOME_PATH</span><br><span class="line">nohup ./elasticsearch &gt;&gt; start_elk.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<p>常见问题问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java.lang.UnsupportedOperationException: seccomp unavailable: requires kernel 3.5+ with CONFIG_SECCOMP and CONFIG_SECCOMP_FILTER compiled in</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bootstrap check failure [1] of [3]: max number of threads [1024] for user [elk] is too low, increase to at least [4096]</span><br><span class="line">bootstrap check failure [2] of [3]: system call filters failed to install; check the logs and fix your configuration or disable system call filters at your own risk</span><br><span class="line">bootstrap check failure [3] of [3]: the default discovery settings are unsuitable for production use; at least one of [discovery.seed_hosts, discovery.seed_providers, cluster.initial_master_nodes] must be configured</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">max file descriptors [1024] for elasticsearch process is too low, increase to at least [65536]</span><br><span class="line"></span><br><span class="line">max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</span><br><span class="line"></span><br><span class="line">system call filters failed to install; check the logs and fix your configuration or disable system call filters at your own risk</span><br><span class="line"></span><br><span class="line">max number of threads [1024] for user [lish] likely too low, increase to at least [2048]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ERROR: [1] bootstrap checks failed. You must address the points described in the following [1] lines before starting Elasticsearch.</span><br><span class="line">bootstrap check failure [1] of [1]: max number of threads [1024] for user [elk] is too low, increase to at least [4096]</span><br><span class="line">ERROR: Elasticsearch did not exit normally - check the logs at &#x2F;home&#x2F;elk&#x2F;elasticsearch-7.12.0&#x2F;logs&#x2F;up-es.log</span><br></pre></td></tr></table></figure>



<h3><span id="索引设置">索引设置</span></h3><p>常用命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http:&#x2F;&#x2F;127.0.0.1:9200&#x2F;_cat&#x2F;health?v</span><br><span class="line"></span><br><span class="line">curl -XGET http:&#x2F;&#x2F;127.0.0.1:9200&#x2F;_cat&#x2F;indices?v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XPUT http:&#x2F;&#x2F;127.0.0.1:9200&#x2F;merchant?include_type_name&#x3D;true -H &quot;Content-Type: application&#x2F;json&quot; -d &#39;&#123;&quot;mappings&quot;:&#123;&quot;_doc&quot;:&#123;&quot;properties&quot;:&#123;&quot;smallMchntId&quot;:&#123;&quot;type&quot;:&quot;keyword&quot;&#125;,&quot;mchntNm&quot;:&#123;&quot;type&quot;:&quot;text&quot;,&quot;analyzer&quot;:&quot;ik_max_word&quot;&#125;,&quot;mchntCd&quot;:&#123;&quot;type&quot;:&quot;keyword&quot;&#125;,&quot;location&quot;:&#123;&quot;type&quot;:&quot;geo_point&quot;&#125;&#125;&#125;&#125;&#125;&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XGET http:&#x2F;&#x2F;127.0.0.1:9200&#x2F;merchant&#x2F;_settings?pretty</span><br><span class="line"></span><br><span class="line">curl -XGET http:&#x2F;&#x2F;127.0.0.1:9200&#x2F;_cat&#x2F;indices?v</span><br><span class="line"></span><br><span class="line">curl -XDELETE http:&#x2F;&#x2F;127.0.0.1:9200&#x2F;merchant</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XGET &quot;http:&#x2F;&#x2F;192.168.67.20:9200&#x2F;merchant&#x2F;_doc&#x2F;_search&quot; -H &#39;Content-Type: application&#x2F;json&#39; -d &#39;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;, &quot;from&quot;:0, &quot;size&quot;:1&#125;&#39;</span><br><span class="line"></span><br><span class="line">curl -XGET &quot;http:&#x2F;&#x2F;192.168.67.20:9200&#x2F;merchant&#x2F;_doc&#x2F;_search&quot; -H &#39;Content-Type: application&#x2F;json&#39; -d &#39;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;mchntCd&quot;:&quot;123456789123456&quot;&#125;&#125;, &quot;from&quot;:0, &quot;size&quot;:1&#125;&#39;</span><br><span class="line"></span><br><span class="line">curl -XDELETE http:&#x2F;&#x2F;192.168.67.20:9200&#x2F;merchant&#x2F;_doc&#x2F;id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#分页问题</span><br><span class="line">index.max_result_window: 100000000</span><br><span class="line"></span><br><span class="line">curl -XGET http:&#x2F;&#x2F;192.168.67.20:9200&#x2F;merchant&#x2F;_settings?pretty</span><br><span class="line"></span><br><span class="line">curl -XGET &quot;http:&#x2F;&#x2F;192.168.67.20:9200&#x2F;merchant&#x2F;_search&quot; -H &#39;Content-Type: application&#x2F;json&#39; -d&#39;&#123;&quot;query&quot;:&#123; &quot;match&quot;: &#123;&quot;mchntCd&quot;: &quot;123456789123456&quot;&#125;&#125;&#125;&#39;</span><br><span class="line"></span><br><span class="line">curl -XGET &quot;http:&#x2F;&#x2F;192.168.67.20:9200&#x2F;merchant&#x2F;_search&quot; -H &#39;Content-Type: application&#x2F;json&#39; -d&#39;&#123;&quot;query&quot;:&#123; &quot;bool&quot;: &#123;&quot;must&quot;:&#123;&quot;exists&quot;:&#123;&quot;field&quot;: &quot;location&quot;&#125;&#125;&#125;&#125;, &quot;from&quot;:0, &quot;size&quot;:1&#125;&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XPUT http:&#x2F;&#x2F;127.0.0.1:9200&#x2F;_settings -d &#39;&#123; &quot;index&quot; : &#123; &quot;max_result_window&quot; : 100000000&#125;&#125;‘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XPUT http:&#x2F;&#x2F;192.168.67.20:9200&#x2F;merchant&#x2F;_settings   -H &#39;Content-Type: application&#x2F;json&#39;  -d &#39;&#123; &quot;index&quot; : &#123; &quot;max_result_window&quot; : 100000000&#125;&#125;‘</span><br></pre></td></tr></table></figure>



<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"_doc"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">		<span class="attr">"orderId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"date"</span>: &#123;</span><br><span class="line">		  <span class="attr">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">          <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"hostTp"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">		  <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"request"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"response"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">          <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">    <span class="attr">"_doc"</span>: &#123;</span><br><span class="line">      <span class="attr">"properties"</span>: &#123;</span><br><span class="line">		<span class="attr">"seqId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"prodUsrId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"prodId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"srvId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"blId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">        &#125;,		</span><br><span class="line">	    <span class="attr">"msgId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"retCd"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"bl"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"chanId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"recCrtTm"</span>: &#123;</span><br><span class="line">		  <span class="attr">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">          <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"recUptTm"</span>: &#123;</span><br><span class="line">		  <span class="attr">"type"</span>: <span class="string">"date"</span>,</span><br><span class="line">          <span class="attr">"format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"ver"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"integer"</span>,</span><br><span class="line">		  <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"shpNum"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"bkCdNum"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"mapId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"bkNm"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"name"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"certifId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,	</span><br><span class="line">	    <span class="attr">"mobile"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"telecoms"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">		  <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"orgId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"integer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"transDuration"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"totalDuration"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"long"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"scName"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"orderId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"transId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"responseId"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"retMsg"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">		  <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"scUsageScenarios"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">		  <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"scUsePurpose"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">		  <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"protocolVerNm"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">		  <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"serialNm"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">		  <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">	    <span class="attr">"channelCode"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"chanbl"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"integer"</span>,</span><br><span class="line">		  <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,	</span><br><span class="line">        <span class="attr">"ipType"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"sourceIp"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"bussProdName"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">          <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;,</span><br><span class="line">		<span class="attr">"hostIp"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">		  <span class="attr">"index"</span>: <span class="string">"false"</span></span><br><span class="line">        &#125;		</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_doc&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;companyId&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;entName&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;entTypeId&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;estDate&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">          &quot;format&quot;:  &quot;yyyy-MM-dd&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;historyName&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;industryId&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;keyPerson&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;provinceId&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;regCap&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;double&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;regNo&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;uniscId&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">李宁</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李宁</span>
</div>
  <div class="powered-by">万物之始，大道至简
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">知易行难，悟在天成
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
