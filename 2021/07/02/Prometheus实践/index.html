<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"localhost","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Prometheus 下载 下载 配置 存储 启动 问题 配置监控目标—Node Exporter 可视化 告警       Prometheus 下载下载 1234567891011121314151617181920wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;prometheus&#x2F;releases&#x2F;do">
<meta property="og:type" content="article">
<meta property="og:title" content="Prometheus">
<meta property="og:url" content="http://localhost:4000/2021/07/02/Prometheus%E5%AE%9E%E8%B7%B5/index.html">
<meta property="og:site_name" content="李宁的博客">
<meta property="og:description" content="Prometheus 下载 下载 配置 存储 启动 问题 配置监控目标—Node Exporter 可视化 告警       Prometheus 下载下载 1234567891011121314151617181920wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;prometheus&#x2F;releases&#x2F;do">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-07-01T16:00:00.000Z">
<meta property="article:modified_time" content="2022-01-17T01:38:39.067Z">
<meta property="article:author" content="李宁">
<meta property="article:tag" content="Prometheus">
<meta property="article:tag" content="Grafana">
<meta property="article:tag" content="Alertmanager">
<meta property="article:tag" content="Node Expoter">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://localhost:4000/2021/07/02/Prometheus%E5%AE%9E%E8%B7%B5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>Prometheus | 李宁的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">李宁的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/2021/07/02/Prometheus%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李宁">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李宁的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Prometheus
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2021-07-02T00:00:00+08:00">2021-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-17 09:38:39" itemprop="dateModified" datetime="2022-01-17T09:38:39+08:00">2022-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Prometheus/" itemprop="url" rel="index"><span itemprop="name">Prometheus</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <!-- toc -->

<ul>
<li><a href="#prometheus-下载">Prometheus 下载</a><ul>
<li><a href="#下载">下载</a></li>
<li><a href="#配置">配置</a></li>
<li><a href="#存储">存储</a></li>
<li><a href="#启动">启动</a></li>
<li><a href="#问题">问题</a></li>
<li><a href="#配置监控目标node-exporter">配置监控目标—Node Exporter</a></li>
<li><a href="#可视化">可视化</a></li>
<li><a href="#告警">告警</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

<hr>
<h2><span id="prometheus-下载">Prometheus 下载</span></h2><h3><span id="下载">下载</span></h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;prometheus&#x2F;releases&#x2F;download&#x2F;v2.28.1&#x2F;prometheus-2.28.1.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;home&#x2F;lining</span><br><span class="line"></span><br><span class="line">-rw-r--r--.  1 root   root    71109475 Jul  1 07:25 prometheus-2.28.1.linux-amd64.tar.gz</span><br><span class="line">-rw-r--r--.  1 root   root    23629386 Jul  1 07:25 alertmanager-0.22.2.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tar -zxvf prometheus-2.28.1.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">cd &#x2F;home&#x2F;lining&#x2F;prometheus-2.28.1.linux-amd64</span><br><span class="line"></span><br><span class="line">drwxr-xr-x. 2 lining lining       38 Jul  2  2021 console_libraries</span><br><span class="line">drwxr-xr-x. 2 lining lining      173 Jul  2  2021 consoles</span><br><span class="line">-rw-r--r--. 1 lining lining    11357 Jul  2  2021 LICENSE</span><br><span class="line">-rw-r--r--. 1 lining lining     3646 Jul  2  2021 NOTICE</span><br><span class="line">-rwxr-xr-x. 1 lining lining 98503354 Jul  1  2021 prometheus</span><br><span class="line">-rw-r--r--. 1 lining lining      926 Jul  2  2021 prometheus.yml</span><br><span class="line">-rwxr-xr-x. 1 lining lining 87509137 Jul  1  2021 promtool</span><br></pre></td></tr></table></figure>



<h3><span id="配置">配置</span></h3><hr>
<p>vi prometheus.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#39;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label &#96;job&#x3D;&lt;job_name&gt;&#96; to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &#39;prometheus&#39;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &#39;&#x2F;metrics&#39;</span><br><span class="line">    # scheme defaults to &#39;http&#39;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#39;192.168.67.4:9090&#39;]</span><br></pre></td></tr></table></figure>



<p>Alerting rules</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: example</span><br><span class="line">  rules:</span><br><span class="line"></span><br><span class="line">  # Alert for any instance that is unreachable for &gt;5 minutes.</span><br><span class="line">  - alert: InstanceDown</span><br><span class="line">    expr: up &#x3D;&#x3D; 0</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; down&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125; of job &#123;&#123; $labels.job &#125;&#125; has been down for more than 5 minutes.&quot;</span><br><span class="line"></span><br><span class="line">  # Alert for any instance that has a median request latency &gt;1s.</span><br><span class="line">  - alert: APIHighRequestLatency</span><br><span class="line">    expr: api_http_request_latencies_second&#123;quantile&#x3D;&quot;0.5&quot;&#125; &gt; 1</span><br><span class="line">    for: 10m</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;High request latency on &#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125; has a median request latency above 1s (current value: &#123;&#123; $value &#125;&#125;s)&quot;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: example</span><br><span class="line">  rules:</span><br><span class="line">  - alert: HighRequestLatency</span><br><span class="line">    expr: job:request_latency_seconds:mean5m&#123;job&#x3D;&quot;myjob&quot;&#125; &gt; 0.5</span><br><span class="line">    for: 10m</span><br><span class="line">    labels:</span><br><span class="line">      severity: page</span><br><span class="line">    annotations:</span><br><span class="line">      summary: High request latency</span><br></pre></td></tr></table></figure>



















<h3><span id="存储">存储</span></h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">By default, Prometheus stores its database in .&#x2F;data (flag --storage.tsdb.path).</span><br></pre></td></tr></table></figure>



<h3><span id="启动">启动</span></h3><hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;prometheus --config.file&#x3D;prometheus.yml</span><br></pre></td></tr></table></figure>



<p>访问  <a href="http://192.168.67.4:9090/" target="_blank" rel="noopener">http://192.168.67.4:9090/</a></p>
<p><a href="http://192.168.67.4:9090/graph" target="_blank" rel="noopener">http://192.168.67.4:9090/graph</a></p>
<p>输入prometheus_target_interval_length_seconds指标（表示prometheus抓取的时间间隔）查询对应的度量值</p>
<p>或者使用表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">prometheus_target_interval_length_seconds&#123;quantile&#x3D;&quot;0.99&quot;&#125;</span><br><span class="line"></span><br><span class="line">count(prometheus_target_interval_length_seconds)</span><br><span class="line"></span><br><span class="line">rate(prometheus_tsdb_head_chunks_created_total[1m])</span><br></pre></td></tr></table></figure>





<p><a href="http://192.168.67.4:9090/metrics" target="_blank" rel="noopener">http://192.168.67.4:9090/metrics</a></p>
<h3><span id="问题">问题</span></h3><hr>
<p>服务器与客户端时间差问题</p>
<p>Error fetching server time: Detected 99408.81999993324 seconds time difference between your browser and the server. Prometheus relies on accurate time and time drift might cause unexpected query results.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -sf &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;Asia&#x2F;Shanghai &#x2F;etc&#x2F;localtime</span><br><span class="line">sudo hwclock -w</span><br><span class="line">date -s 2021-07-02</span><br><span class="line">date -s 17:55:55</span><br><span class="line">或者使用NTP同步</span><br><span class="line">ntpdate time3.aliyun.com</span><br></pre></td></tr></table></figure>



<h3><span id="配置监控目标node-exporter">配置监控目标—Node Exporter</span></h3><hr>
<p>下载</p>
<p><a href="https://github.com/prometheus/haproxy_exporter" target="_blank" rel="noopener">haproxy_exporter</a></p>
<p><a href="https://github.com/prometheus/memcached_exporter" target="_blank" rel="noopener">memcached_exporter</a></p>
<p><a href="https://github.com/prometheus/mysqld_exporter" target="_blank" rel="noopener">mysqld_exporter</a></p>
<p><a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noopener">node_exporter</a></p>
<p><a href="https://github.com/prometheus/graphite_exporter" target="_blank" rel="noopener">graphite_exporter</a></p>
<p><a href="https://github.com/prometheus/consul_exporter" target="_blank" rel="noopener">consul_exporter</a></p>
<p><a href="https://github.com/prometheus/blackbox_exporter" target="_blank" rel="noopener">blackbox_exporter</a></p>
<p><a href="https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz" target="_blank" rel="noopener">https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz</a></p>
<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">cd &#x2F;home&#x2F;lining&#x2F;node_exporter-1.1.2.linux-amd64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.&#x2F;node_exporter --web.listen-address 192.168.67.4:8080</span><br><span class="line">.&#x2F;node_exporter --web.listen-address 192.168.67.4:8081</span><br><span class="line">.&#x2F;node_exporter --web.listen-address 192.168.67.4:8082</span><br></pre></td></tr></table></figure>



<p>访问</p>
<p><a href="http://192.168.67.4:8080/metrics" target="_blank" rel="noopener">http://192.168.67.4:8080/metrics</a></p>
<p><a href="http://192.168.67.4:8081/metrics" target="_blank" rel="noopener">http://192.168.67.4:8081/metrics</a></p>
<p><a href="http://192.168.67.4:8082/metrics" target="_blank" rel="noopener">http://192.168.67.4:8082/metrics</a></p>
<p>curl -XGET <a href="http://192.168.67.4:8080/metrics" target="_blank" rel="noopener">http://192.168.67.4:8080/metrics</a> | grep -i node_cpu</p>
<p>Content-Type: text/plain; version=0.0.4; charset=utf-8</p>
<p>node_cpu_seconds_total{cpu=”0”,mode=”idle”} 9767.04<br>node_cpu_seconds_total{cpu=”0”,mode=”iowait”} 6.37<br>node_cpu_seconds_total{cpu=”0”,mode=”irq”} 0<br>node_cpu_seconds_total{cpu=”0”,mode=”nice”} 0.05<br>node_cpu_seconds_total{cpu=”0”,mode=”softirq”} 0.47<br>node_cpu_seconds_total{cpu=”0”,mode=”steal”} 0<br>node_cpu_seconds_total{cpu=”0”,mode=”system”} 22.67<br>node_cpu_seconds_total{cpu=”0”,mode=”user”} 24.64</p>
<p>node_cpu_guest_seconds_total{cpu=”0”,mode=”nice”} 0<br>node_cpu_guest_seconds_total{cpu=”0”,mode=”user”} 0</p>
<p>空闲CPU使用时间 = node_cpu_seconds_total{<strong>mode=“idle”</strong>}</p>
<p>CPU总共使用时间 = node_cpu_seconds_total</p>
<p>空闲CPU一分钟内的增量：<strong>increase</strong>(node_cpu_seconds_total{mode=“idle”}<strong>[1m]</strong>)</p>
<p>全部CPU一分钟内的增量：<strong>increase</strong>(node_cpu_seconds_total<strong>[1m]</strong>)</p>
<p>集群所有主机空闲CPU一分钟内的增量：<strong>sum</strong>(increase(node_cpu_seconds_total{mode=“idle”}[1m]))</p>
<p>集群所有主机CPU全部使用情况一分钟内的增量：<strong>sum</strong>(increase(node_cpu_seconds_total[1m]))</p>
<p>集群所有节点空闲CPU使用增量：sum(increase(node_cpu_seconds_total{mode=“idle”}[1m])) by(instance)</p>
<p>集群所有节点全部状态CPU使用增量：sum(increase(node_cpu_seconds_total[1m]))by(instance)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">100 - (avg by (instance) (irate(node_cpu&#123;instance&#x3D;&quot;xxx&quot;, mode&#x3D;&quot;idle&quot;&#125;[5m])) * 100)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">avg by (instance, mode) (irate(node_cpu&#123;instance&#x3D;&quot;xxx&quot;&#125;[5m])) * 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">node_load1&#123;instance&#x3D;&quot;xxx&quot;&#125; &#x2F;&#x2F; 1分钟负载</span><br><span class="line">node_load5&#123;instance&#x3D;&quot;xxx&quot;&#125; &#x2F;&#x2F; 5分钟负载</span><br><span class="line">node_load15&#123;instance&#x3D;&quot;xxx&quot;&#125; &#x2F;&#x2F; 15分钟负载</span><br><span class="line"></span><br><span class="line">100 - ((node_memory_MemFree&#123;instance&#x3D;&quot;xxx&quot;&#125;+node_memory_Cached&#123;instance&#x3D;&quot;xxx&quot;&#125;+node_memory_Buffers&#123;instance&#x3D;&quot;xxx&quot;&#125;)&#x2F;node_memory_MemTotal) * 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">100 - node_filesystem_free&#123;instance&#x3D;&quot;xxx&quot;,fstype!~&quot;rootfs|selinuxfs|autofs|rpc_pipefs|tmpfs|udev|none|devpts|sysfs|debugfs|fuse.*&quot;&#125; &#x2F; node_filesystem_size&#123;instance&#x3D;&quot;xxx&quot;,fstype!~&quot;rootfs|selinuxfs|autofs|rpc_pipefs|tmpfs|udev|none|devpts|sysfs|debugfs|fuse.*&quot;&#125; * 100</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 上线带宽</span><br><span class="line">sum by (instance) (irate(node_network_receive_bytes&#123;instance&#x3D;&quot;xxx&quot;device!~&quot;bond.*?|lo&quot;&#125;[5m])&#x2F;128)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 下行带宽</span><br><span class="line">sum by (instance) (irate(node_network_transmit_bytes&#123;instance&#x3D;&quot;xxx&quot;,device!~&quot;bond.*?|lo&quot;&#125;[5m])&#x2F;128)</span><br></pre></td></tr></table></figure>









<p>配置</p>
<p>使用规则文件</p>
<p>prometheus.rules.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: cpu-node</span><br><span class="line">  rules:</span><br><span class="line">  - record: job_instance_mode:node_cpu_seconds:avg_rate5m</span><br><span class="line">    expr: avg by (job, instance, mode) (rate(node_cpu_seconds_total[5m]))</span><br></pre></td></tr></table></figure>

<p>包含规则文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # By default, scrape targets every 15 seconds.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds.</span><br><span class="line"></span><br><span class="line">  # Attach these extra labels to all timeseries collected by this Prometheus instance.</span><br><span class="line">  external_labels:</span><br><span class="line">    monitor: &#39;codelab-monitor&#39;</span><br><span class="line"></span><br><span class="line">rule_files:</span><br><span class="line">  - &#39;prometheus.rules.yml&#39;</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#39;prometheus&#39;</span><br><span class="line"></span><br><span class="line">    # Override the global default and scrape targets from this job every 5 seconds.</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#39;192.168.67.4:9090&#39;]</span><br><span class="line"></span><br><span class="line">  - job_name:       &#39;node&#39;</span><br><span class="line"></span><br><span class="line">    # Override the global default and scrape targets from this job every 5 seconds.</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#39;192.168.67.4:8080&#39;, &#39;192.168.67.4:8081&#39;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &#39;production&#39;</span><br><span class="line"></span><br><span class="line">      - targets: [&#39;192.168.67.4:8082&#39;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &#39;canary&#39;</span><br></pre></td></tr></table></figure>



<p>测试</p>
<p>node_cpu_seconds_total</p>
<p>job_instance_mode:node_cpu_seconds:avg_rate5m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;idle&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;iowait&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;irq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;nice&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;softirq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;steal&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;system&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8080&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;user&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;idle&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;iowait&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;irq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;nice&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;softirq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;steal&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;system&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8081&quot;, job&#x3D;&quot;node&quot;, mode&#x3D;&quot;user&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;idle&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;iowait&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;irq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;nice&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;softirq&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;steal&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;system&quot;&#125;</span><br><span class="line">job_instance_mode:node_cpu_seconds:avg_rate5m&#123;instance&#x3D;&quot;192.168.67.4:8082&quot;, job&#x3D;&quot;prometheus&quot;, mode&#x3D;&quot;user&quot;&#125;</span><br></pre></td></tr></table></figure>



<h3><span id="可视化">可视化</span></h3><hr>
<p>下载</p>
<p><a href="https://grafana.com/grafana/download" target="_blank" rel="noopener">https://grafana.com/grafana/download</a></p>
<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;dl.grafana.com&#x2F;oss&#x2F;release&#x2F;grafana-8.0.4.linux-amd64.tar.gz</span><br><span class="line">tar -zxvf grafana-8.0.4.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">wget https:&#x2F;&#x2F;dl.grafana.com&#x2F;oss&#x2F;release&#x2F;grafana-8.0.4-1.x86_64.rpm</span><br><span class="line">sudo yum install grafana-8.0.4-1.x86_64.rpm</span><br></pre></td></tr></table></figure>



<p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;home&#x2F;lining&#x2F;grafana-8.0.4</span><br><span class="line"></span><br><span class="line">bin&#x2F;grafana-server</span><br></pre></td></tr></table></figure>

<p>访问<a href="http://192.168.67.4:3000" target="_blank" rel="noopener">http://192.168.67.4:3000</a>  admin/admin</p>
<p>修改密码：    DataFusion@2019</p>
<p><a href="https://grafana.com/docs/grafana/latest/datasources/?pg=graf-resources&amp;plcmt=add-a-data-source" target="_blank" rel="noopener">https://grafana.com/docs/grafana/latest/datasources/?pg=graf-resources&amp;plcmt=add-a-data-source</a></p>
<p>配置数据源</p>
<ol>
<li>Click on the “cogwheel” in the sidebar to open the Configuration menu.</li>
<li>Click on “Data Sources”.</li>
<li>Click on “Add data source”.</li>
<li>Select “Prometheus” as the type.</li>
<li>Set the appropriate Prometheus server URL (for example, <code>http://localhost:9090/</code>)</li>
<li>Adjust other data source settings as desired (for example, choosing the right Access method).</li>
<li>Click “Save &amp; Test” to save the new data source.</li>
</ol>
<p>Configuration - Data Sources - Add data source - Prometheus - <a href="http://192.168.67.4:9090" target="_blank" rel="noopener">http://192.168.67.4:9090</a> - Save &amp; Test</p>
<p>创建图表</p>
<ol>
<li>Click the graph title, then click “Edit”.</li>
<li>Under the “Metrics” tab, select your Prometheus data source (bottom right).</li>
<li>Enter any Prometheus expression into the “Query” field, while using the “Metric” field to lookup metrics via autocompletion.</li>
<li>To format the legend names of time series, use the “Legend format” input. For example, to show only the <code>method</code> and <code>status</code> labels of a returned query result, separated by a dash, you could use the legend format string <code> - </code>.</li>
<li>Tune other graph settings until you have a working graph.</li>
</ol>
<p>Add DashBoard - Add empty panel - ProQL Query - node_cpu_seconds_total</p>
<p>预定义图表</p>
<p>Add panel from the panel library</p>
<p>Example Prometheus 2.0 stats</p>
<p>可以编辑图标学习配置</p>
<p>Memory Profile</p>
<p>sum(process_resident_memory_bytes{job=”prometheus”})   该指标对应线条的标识 p8s process resident mem</p>
<p>process_virtual_memory_bytes{job=”prometheus”}</p>
<h3><span id="告警">告警</span></h3><hr>
<p>The <a href="https://github.com/prometheus/alertmanager" target="_blank" rel="noopener">Alertmanager</a> handles alerts sent by client applications such as the Prometheus server. It takes care of deduplicating, grouping, and routing them to the correct receiver integration such as email, PagerDuty, or OpsGenie. It also takes care of silencing and inhibition of alerts.</p>
<p>Alerting rules in Prometheus servers send alerts to an Alertmanager. The <a href="https://prometheus.io/docs/alerting/latest/alertmanager/" target="_blank" rel="noopener">Alertmanager</a> then manages those alerts</p>
<ul>
<li>Setup and <a href="https://prometheus.io/docs/alerting/latest/configuration/" target="_blank" rel="noopener">configure</a> the Alertmanager</li>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alertmanager_config" target="_blank" rel="noopener">Configure Prometheus</a> to talk to the Alertmanager</li>
<li>Create <a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" target="_blank" rel="noopener">alerting rules</a> in Prometheus</li>
</ul>
<p>下载</p>
<p><a href="https://github.com/prometheus/alertmanager" target="_blank" rel="noopener">alertmanager</a></p>
<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf alertmanager-0.22.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>



<p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;alertmanager --config.file&#x3D;alertmanager.yml</span><br></pre></td></tr></table></figure>





<p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  # The default SMTP From header field.</span><br><span class="line">  [ smtp_from: &lt;tmpl_string&gt; ]</span><br><span class="line">  # The default SMTP smarthost used for sending emails, including port number.</span><br><span class="line">  # Port number usually is 25, or 587 for SMTP over TLS (sometimes referred to as STARTTLS).</span><br><span class="line">  # Example: smtp.example.org:587</span><br><span class="line">  [ smtp_smarthost: &lt;string&gt; ]</span><br><span class="line">  # The default hostname to identify to the SMTP server.</span><br><span class="line">  [ smtp_hello: &lt;string&gt; | default &#x3D; &quot;localhost&quot; ]</span><br><span class="line">  # SMTP Auth using CRAM-MD5, LOGIN and PLAIN. If empty, Alertmanager doesn&#39;t authenticate to the SMTP server.</span><br><span class="line">  [ smtp_auth_username: &lt;string&gt; ]</span><br><span class="line">  # SMTP Auth using LOGIN and PLAIN.</span><br><span class="line">  [ smtp_auth_password: &lt;secret&gt; ]</span><br><span class="line">  # SMTP Auth using PLAIN.</span><br><span class="line">  [ smtp_auth_identity: &lt;string&gt; ]</span><br><span class="line">  # SMTP Auth using CRAM-MD5.</span><br><span class="line">  [ smtp_auth_secret: &lt;secret&gt; ]</span><br><span class="line">  # The default SMTP TLS requirement.</span><br><span class="line">  # Note that Go does not support unencrypted connections to remote SMTP endpoints.</span><br><span class="line">  [ smtp_require_tls: &lt;bool&gt; | default &#x3D; true ]</span><br><span class="line"></span><br><span class="line">  # The API URL to use for Slack notifications.</span><br><span class="line">  [ slack_api_url: &lt;secret&gt; ]</span><br><span class="line">  [ slack_api_url_file: &lt;filepath&gt; ]</span><br><span class="line">  [ victorops_api_key: &lt;secret&gt; ]</span><br><span class="line">  [ victorops_api_url: &lt;string&gt; | default &#x3D; &quot;https:&#x2F;&#x2F;alert.victorops.com&#x2F;integrations&#x2F;generic&#x2F;20131114&#x2F;alert&#x2F;&quot; ]</span><br><span class="line">  [ pagerduty_url: &lt;string&gt; | default &#x3D; &quot;https:&#x2F;&#x2F;events.pagerduty.com&#x2F;v2&#x2F;enqueue&quot; ]</span><br><span class="line">  [ opsgenie_api_key: &lt;secret&gt; ]</span><br><span class="line">  [ opsgenie_api_url: &lt;string&gt; | default &#x3D; &quot;https:&#x2F;&#x2F;api.opsgenie.com&#x2F;&quot; ]</span><br><span class="line">  [ wechat_api_url: &lt;string&gt; | default &#x3D; &quot;https:&#x2F;&#x2F;qyapi.weixin.qq.com&#x2F;cgi-bin&#x2F;&quot; ]</span><br><span class="line">  [ wechat_api_secret: &lt;secret&gt; ]</span><br><span class="line">  [ wechat_api_corp_id: &lt;string&gt; ]</span><br><span class="line"></span><br><span class="line">  # The default HTTP client configuration</span><br><span class="line">  [ http_config: &lt;http_config&gt; ]</span><br><span class="line"></span><br><span class="line">  # ResolveTimeout is the default value used by alertmanager if the alert does</span><br><span class="line">  # not include EndsAt, after this time passes it can declare the alert as resolved if it has not been updated.</span><br><span class="line">  # This has no impact on alerts from Prometheus, as they always include EndsAt.</span><br><span class="line">  [ resolve_timeout: &lt;duration&gt; | default &#x3D; 5m ]</span><br><span class="line"></span><br><span class="line"># Files from which custom notification template definitions are read.</span><br><span class="line"># The last component may use a wildcard matcher, e.g. &#39;templates&#x2F;*.tmpl&#39;.</span><br><span class="line">templates:</span><br><span class="line">  [ - &lt;filepath&gt; ... ]</span><br><span class="line"></span><br><span class="line"># The root node of the routing tree.</span><br><span class="line">route: &lt;route&gt;</span><br><span class="line"></span><br><span class="line"># A list of notification receivers.</span><br><span class="line">receivers:</span><br><span class="line">  - &lt;receiver&gt; ...</span><br><span class="line"></span><br><span class="line"># A list of inhibition rules.</span><br><span class="line">inhibit_rules:</span><br><span class="line">  [ - &lt;inhibit_rule&gt; ... ]</span><br><span class="line"></span><br><span class="line"># A list of mute time intervals for muting routes.</span><br><span class="line">mute_time_intervals:</span><br><span class="line">  [ - &lt;mute_time_interval&gt; ... ]</span><br></pre></td></tr></table></figure>



<p>Prometheus creates and sends alerts to the Alertmanager which then sends notifications out to different receivers based on their labels. A receiver can be one of many integrations including: Slack, PagerDuty, email, or a custom integration via the generic webhook interface.</p>
<p>Prometheus服务器根据报警规则将警报发送给Alertmanager，然后Alertmanager将静默（silencing）、抑制（inhibition）、分组聚合（aggregation）等消息通过Email、钉钉等发送通知。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line">  smtp_smarthost: &#39;smtp.163.com:25&#39;</span><br><span class="line">  smtp_from: &#39;liningwonder@163.com&#39;</span><br><span class="line">  smtp_auth_username: &#39;liningwonder@163.com&#39;</span><br><span class="line">  smtp_auth_password: &#39;VNYEAZYHEBQGGRNA&#39;</span><br><span class="line">  smtp_require_tls: false</span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  group_by: [&#39;alertname&#39;] &#x2F;&#x2F;与配置的规则一致</span><br><span class="line">  group_wait: 30s</span><br><span class="line">  group_interval: 5m</span><br><span class="line">  repeat_interval: 1h</span><br><span class="line">  receiver: email-receiver</span><br><span class="line">receivers:</span><br><span class="line">- name: &#39;email-receiver&#39;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &#39;lining@unionpaysmart.com&#39;</span><br><span class="line">    send_resolved: true</span><br><span class="line"></span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: &#39;critical&#39;</span><br><span class="line">    target_match:</span><br><span class="line">      severity: &#39;warning&#39;</span><br><span class="line">    equal: [&#39;alertname&#39;, &#39;dev&#39;, &#39;instance&#39;]</span><br></pre></td></tr></table></figure>



<p>配置rules</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets: [&quot;192.168.67.4:9093&quot;]</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span><br><span class="line">rule_files:</span><br><span class="line">    - &#39;prometheus.rules.yml&#39;</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#39;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label &#96;job&#x3D;&lt;job_name&gt;&#96; to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &#39;prometheus&#39;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &#39;&#x2F;metrics&#39;</span><br><span class="line">    # scheme defaults to &#39;http&#39;.</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">     - targets: [&#39;192.168.67.4:9090&#39;]</span><br><span class="line"></span><br><span class="line">  - job_name:       &#39;node&#39;</span><br><span class="line"></span><br><span class="line">    # Override the global default and scrape targets from this job every 5 seconds.</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line"></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#39;192.168.67.4:8080&#39;, &#39;192.168.67.4:8081&#39;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &#39;production&#39;</span><br><span class="line"></span><br><span class="line">      - targets: [&#39;192.168.67.3:8082&#39;]</span><br><span class="line">        labels:</span><br><span class="line">          group: &#39;canary&#39;</span><br></pre></td></tr></table></figure>



<p>prometheus.rules.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: cpu-node</span><br><span class="line">  rules:</span><br><span class="line">  - record: job_instance_mode:node_cpu_seconds:avg_rate5m</span><br><span class="line">    expr: avg by (job, instance, mode) (rate(node_cpu_seconds_total[5m]))</span><br><span class="line">- name: alertname</span><br><span class="line">  rules:</span><br><span class="line">  - alert: NodeCpuUsage</span><br><span class="line">    expr: (rate(node_cpu_seconds_total[5m]))) &gt; 1</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      service_name: test</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      description: &quot;&#123;&#123;$labels.instance&#125;&#125;: CPU usage is above 99% (current value is: &#123;&#123; $value &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>





<p>待测试</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Prometheus/" rel="tag"># Prometheus</a>
              <a href="/tags/Grafana/" rel="tag"># Grafana</a>
              <a href="/tags/Alertmanager/" rel="tag"># Alertmanager</a>
              <a href="/tags/Node-Expoter/" rel="tag"># Node Expoter</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/25/redmine/" rel="prev" title="Redmine项目管理工具">
      <i class="fa fa-chevron-left"></i> Redmine项目管理工具
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/07/06/%E4%BB%8EJNI%E5%88%B0JNI-FUSE/" rel="next" title="从JNI到JNI-FUSE">
      从JNI到JNI-FUSE <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#"><span class="nav-number">1.</span> <span class="nav-text">Prometheus 下载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">1.1.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">1.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">1.3.</span> <span class="nav-text">存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">1.4.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">1.5.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">1.6.</span> <span class="nav-text">配置监控目标—Node Exporter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">1.7.</span> <span class="nav-text">可视化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">1.8.</span> <span class="nav-text">告警</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">李宁</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李宁</span>
</div>
  <div class="powered-by">万物之始，大道至简
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">知易行难，悟在天成
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
